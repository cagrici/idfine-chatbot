<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ID Fine Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0f2f5;
        }

        .app {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: #231f20;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .sidebar .logo {
            padding: 20px;
            font-size: 18px;
            font-weight: 700;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar nav {
            flex: 1;
            padding: 12px 0;
            display: flex;
            flex-direction: column;
        }

        .sidebar nav a {
            display: block;
            padding: 10px 20px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar nav a:hover,
        .sidebar nav a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar nav a.nav-hidden {
            display: none;
        }

        .sidebar .user-info {
            padding: 16px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        .sidebar .user-role-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-top: 4px;
        }

        /* Main */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .topbar {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .topbar h2 {
            font-size: 18px;
            color: #1a202c;
        }

        .topbar .status-badge {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            background: #c6f6d5;
            color: #276749;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        /* Login */
        .login-container {
            max-width: 400px;
            margin: 80px auto;
            background: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .login-container h2 {
            text-align: center;
            margin-bottom: 24px;
            color: #231f20;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 13px;
            color: #4a5568;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #231f20;
            box-shadow: 0 0 0 2px rgba(26, 54, 93, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #231f20;
            color: white;
        }

        .btn-primary:hover {
            background: #2a4a7f;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .btn-success {
            background: #38a169;
            color: white;
        }

        .btn-success:hover {
            background: #2f855a;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-full {
            width: 100%;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #e2e8f0;
            color: #4a5568;
        }

        .btn-outline:hover {
            background: #f7fafc;
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        .stat-card .label {
            font-size: 12px;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #1a202c;
            margin-top: 4px;
        }

        /* Tables */
        .doc-table {
            width: 100%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        .doc-table th,
        .doc-table td {
            padding: 12px 16px;
            text-align: left;
            font-size: 13px;
        }

        .doc-table th {
            background: #f7fafc;
            color: #4a5568;
            font-weight: 600;
            border-bottom: 1px solid #e2e8f0;
        }

        .doc-table td {
            border-bottom: 1px solid #f0f2f5;
        }

        .doc-table tr:last-child td {
            border-bottom: none;
        }

        .doc-table tr:hover td {
            background: #f7fafc;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-green {
            background: #c6f6d5;
            color: #276749;
        }

        .badge-yellow {
            background: #fefcbf;
            color: #975a16;
        }

        .badge-red {
            background: #fed7d7;
            color: #9b2c2c;
        }

        .badge-blue {
            background: #bee3f8;
            color: #2a4365;
        }

        .badge-gray {
            background: #e2e8f0;
            color: #4a5568;
        }

        .badge-admin {
            background: #e53e3e;
            color: white;
        }

        .badge-manager {
            background: #dd6b20;
            color: white;
        }

        .badge-agent {
            background: #3182ce;
            color: white;
        }

        .badge-viewer {
            background: #a0aec0;
            color: white;
        }

        /* Upload */
        .upload-area {
            background: white;
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            margin-bottom: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: #231f20;
            background: #f7fafc;
        }

        .upload-area.dragover {
            border-color: #231f20;
            background: #ebf8ff;
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-area h3 {
            color: #4a5568;
            margin-bottom: 8px;
        }

        .upload-area p {
            color: #a0aec0;
            font-size: 13px;
        }

        /* Chat panel */
        .chat-panel {
            display: flex;
            height: 100%;
            gap: 16px;
        }

        .chat-list {
            width: 300px;
            background: white;
            border-radius: 8px;
            overflow-y: auto;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        .chat-list-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f2f5;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chat-list-item:hover {
            background: #f7fafc;
        }

        .chat-list-item.active {
            background: #ebf8ff;
            border-left: 3px solid #231f20;
        }

        .chat-list-item .visitor {
            font-size: 13px;
            font-weight: 500;
            color: #1a202c;
        }

        .chat-list-item .preview {
            font-size: 12px;
            color: #a0aec0;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-list-item .time {
            font-size: 11px;
            color: #cbd5e0;
            float: right;
        }

        .chat-detail {
            flex: 1;
            background: white;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        .chat-detail .messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .chat-detail .msg-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
        }

        .chat-detail .msg-row.user {
            justify-content: flex-end;
        }

        .chat-detail .msg-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 2px;
            object-fit: contain;
            background: white;
            padding: 2px;
        }

        .chat-detail .message {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.5;
        }

        .chat-detail .message.user {
            background: #231f20;
            color: white;
            border-bottom-right-radius: 2px;
            white-space: pre-wrap;
        }

        .chat-detail .message.assistant {
            background: #f0f2f5;
            color: #1a202c;
            border-bottom-left-radius: 2px;
        }

        .chat-detail .message.assistant h3,
        .chat-detail .message.assistant h4 {
            font-size: 13px;
            font-weight: 600;
            margin: 6px 0 3px;
        }

        .chat-detail .message.assistant h3:first-child,
        .chat-detail .message.assistant h4:first-child {
            margin-top: 0;
        }

        .chat-detail .message.assistant strong {
            font-weight: 600;
        }

        .chat-detail .message.assistant em {
            font-style: italic;
        }

        .chat-detail .message.assistant ul,
        .chat-detail .message.assistant ol {
            margin: 3px 0 3px 16px;
            padding: 0;
        }

        .chat-detail .message.assistant li {
            margin-bottom: 1px;
        }

        .chat-detail .message.assistant p {
            margin: 3px 0;
        }

        .chat-detail .message.assistant p:first-child {
            margin-top: 0;
        }

        .chat-detail .message.assistant p:last-child {
            margin-bottom: 0;
        }

        .message.assistant.streaming {
            white-space: pre-wrap;
        }

        .chat-detail .empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #a0aec0;
        }

        .progress-bar {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-bar .fill {
            height: 100%;
            background: #231f20;
            transition: width 0.3s;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .alert-success {
            background: #c6f6d5;
            color: #276749;
        }

        .alert-error {
            background: #fed7d7;
            color: #9b2c2c;
        }

        .hidden {
            display: none !important;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.15s ease;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 480px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            animation: slideUp 0.2s ease;
        }

        .modal h3 {
            margin-bottom: 16px;
            color: #231f20;
            font-size: 16px;
        }

        .modal .form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }

            to {
                opacity: 1
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0
            }

            to {
                transform: translateY(0);
                opacity: 1
            }
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
            flex-wrap: wrap;
        }

        .toolbar .search-box {
            flex: 1;
            min-width: 200px;
            max-width: 300px;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
        }

        .toolbar .search-box:focus {
            outline: none;
            border-color: #231f20;
        }

        .toolbar .filters {
            display: flex;
            gap: 8px;
        }

        .toolbar .filters select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
        }

        /* Section header */
        .section-header {
            font-size: 15px;
            font-weight: 600;
            color: #231f20;
            margin-bottom: 12px;
            margin-top: 24px;
        }

        .section-header:first-child {
            margin-top: 0;
        }

        /* Action buttons in table */
        .action-btns {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        /* Profile page */
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        @media (max-width: 900px) {
            .profile-grid {
                grid-template-columns: 1fr;
            }
        }

        .profile-card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        .profile-card h3 {
            font-size: 15px;
            font-weight: 600;
            color: #231f20;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f2f5;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .profile-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .profile-info-row .label {
            font-size: 13px;
            color: #718096;
        }

        .profile-info-row .value {
            font-size: 14px;
            color: #1a202c;
            font-weight: 500;
        }

        .profile-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: #231f20;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 600;
            margin: 0 auto 16px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
</head>

<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <img src="/images/logo-dark.png" alt="ID Fine"
            style="display:block;max-width:180px;height:auto;margin:0 auto 16px">

        <div class="form-group">
            <label>E-posta</label>
            <input type="email" id="loginEmail" value="">
        </div>
        <div class="form-group">
            <label>Parola</label>
            <input type="password" id="loginPassword" value="">
        </div>
        <div id="loginError" class="alert alert-error hidden"></div>
        <button class="btn btn-primary btn-full" onclick="login()">Giri≈ü Yap</button>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="app hidden">
        <div class="sidebar">
            <div class="logo"><img src="/images/logo-light.png" alt="ID Fine Admin"
                    style="max-width:100%;height:32px;object-fit:contain"></div>
            <nav>
                <a class="active" onclick="showPage('dashboard')" data-page="dashboard">Dashboard</a>
                <a onclick="showPage('documents')" data-page="documents">Kaynaklar</a>
                <a onclick="showPage('products')" data-page="products">√úr√ºnler</a>
                <a onclick="showPage('users')" data-page="users">Kullanƒ±cƒ±lar</a>
                <a onclick="showPage('conversations')" data-page="conversations">Sohbetler</a>
                <a onclick="showPage('live-support')" data-page="live-support">Canli Destek</a>
                <a onclick="showPage('canned-responses')" data-page="canned-responses">Hazir Yanitlar</a>
                <a onclick="showPage('reports')" data-page="reports">Raporlar</a>
                <a onclick="showPage('widget')" data-page="widget">Widget Kodu</a>
                <a onclick="showPage('profile')" data-page="profile"
                    style="border-top:1px solid rgba(255,255,255,0.1);margin-top:auto">Profilim</a>
            </nav>
            <div class="user-info" id="userInfo" onclick="showPage('profile')" style="cursor:pointer"
                title="Profili G√∂r√ºnt√ºle">
                <div id="userInfoName">admin@idfine.com</div>
                <div id="userInfoRole" class="user-role-badge badge-admin">Admin</div>
            </div>
            <div style="padding:8px 16px;border-top:1px solid rgba(255,255,255,0.1)">
                <select id="agentStatusSelect" onchange="updateAgentStatus(this.value)"
                    style="width:100%;padding:5px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:#fff;font-size:12px;cursor:pointer">
                    <option value="online" style="color:#000">&#x1F7E2; Cevrimici</option>
                    <option value="busy" style="color:#000">&#x1F534; Mesgul</option>
                    <option value="away" style="color:#000">&#x1F7E1; Uzakta</option>
                    <option value="offline" selected style="color:#000">&#x26AB; Cevrimdisi</option>
                </select>
            </div>
        </div>
        <div class="main">
            <div class="topbar">
                <h2 id="pageTitle">Dashboard</h2>
                <div style="display:flex;align-items:center;gap:12px">
                    <span class="status-badge">Sistem Aktif</span>
                       <a onclick="showPage('chat')" data-page="chat">Chat</a>
                    <button class="btn btn-sm btn-outline" onclick="logout()">√áƒ±kƒ±≈ü</button>
                </div>
            </div>
            <div class="content" id="pageContent"></div>
        </div>
    </div>

    <!-- Modal Container (global) -->
    <div id="globalModal"></div>

    <script>
        const API = location.protocol + '//' + location.host;
        let token = null;
        let currentUser = null;
        let userPermissions = [];

        // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            errorEl.classList.add('hidden');

            try {
                const resp = await fetch(`${API}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    errorEl.textContent = err.detail || 'Giri≈ü ba≈üarƒ±sƒ±z. E-posta veya parola yanlƒ±≈ü.';
                    errorEl.classList.remove('hidden');
                    return;
                }
                const data = await resp.json();
                token = data.access_token;

                // Fetch full user info with permissions
                await fetchCurrentUser();

                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                updateSidebarUser();
                updateNavVisibility();
                showPage('dashboard');
            } catch (e) {
                errorEl.textContent = 'Baƒülantƒ± hatasƒ±:' + e.message;
                errorEl.classList.remove('hidden');
            }
        }

        async function fetchCurrentUser() {
            try {
                const resp = await fetch(`${API}/api/auth/me`, { headers: authHeaders() });
                if (resp.ok) {
                    currentUser = await resp.json();
                    userPermissions = currentUser.permissions || [];
                }
            } catch (e) {
                console.error('fetchCurrentUser error:', e);
            }
        }

        function logout() {
            updateAgentStatus('offline');
            token = null;
            currentUser = null;
            userPermissions = [];
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('loginPassword').value = '';
        }

        function authHeaders() {
            return { 'Authorization': `Bearer ${token}` };
        }

        function hasPerm(perm) {
            return userPermissions.includes('admin.full_access') || userPermissions.includes(perm);
        }

        function updateSidebarUser() {
            if (!currentUser) return;
            document.getElementById('userInfoName').textContent = currentUser.full_name || currentUser.email;
            const roleEl = document.getElementById('userInfoRole');
            roleEl.textContent = ROLE_LABELS[currentUser.role] || currentUser.role;
            roleEl.className = 'user-role-badge badge-' + currentUser.role;
            // Set agent status dropdown
            const statusSelect = document.getElementById('agentStatusSelect');
            if (statusSelect && currentUser.agent_status) {
                statusSelect.value = currentUser.agent_status;
            }
        }

        async function updateAgentStatus(status) {
            try {
                const resp = await fetch(`${API}/api/auth/me/status`, {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                if (resp.ok) {
                    if (currentUser) currentUser.agent_status = status;
                    console.log('Agent status updated to:', status);
                }
            } catch (e) { console.error('Status update error:', e); }
        }

        function updateNavVisibility() {
            const navItems = {
                'documents': 'documents.view',
                'products': 'documents.view',
                'users': 'users.view',
                'conversations': 'conversations.view',
                'live-support': 'conversations.respond',
                'canned-responses': 'conversations.respond',
                'reports': 'stats.view',
                'chat': 'conversations.respond',
                'widget': 'documents.view',
            };
            for (const [page, perm] of Object.entries(navItems)) {
                const link = document.querySelector(`[data-page="${page}"]`);
                if (link) {
                    if (hasPerm(perm)) {
                        link.classList.remove('nav-hidden');
                    } else {
                        link.classList.add('nav-hidden');
                    }
                }
            }
        }

        // ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const ROLE_LABELS = {
            admin: 'Admin',
            manager: 'Y√∂netici',
            agent: 'Temsilci',
            viewer: 'ƒ∞zleyici'
        };

        const ROLE_BADGE_CLASS = {
            admin: 'badge-admin',
            manager: 'badge-manager',
            agent: 'badge-agent',
            viewer: 'badge-viewer'
        };

        const ACTION_LABELS = {
            'user.create': 'Kullanƒ±cƒ± olu≈üturdu',
            'user.update': 'Kullanƒ±cƒ± g√ºncelledi',
            'user.change_role': 'Rol deƒüi≈ütirdi',
            'user.reset_password': 'Parola sƒ±fƒ±rladƒ±',
            'user.toggle_active': 'Durum deƒüi≈ütirdi',
        };

        // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function escHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function showAlert(containerId, type, message) {
            const el = document.getElementById(containerId);
            if (!el) return;
            el.innerHTML = `<div class="alert alert-${type === 'success' ? 'success' : 'error'}">${escHtml(message)}</div>`;
            setTimeout(() => { if (el) el.innerHTML = ''; }, 5000);
        }

        function closeModal() {
            document.getElementById('globalModal').innerHTML = '';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        // ‚îÄ‚îÄ Pages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function showPage(page) {
            document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
            const link = document.querySelector(`[data-page="${page}"]`);
            if (link) link.classList.add('active');
            document.getElementById('pageTitle').textContent = {
                dashboard: 'Dashboard', documents: 'Kaynak Y√∂netimi',
                products: '√úr√ºn Y√∂netimi',
                widget: 'Widget Kod Olu≈üturucu',
                users: 'Kullanƒ±cƒ± Y√∂netimi',
                conversations: 'Sohbetler', 'live-support': 'Canli Destek', 'canned-responses': 'Hazir Yanitlar',
                reports: 'Raporlar', chat: 'Canli Chat Test', profile: 'Profilim'
            }[page];

            const content = document.getElementById('pageContent');
            if (page === 'dashboard') await renderDashboard(content);
            else if (page === 'documents') await renderDocuments(content);
            else if (page === 'products') await renderProducts(content);
            else if (page === 'widget') await renderWidgetPage(content);
            else if (page === 'users') await renderUsers(content);
            else if (page === 'conversations') await renderConversations(content);
            else if (page === 'live-support') await renderLiveSupport(content);
            else if (page === 'canned-responses') await renderCannedResponses(content);
            else if (page === 'reports') await renderReports(content);
            else if (page === 'chat') renderChat(content);
            else if (page === 'profile') await renderProfile(content);
        }

        // ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function renderDashboard(el) {
            try {
                const resp = await fetch(`${API}/api/admin/stats`, { headers: authHeaders() });
                const stats = await resp.json();
                el.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card"><div class="label">Toplam Sohbet</div><div class="value">${stats.total_conversations}</div></div>
                        <div class="stat-card"><div class="label">Aktif Sohbet</div><div class="value">${stats.active_conversations}</div></div>
                        <div class="stat-card"><div class="label">Toplam Mesaj</div><div class="value">${stats.total_messages}</div></div>
                        <div class="stat-card"><div class="label">Y√ºkl√º Dok√ºman</div><div class="value">${stats.total_documents}</div></div>
                        <div class="stat-card"><div class="label">Kullanƒ±cƒ±lar</div><div class="value">${stats.total_users}</div></div>
                    </div>
                    <div style="background:white;padding:24px;border-radius:8px;color:#718096;text-align:center">
                        <p>Sistem aktif ve √ßalƒ±≈üƒ±yor. Dok√ºman y√ºklemek i√ßin <b>Kaynaklar</b> sayfasƒ±nƒ± ziyaret edin.</p>
                    </div>`;
            } catch (e) { el.innerHTML = `<div class="alert alert-error">Veri y√ºklenemedi: ${e.message}</div>`; }
        }

        // ‚îÄ‚îÄ Source Groups & Documents (Kaynaklar) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        let sourceGroups = [];
        let selectedSourceGroupId = null;

        async function loadSourceGroups() {
            try {
                const resp = await fetch(`${API}/api/admin/source-groups`, { headers: authHeaders() });
                const data = await resp.json();
                sourceGroups = data.groups || [];
            } catch (e) { console.error('Source groups load error:', e); sourceGroups = []; }
        }

        function renderSourceGroupCards() {
            const container = document.getElementById('sgCards');
            if (!container) return;
            const permIcons = (p) => {
                let icons = '';
                if (p.rag_enabled) icons += '<span title="Dok√ºman Arama" style="font-size:16px">üìÑ</span>';
                if (p.product_db_enabled) icons += '<span title="√úr√ºn Veritabanƒ±" style="font-size:16px">üè≠</span>';
                if (p.odoo_enabled) icons += '<span title="Odoo ERP" style="font-size:16px">üîó</span>';
                return icons || '<span style="color:#aaa">-</span>';
            };
            container.innerHTML = `
                <div style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:10px 16px;border-radius:8px;border:2px solid ${!selectedSourceGroupId ? '#231f20' : '#e2e8f0'};background:${!selectedSourceGroupId ? '#f7f7f7' : '#fff'}" onclick="selectedSourceGroupId=null;renderSourceGroupCards();loadDocuments()">
                    <span style="font-weight:600;font-size:14px">T√ºm√º</span>
                </div>
                ${sourceGroups.map(sg => `
                    <div style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:10px 16px;border-radius:8px;border:2px solid ${selectedSourceGroupId === sg.id ? '#231f20' : '#e2e8f0'};background:${selectedSourceGroupId === sg.id ? '#f7f7f7' : '#fff'};min-width:180px" onclick="selectedSourceGroupId='${sg.id}';renderSourceGroupCards();loadDocuments()">
                        <div style="width:10px;height:10px;border-radius:50%;background:${sg.color};flex-shrink:0"></div>
                        <div style="flex:1;min-width:0">
                            <div style="font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escHtml(sg.name)}</div>
                            <div style="font-size:11px;color:#718096">${sg.document_count} dok√ºman ¬∑ ${sg.widget_count} widget</div>
                        </div>
                        <div style="display:flex;gap:2px">${permIcons(sg.data_permissions || {})}</div>
                        ${hasPerm('source_groups.edit') ? `<button class="btn btn-sm" onclick="event.stopPropagation();editSourceGroup('${sg.id}')" style="padding:2px 8px;font-size:11px">D√ºzenle</button>` : ''}
                    </div>
                `).join('')}
                ${hasPerm('source_groups.create') ? `
                <div style="display:flex;align-items:center;justify-content:center;cursor:pointer;padding:10px 16px;border-radius:8px;border:2px dashed #cbd5e0;min-width:120px;color:#718096" onclick="showSourceGroupModal()">
                    <span style="font-size:20px;margin-right:6px">+</span> Yeni Grup
                </div>` : ''}
            `;
        }

        async function renderDocuments(el) {
            await loadSourceGroups();
            el.innerHTML = `
                <div id="docAlert"></div>
                <div style="margin-bottom:20px">
                    <h3 style="font-size:15px;margin-bottom:10px;color:#4a5568">Kaynak Gruplarƒ±</h3>
                    <div id="sgCards" style="display:flex;gap:12px;flex-wrap:wrap"></div>
                </div>
                ${hasPerm('documents.upload') ? `
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".pdf,.docx,.doc,.txt" onchange="uploadFile(this.files[0])">
                    <h3>Dok√ºman Y√ºkle</h3>
                    <p>PDF, Word veya Text dosyasƒ± s√ºr√ºkleyip bƒ±rakƒ±n veya tƒ±klayƒ±p se√ßin</p>
                    <div style="display:flex;gap:8px;margin-top:12px;max-width:400px;margin-left:auto;margin-right:auto">
                        <div class="form-group" style="flex:1" onclick="event.stopPropagation()">
                            <label style="font-size:11px;font-weight:600;display:block;margin-bottom:2px">Kaynak Grubu</label>
                            <select id="docSourceGroup">
                                ${sourceGroups.map(sg => `<option value="${sg.id}" ${sg.is_default ? 'selected' : ''}>${escHtml(sg.name)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group" style="flex:1" onclick="event.stopPropagation()">
                            <label style="font-size:11px;font-weight:600;display:block;margin-bottom:2px">Kategori</label>
                            <select id="docCategory">
                                <option value="genel">Genel</option>
                                <option value="urunler">√úr√ºnler</option>
                                <option value="katalog">Katalog</option>
                                <option value="teknik">Teknik</option>
                            </select>
                        </div>
                    </div>
                    <div id="uploadProgress" class="hidden" style="margin-top:12px">
                        <div class="progress-bar"><div class="fill" id="progressFill" style="width:0%"></div></div>
                        <p style="margin-top:4px;font-size:12px" id="uploadStatus">Y√ºkleniyor...</p>
                    </div>
                </div>` : ''}
                <table class="doc-table">
                    <thead><tr><th>Dosya Adƒ±</th><th>Tip</th><th>Kaynak Grubu</th><th>Kategori</th><th>Durum</th><th>Par√ßalar</th><th>Tarih</th>${hasPerm('documents.delete') ? '<th></th>' : ''}</tr></thead>
                    <tbody id="docList"><tr><td colspan="8" style="text-align:center;color:#a0aec0">Y√ºkleniyor...</td></tr></tbody>
                </table>`;

            renderSourceGroupCards();

            if (hasPerm('documents.upload')) {
                const area = document.getElementById('uploadArea');
                area.addEventListener('dragover', e => { e.preventDefault(); area.classList.add('dragover'); });
                area.addEventListener('dragleave', () => area.classList.remove('dragover'));
                area.addEventListener('drop', e => { e.preventDefault(); area.classList.remove('dragover'); if (e.dataTransfer.files[0]) uploadFile(e.dataTransfer.files[0]); });
            }

            await loadDocuments();
        }

        async function loadDocuments() {
            try {
                let url = `${API}/api/documents`;
                if (selectedSourceGroupId) url += `?source_group_id=${selectedSourceGroupId}`;
                const resp = await fetch(url, { headers: authHeaders() });
                const data = await resp.json();
                const tbody = document.getElementById('docList');
                if (!data.documents.length) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#a0aec0;padding:32px">Hen√ºz dok√ºman y√ºklenmedi</td></tr>';
                    return;
                }
                tbody.innerHTML = data.documents.map(d => {
                    const sg = sourceGroups.find(g => g.id === d.source_group_id);
                    const sgBadge = sg ? `<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-size:11px;background:${sg.color}22;color:${sg.color};border:1px solid ${sg.color}44"><span style="width:6px;height:6px;border-radius:50%;background:${sg.color}"></span>${escHtml(sg.name)}</span>` : (d.source_group_name || '-');
                    return `<tr>
                        <td><strong>${escHtml(d.filename)}</strong></td>
                        <td>${d.file_type.toUpperCase()}</td>
                        <td>${sgBadge}</td>
                        <td>${d.category || 'genel'}</td>
                        <td><span class="badge ${d.status === 'indexed' ? 'badge-green' : d.status === 'processing' ? 'badge-yellow' : 'badge-red'}">${d.status}</span></td>
                        <td>${d.chunk_count}</td>
                        <td>${new Date(d.created_at).toLocaleDateString('tr-TR')}</td>
                        ${hasPerm('documents.delete') ? `<td><button class="btn btn-danger btn-sm" onclick="deleteDoc('${d.id}')">Sil</button></td>` : ''}
                    </tr>`;
                }).join('');
            } catch (e) { console.error(e); }
        }

        async function uploadFile(file) {
            if (!file) return;
            const alertEl = document.getElementById('docAlert');
            const progressEl = document.getElementById('uploadProgress');
            const statusEl = document.getElementById('uploadStatus');
            const fillEl = document.getElementById('progressFill');

            progressEl.classList.remove('hidden');
            statusEl.textContent = `"${file.name}" y√ºkleniyor ve i≈üleniyor...`;
            fillEl.style.width = '30%';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('category', document.getElementById('docCategory').value);
            const sgSelect = document.getElementById('docSourceGroup');
            if (sgSelect && sgSelect.value) formData.append('source_group_id', sgSelect.value);

            try {
                fillEl.style.width = '60%';
                const resp = await fetch(`${API}/api/documents/upload`, {
                    method: 'POST',
                    headers: authHeaders(),
                    body: formData
                });
                fillEl.style.width = '100%';
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    throw new Error(err.detail || `HTTP ${resp.status}`);
                }
                const data = await resp.json();
                alertEl.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                statusEl.textContent = 'Tamamlandƒ±!';
                await loadSourceGroups();
                renderSourceGroupCards();
                await loadDocuments();
                setTimeout(() => { progressEl.classList.add('hidden'); }, 2000);
            } catch (e) {
                alertEl.innerHTML = `<div class="alert alert-error">Y√ºkleme hatasƒ±: ${e.message}</div>`;
                statusEl.textContent = 'Hata!';
                fillEl.style.width = '0%';
            }
        }

        async function deleteDoc(id) {
            if (!confirm('Bu dok√ºmanƒ± silmek istediƒüinize emin misiniz?')) return;
            try {
                await fetch(`${API}/api/documents/${id}`, { method: 'DELETE', headers: authHeaders() });
                await loadSourceGroups();
                renderSourceGroupCards();
                await loadDocuments();
            } catch (e) { alert('Silme hatasƒ±: ' + e.message); }
        }

        // ‚îÄ‚îÄ Source Group CRUD Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function showSourceGroupModal(existingId) {
            const sg = existingId ? sourceGroups.find(g => g.id === existingId) : null;
            const perms = sg ? (sg.data_permissions || {}) : { rag_enabled: true, product_db_enabled: true, odoo_enabled: false, odoo_scopes: [] };
            const isEdit = !!sg;
            document.getElementById('globalModal').innerHTML = `
                <div style="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1000;display:flex;align-items:center;justify-content:center" onclick="if(event.target===this)this.remove()">
                    <div style="background:#fff;border-radius:12px;padding:28px;width:480px;max-height:90vh;overflow-y:auto" onclick="event.stopPropagation()">
                        <h3 style="margin-bottom:16px">${isEdit ? 'Kaynak Grubu D√ºzenle' : 'Yeni Kaynak Grubu'}</h3>
                        <div style="display:flex;flex-direction:column;gap:12px">
                            <div>
                                <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Ad *</label>
                                <input id="sgName" type="text" value="${isEdit ? escHtml(sg.name) : ''}" placeholder="√ñrn: Dahili (√áalƒ±≈üan)" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px">
                            </div>
                            <div>
                                <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Slug * <span style="color:#aaa;font-weight:400">(k√º√ß√ºk harf, tire/alt √ßizgi)</span></label>
                                <input id="sgSlug" type="text" value="${isEdit ? escHtml(sg.slug) : ''}" placeholder="√ñrn: internal" ${isEdit ? 'readonly style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;background:#f5f5f5"' : 'style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px"'}>
                            </div>
                            <div>
                                <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">A√ßƒ±klama</label>
                                <textarea id="sgDesc" rows="2" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;resize:vertical">${isEdit ? escHtml(sg.description || '') : ''}</textarea>
                            </div>
                            <div>
                                <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Renk</label>
                                <input id="sgColor" type="color" value="${isEdit ? sg.color : '#6b7280'}" style="width:50px;height:36px;border:1px solid #ddd;border-radius:6px;cursor:pointer">
                            </div>
                            <div style="border-top:1px solid #eee;padding-top:12px">
                                <label style="display:block;font-size:13px;font-weight:600;margin-bottom:8px">Veri Eri≈üim ƒ∞zinleri</label>
                                <label style="display:flex;align-items:center;gap:8px;margin-bottom:6px;cursor:pointer">
                                    <input type="checkbox" id="sgPermRag" ${perms.rag_enabled !== false ? 'checked' : ''}> Dok√ºman Arama (RAG)
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;margin-bottom:6px;cursor:pointer">
                                    <input type="checkbox" id="sgPermProduct" ${perms.product_db_enabled !== false ? 'checked' : ''}> √úr√ºn Veritabanƒ±
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;margin-bottom:6px;cursor:pointer">
                                    <input type="checkbox" id="sgPermOdoo" ${perms.odoo_enabled ? 'checked' : ''} onchange="document.getElementById('sgOdooScopes').style.display=this.checked?'block':'none'"> Odoo ERP Eri≈üimi
                                </label>
                                <div id="sgOdooScopes" style="display:${perms.odoo_enabled ? 'block' : 'none'};margin-left:24px;margin-top:4px">
                                    <label style="font-size:12px;font-weight:500;margin-bottom:4px;display:block;color:#718096">Odoo Kapsamlarƒ±:</label>
                                    ${['orders', 'invoices', 'deliveries', 'tickets', 'partners', 'financials', 'reports'].map(s =>
                                        `<label style="display:flex;align-items:center;gap:6px;margin-bottom:3px;cursor:pointer;font-size:13px">
                                            <input type="checkbox" class="sgOdooScope" value="${s}" ${(perms.odoo_scopes || []).includes(s) ? 'checked' : ''}> ${s}
                                        </label>`
                                    ).join('')}
                                </div>
                            </div>
                            <div style="display:flex;gap:8px;margin-top:8px">
                                <button onclick="saveSourceGroup(${isEdit ? `'${sg.id}'` : 'null'})" style="flex:1;padding:10px;background:#231f20;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500">${isEdit ? 'G√ºncelle' : 'Olu≈ütur'}</button>
                                <button onclick="document.getElementById('globalModal').innerHTML=''" style="padding:10px 20px;background:#f5f5f5;color:#333;border:1px solid #ddd;border-radius:8px;cursor:pointer;font-size:14px">ƒ∞ptal</button>
                                ${isEdit && !sg.is_default ? `<button onclick="deleteSourceGroup('${sg.id}')" style="padding:10px 16px;background:#fee;color:#c00;border:1px solid #fcc;border-radius:8px;cursor:pointer;font-size:14px">Sil</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function editSourceGroup(id) { showSourceGroupModal(id); }

        async function saveSourceGroup(existingId) {
            const name = document.getElementById('sgName').value.trim();
            const slug = document.getElementById('sgSlug').value.trim();
            const description = document.getElementById('sgDesc').value.trim();
            const color = document.getElementById('sgColor').value;
            const data_permissions = {
                rag_enabled: document.getElementById('sgPermRag').checked,
                product_db_enabled: document.getElementById('sgPermProduct').checked,
                odoo_enabled: document.getElementById('sgPermOdoo').checked,
                odoo_scopes: [...document.querySelectorAll('.sgOdooScope:checked')].map(c => c.value),
            };

            if (!name) { alert('Ad gerekli'); return; }

            const body = { name, description, color, data_permissions, is_active: true };
            if (!existingId) body.slug = slug;

            try {
                const url = existingId
                    ? `${API}/api/admin/source-groups/${existingId}`
                    : `${API}/api/admin/source-groups`;
                const resp = await fetch(url, {
                    method: existingId ? 'PUT' : 'POST',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    throw new Error(err.detail || `HTTP ${resp.status}`);
                }
                document.getElementById('globalModal').innerHTML = '';
                await loadSourceGroups();
                renderSourceGroupCards();
            } catch (e) { alert('Kaydetme hatasƒ±: ' + e.message); }
        }

        async function deleteSourceGroup(id) {
            if (!confirm('Bu kaynak grubunu silmek istediƒüinize emin misiniz?')) return;
            try {
                const resp = await fetch(`${API}/api/admin/source-groups/${id}`, { method: 'DELETE', headers: authHeaders() });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    throw new Error(err.detail || `HTTP ${resp.status}`);
                }
                document.getElementById('globalModal').innerHTML = '';
                selectedSourceGroupId = null;
                await loadSourceGroups();
                renderSourceGroupCards();
                await loadDocuments();
            } catch (e) { alert('Silme hatasƒ±: ' + e.message); }
        }

        // ‚îÄ‚îÄ Products ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        let prodSearchTimer = null;
        let prodCurrentPage = 0;
        const PROD_PAGE_SIZE = 20;
        let prodFilters = { markalar: [], koleksiyonlar: [], urun_tipleri: [] };

        async function renderProducts(el) {
            // Load filter options
            try {
                const fResp = await fetch(`${API}/api/admin/products/filters`, { headers: authHeaders() });
                if (fResp.ok) prodFilters = await fResp.json();
            } catch (e) { }

            el.innerHTML = `
                <div id="prodAlert"></div>
                <div class="toolbar">
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        <input type="text" class="search-box" id="prodSearch"
                            placeholder="√úr√ºn kodu, tanƒ±m veya marka ara..."
                            oninput="debounceProdSearch()">
                        <div class="filters">
                            <select id="prodMarkaFilter" onchange="prodCurrentPage=0;loadProducts()">
                                <option value="">T√ºm Markalar</option>
                                ${prodFilters.markalar.map(m => `<option value="${escHtml(m)}">${escHtml(m)}</option>`).join('')}
                            </select>
                            <select id="prodTipFilter" onchange="prodCurrentPage=0;loadProducts()">
                                <option value="">T√ºm Tipler</option>
                                ${prodFilters.urun_tipleri.map(t => `<option value="${escHtml(t)}">${escHtml(t)}</option>`).join('')}
                            </select>
                            <select id="prodAktifFilter" onchange="prodCurrentPage=0;loadProducts()">
                                <option value="">T√ºm Durumlar</option>
                                <option value="true">Aktif</option>
                                <option value="false">Pasif</option>
                            </select>
                        </div>
                    </div>
                    ${hasPerm('documents.upload') ? `
                        <button class="btn btn-primary" onclick="showCreateProductModal()">+ Yeni √úr√ºn</button>
                    ` : ''}
                </div>
                <table class="doc-table" id="productsTable">
                    <thead>
                        <tr>
                            <th>√úr√ºn Kodu</th>
                            <th>Tanƒ±m</th>
                            <th>Marka</th>
                            <th>Koleksiyon</th>
                            <th>Tip</th>
                            <th>Fiyat</th>
                            <th>Stok</th>
                            <th>Durum</th>
                            <th>ƒ∞≈ülemler</th>
                        </tr>
                    </thead>
                    <tbody id="productList">
                        <tr><td colspan="9" style="text-align:center;color:#a0aec0">Y√ºkleniyor...</td></tr>
                    </tbody>
                </table>
                <div id="prodPagination" style="margin-top:12px;display:flex;justify-content:center;gap:4px"></div>
            `;

            await loadProducts();
        }

        function debounceProdSearch() {
            clearTimeout(prodSearchTimer);
            prodSearchTimer = setTimeout(() => { prodCurrentPage = 0; loadProducts(); }, 300);
        }

        async function loadProducts() {
            const search = document.getElementById('prodSearch')?.value || '';
            const marka = document.getElementById('prodMarkaFilter')?.value || '';
            const tip = document.getElementById('prodTipFilter')?.value || '';
            const aktif = document.getElementById('prodAktifFilter')?.value || '';

            const params = new URLSearchParams();
            if (search) params.set('search', search);
            if (marka) params.set('marka', marka);
            if (tip) params.set('urun_tipi', tip);
            if (aktif) params.set('aktif', aktif);
            params.set('limit', PROD_PAGE_SIZE);
            params.set('offset', prodCurrentPage * PROD_PAGE_SIZE);

            try {
                const resp = await fetch(`${API}/api/admin/products?${params}`, { headers: authHeaders() });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    document.getElementById('productList').innerHTML =
                        `<tr><td colspan="9" class="alert alert-error">${escHtml(err.detail || 'Y√ºkleme hatasƒ±')}</td></tr>`;
                    return;
                }
                const data = await resp.json();
                const tbody = document.getElementById('productList');

                if (!data.products || !data.products.length) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#a0aec0;padding:32px">√úr√ºn bulunamadƒ±</td></tr>';
                    document.getElementById('prodPagination').innerHTML = '';
                    return;
                }

                tbody.innerHTML = data.products.map(p => `
                    <tr>
                        <td><strong>${escHtml(p.urun_kodu)}</strong></td>
                        <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escHtml(p.urun_tanimi || '')}">${escHtml(p.urun_tanimi || '-')}</td>
                        <td>${escHtml(p.marka || '-')}</td>
                        <td>${escHtml(p.koleksiyon || '-')}</td>
                        <td>${escHtml(p.urun_tipi || '-')}</td>
                        <td>${p.fiyat != null ? Number(p.fiyat).toLocaleString('tr-TR', { minimumFractionDigits: 2 }) + ' ' + (p.para_birimi || 'TRY') : '-'}</td>
                        <td>${p.stok}</td>
                        <td><span class="badge ${p.aktif ? 'badge-green' : 'badge-red'}">${p.aktif ? 'Aktif' : 'Pasif'}</span></td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-sm btn-outline" onclick="showProductDetail(${p.id})">Detay</button>
                                ${hasPerm('documents.upload') ? `<button class="btn btn-sm btn-outline" onclick="showEditProductModal(${p.id})">D√ºzenle</button>` : ''}
                                ${hasPerm('documents.delete') ? `<button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id})">Sil</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');

                renderProdPagination(data.total);
            } catch (e) {
                console.error('loadProducts error:', e);
            }
        }

        function renderProdPagination(total) {
            const pages = Math.ceil(total / PROD_PAGE_SIZE);
            const pagEl = document.getElementById('prodPagination');
            if (pages <= 1) { pagEl.innerHTML = ''; return; }
            let html = '';
            for (let i = 0; i < pages; i++) {
                html += `<button class="btn btn-sm ${i === prodCurrentPage ? 'btn-primary' : 'btn-outline'}"
                    onclick="prodCurrentPage=${i};loadProducts()" style="min-width:32px">${i + 1}</button>`;
            }
            pagEl.innerHTML = html;
        }

        // Product field definitions for forms
        const PRODUCT_FIELDS = [
            { key: 'urun_kodu', label: '√úr√ºn Kodu', required: true },
            { key: 'urun_tanimi', label: '√úr√ºn Tanƒ±mƒ±', type: 'textarea' },
            { key: 'marka', label: 'Marka' },
            { key: 'koleksiyon', label: 'Koleksiyon' },
            { key: 'model', label: 'Model' },
            { key: 'urun_tipi', label: '√úr√ºn Tipi' },
            { key: 'ebat_cm', label: 'Ebat (cm)' },
            { key: 'hacim_cc', label: 'Hacim (cc)', type: 'number' },
            { key: 'materyal', label: 'Materyal' },
            { key: 'ana_renk', label: 'Ana Renk' },
            { key: 'renk_tonu', label: 'Renk Tonu' },
            { key: 'form', label: 'Form' },
            { key: 'stil', label: 'Stil' },
            { key: 'yuzey_bitisi', label: 'Y√ºzey Biti≈üi' },
            { key: 'dekor', label: 'Dekor' },
            { key: 'segment', label: 'Segment' },
            { key: 'fiyat_segmenti', label: 'Fiyat Segmenti' },
            { key: 'kullanim_alani', label: 'Kullanƒ±m Alanƒ±' },
            { key: 'servis_tipi', label: 'Servis Tipi' },
            { key: 'mutfak_uyumu', label: 'Mutfak Uyumu' },
            { key: 'yemek_onerileri', label: 'Yemek √ñnerileri', type: 'textarea' },
            { key: 'konsept_etiketler', label: 'Konsept Etiketler', type: 'textarea' },
            { key: 'rekabet_avantaji', label: 'Rekabet Avantajƒ±', type: 'textarea' },
            { key: 'istiflenebilirlik', label: 'ƒ∞stiflenebilirlik' },
            { key: 'kenar_citlama_dayanimi', label: 'Kenar/√áƒ±tlama Dayanƒ±mƒ±' },
            { key: 'cizilme_direnci', label: '√áizilme Direnci' },
            { key: 'dayanim_seviyesi', label: 'Dayanƒ±m Seviyesi' },
            { key: 'fiyat', label: 'Fiyat', type: 'number', step: '0.01' },
            { key: 'para_birimi', label: 'Para Birimi' },
            { key: 'stok', label: 'Stok', type: 'number' },
            { key: 'image', label: 'G√∂rsel URL' },
            { key: 'aktif', label: 'Aktif', type: 'checkbox' },
        ];

        function buildProductFormFields(data) {
            return PRODUCT_FIELDS.map(f => {
                const val = data ? (data[f.key] ?? '') : (f.key === 'aktif' ? true : (f.key === 'para_birimi' ? 'TRY' : (f.key === 'stok' ? 0 : '')));
                if (f.type === 'checkbox') {
                    return `<div class="form-group" style="display:flex;align-items:center;gap:8px">
                        <input type="checkbox" id="prodField_${f.key}" ${val ? 'checked' : ''} style="width:auto">
                        <label style="margin:0">${f.label}</label>
                    </div>`;
                }
                if (f.type === 'textarea') {
                    return `<div class="form-group">
                        <label>${f.label}${f.required ? ' *' : ''}</label>
                        <textarea id="prodField_${f.key}" rows="2" style="width:100%;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px;resize:vertical">${escHtml(String(val))}</textarea>
                    </div>`;
                }
                return `<div class="form-group">
                    <label>${f.label}${f.required ? ' *' : ''}</label>
                    <input type="${f.type || 'text'}" id="prodField_${f.key}" value="${escHtml(String(val))}" ${f.step ? `step="${f.step}"` : ''}>
                </div>`;
            }).join('');
        }

        function collectProductFormData() {
            const data = {};
            for (const f of PRODUCT_FIELDS) {
                const el = document.getElementById(`prodField_${f.key}`);
                if (!el) continue;
                if (f.type === 'checkbox') {
                    data[f.key] = el.checked;
                } else if (f.type === 'number') {
                    const v = el.value.trim();
                    data[f.key] = v === '' ? null : (f.step ? parseFloat(v) : parseInt(v));
                } else {
                    data[f.key] = el.value.trim() || null;
                }
            }
            return data;
        }

        function showCreateProductModal() {
            document.getElementById('globalModal').innerHTML = `
                <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
                    <div class="modal" style="max-width:600px">
                        <h3>Yeni √úr√ºn Olu≈ütur</h3>
                        <div style="max-height:60vh;overflow-y:auto;padding-right:8px">
                            ${buildProductFormFields(null)}
                        </div>
                        <div id="createProdError" class="alert alert-error hidden" style="margin-top:12px"></div>
                        <div class="form-actions">
                            <button class="btn btn-outline" onclick="closeModal()">ƒ∞ptal</button>
                            <button class="btn btn-primary" id="createProdBtn" onclick="createProduct()">Olu≈ütur</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('prodField_urun_kodu').focus();
        }

        async function createProduct() {
            const data = collectProductFormData();
            const errEl = document.getElementById('createProdError');
            const btn = document.getElementById('createProdBtn');

            if (!data.urun_kodu) {
                errEl.textContent = '√úr√ºn kodu zorunlu';
                errEl.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            try {
                const resp = await fetch(`${API}/api/admin/products`, {
                    method: 'POST',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    errEl.textContent = err.detail || `Hata: HTTP ${resp.status}`;
                    errEl.classList.remove('hidden');
                    btn.disabled = false;
                    return;
                }
                closeModal();
                showAlert('prodAlert', 'success', `"${data.urun_kodu}" √ºr√ºn√º olu≈üturuldu`);
                await loadProducts();
            } catch (e) {
                errEl.textContent = 'Baƒülantƒ± hatasƒ±:' + e.message;
                errEl.classList.remove('hidden');
                btn.disabled = false;
            }
        }

        async function showEditProductModal(productId) {
            try {
                const resp = await fetch(`${API}/api/admin/products/${productId}`, { headers: authHeaders() });
                if (!resp.ok) return;
                const p = await resp.json();

                document.getElementById('globalModal').innerHTML = `
                    <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
                        <div class="modal" style="max-width:600px">
                            <h3>√úr√ºn D√ºzenle - ${escHtml(p.urun_kodu)}</h3>
                            <div style="max-height:60vh;overflow-y:auto;padding-right:8px">
                                ${buildProductFormFields(p)}
                            </div>
                            <div id="editProdError" class="alert alert-error hidden" style="margin-top:12px"></div>
                            <div class="form-actions">
                                <button class="btn btn-outline" onclick="closeModal()">ƒ∞ptal</button>
                                <button class="btn btn-primary" id="editProdBtn" onclick="updateProduct(${p.id})">Kaydet</button>
                            </div>
                        </div>
                    </div>`;
            } catch (e) { console.error(e); }
        }

        async function updateProduct(productId) {
            const data = collectProductFormData();
            const errEl = document.getElementById('editProdError');
            const btn = document.getElementById('editProdBtn');

            if (!data.urun_kodu) {
                errEl.textContent = '√úr√ºn kodu zorunlu';
                errEl.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            try {
                const resp = await fetch(`${API}/api/admin/products/${productId}`, {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    errEl.textContent = err.detail || 'G√ºncelleme hatasƒ±';
                    errEl.classList.remove('hidden');
                    btn.disabled = false;
                    return;
                }
                closeModal();
                showAlert('prodAlert', 'success', '√úr√ºn g√ºncellendi');
                await loadProducts();
            } catch (e) {
                errEl.textContent = 'Baƒülantƒ± hatasƒ±:' + e.message;
                errEl.classList.remove('hidden');
                btn.disabled = false;
            }
        }

        function showProductDetail(productId) {
            fetch(`${API}/api/admin/products/${productId}`, { headers: authHeaders() })
                .then(r => r.json())
                .then(p => {
                    const rows = PRODUCT_FIELDS.map(f => {
                        let val = p[f.key];
                        if (f.type === 'checkbox') val = val ? 'Evet' : 'Hayƒ±r';
                        else if (val == null || val === '') val = '-';
                        return `<tr><td style="font-weight:500;color:#4a5568;white-space:nowrap;padding-right:16px">${f.label}</td><td>${escHtml(String(val))}</td></tr>`;
                    }).join('');

                    document.getElementById('globalModal').innerHTML = `
                        <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
                            <div class="modal" style="max-width:600px">
                                <h3>√úr√ºn Detay - ${escHtml(p.urun_kodu)}</h3>
                                ${p.image ? `<img src="${escHtml(p.image)}" alt="" style="max-width:100%;max-height:200px;object-fit:contain;margin-bottom:16px;border-radius:8px">` : ''}
                                <div style="max-height:60vh;overflow-y:auto">
                                    <table style="width:100%;font-size:13px;line-height:1.8">
                                        ${rows}
                                        <tr><td style="font-weight:500;color:#4a5568">Olu≈üturma</td><td>${formatDate(p.created_at)}</td></tr>
                                        <tr><td style="font-weight:500;color:#4a5568">G√ºncelleme</td><td>${p.updated_at ? formatDate(p.updated_at) : '-'}</td></tr>
                                    </table>
                                </div>
                                <div class="form-actions">
                                    ${hasPerm('documents.upload') ? `<button class="btn btn-primary" onclick="closeModal();showEditProductModal(${p.id})">D√ºzenle</button>` : ''}
                                    <button class="btn btn-outline" onclick="closeModal()">Kapat</button>
                                </div>
                            </div>
                        </div>`;
                })
                .catch(e => console.error(e));
        }

        async function deleteProduct(productId) {
            if (!confirm('Bu √ºr√ºn√º silmek istediƒüinize emin misiniz?')) return;
            try {
                const resp = await fetch(`${API}/api/admin/products/${productId}`, {
                    method: 'DELETE', headers: authHeaders()
                });
                if (resp.ok) {
                    showAlert('prodAlert', 'success', '√úr√ºn silindi');
                    await loadProducts();
                } else {
                    const err = await resp.json().catch(() => ({}));
                    showAlert('prodAlert', 'error', err.detail || 'Silme hatasƒ±');
                }
            } catch (e) {
                showAlert('prodAlert', 'error', 'Baƒülantƒ± hatasƒ±:' + e.message);
            }
        }

        // ‚îÄ‚îÄ Users ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        let userSearchTimer = null;
        let userCurrentPage = 0;
        const USER_PAGE_SIZE = 20;

        async function renderUsers(el) {
            el.innerHTML = `
                <div id="userAlert"></div>
                <div class="toolbar">
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        <input type="text" class="search-box" id="userSearch"
                            placeholder="Ad veya e-posta ara..."
                            oninput="debounceUserSearch()">
                        <div class="filters">
                            <select id="userRoleFilter" onchange="userCurrentPage=0;loadUsers()">
                                <option value="">T√ºm Roller</option>
                                <option value="admin">Admin</option>
                                <option value="manager">Y√∂netici</option>
                                <option value="agent">Temsilci</option>
                                <option value="viewer">ƒ∞zleyici</option>
                            </select>
                            <select id="userStatusFilter" onchange="userCurrentPage=0;loadUsers()">
                                <option value="">T√ºm Durumlar</option>
                                <option value="true">Aktif</option>
                                <option value="false">Pasif</option>
                            </select>
                        </div>
                    </div>
                    ${hasPerm('users.create') ? `
                        <button class="btn btn-primary" onclick="showCreateUserModal()">+ Yeni Kullanƒ±cƒ±</button>
                    ` : ''}
                </div>
                <table class="doc-table" id="usersTable">
                    <thead>
                        <tr>
                            <th>Kullanƒ±cƒ±</th>
                            <th>E-posta</th>
                            <th>Rol</th>
                            <th>Durum</th>
                            <th>Son Giri≈ü</th>
                            <th>Olu≈üturma</th>
                            <th>ƒ∞≈ülemler</th>
                        </tr>
                    </thead>
                    <tbody id="userList">
                        <tr><td colspan="7" style="text-align:center;color:#a0aec0">Y√ºkleniyor...</td></tr>
                    </tbody>
                </table>
                <div id="userPagination" style="margin-top:12px;display:flex;justify-content:center;gap:4px"></div>

                ${hasPerm('users.view') ? `
                <div class="section-header" style="margin-top:32px">Son ƒ∞≈ülemler</div>
                <table class="doc-table">
                    <thead>
                        <tr><th>Tarih</th><th>Kullanƒ±cƒ±</th><th>ƒ∞≈ülem</th><th>Detay</th></tr>
                    </thead>
                    <tbody id="activityLogList">
                        <tr><td colspan="4" style="text-align:center;color:#a0aec0">Y√ºkleniyor...</td></tr>
                    </tbody>
                </table>
                ` : ''}
            `;

            await loadUsers();
            if (hasPerm('users.view')) await loadActivityLogs();
        }

        function debounceUserSearch() {
            clearTimeout(userSearchTimer);
            userSearchTimer = setTimeout(() => { userCurrentPage = 0; loadUsers(); }, 300);
        }

        async function loadUsers() {
            const search = document.getElementById('userSearch')?.value || '';
            const role = document.getElementById('userRoleFilter')?.value || '';
            const status = document.getElementById('userStatusFilter')?.value || '';

            const params = new URLSearchParams();
            if (search) params.set('search', search);
            if (role) params.set('role', role);
            if (status) params.set('is_active', status);
            params.set('limit', USER_PAGE_SIZE);
            params.set('offset', userCurrentPage * USER_PAGE_SIZE);

            try {
                const resp = await fetch(`${API}/api/admin/users?${params}`, { headers: authHeaders() });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    document.getElementById('userList').innerHTML =
                        `<tr><td colspan="7" class="alert alert-error">${escHtml(err.detail || 'Y√ºkleme hatasƒ±')}</td></tr>`;
                    return;
                }
                const data = await resp.json();
                const tbody = document.getElementById('userList');

                if (!data.users || !data.users.length) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#a0aec0;padding:32px">Kullanƒ±cƒ± bulunamadƒ±</td></tr>';
                    document.getElementById('userPagination').innerHTML = '';
                    return;
                }

                tbody.innerHTML = data.users.map(u => {
                    const isSelf = currentUser && u.id === currentUser.id;
                    return `
                    <tr>
                        <td><strong>${escHtml(u.full_name)}</strong>${isSelf ? ' <span style="font-size:11px;color:#a0aec0">(siz)</span>' : ''}</td>
                        <td>${escHtml(u.email)}</td>
                        <td><span class="badge ${ROLE_BADGE_CLASS[u.role] || 'badge-gray'}">${ROLE_LABELS[u.role] || u.role}</span></td>
                        <td><span class="badge ${u.is_active ? 'badge-green' : 'badge-red'}">${u.is_active ? 'Aktif' : 'Pasif'}</span></td>
                        <td style="font-size:12px">${u.last_login_at ? formatDate(u.last_login_at) : '<span style="color:#cbd5e0">-</span>'}</td>
                        <td style="font-size:12px">${formatDate(u.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                ${hasPerm('users.edit') ? `<button class="btn btn-sm btn-outline" onclick="showEditUserModal('${u.id}')">D√ºzenle</button>` : ''}
                                ${hasPerm('users.reset_password') && !isSelf ? `<button class="btn btn-sm" style="background:#fefcbf;color:#975a16" onclick="showResetPasswordModal('${u.id}','${escHtml(u.full_name)}')">Parola</button>` : ''}
                                ${hasPerm('users.delete') && !isSelf ? `
                                    <button class="btn btn-sm ${u.is_active ? 'btn-danger' : 'btn-success'}"
                                        onclick="toggleUserActive('${u.id}', ${!u.is_active})">
                                        ${u.is_active ? 'Deaktif' : 'Aktif Et'}
                                    </button>` : ''}
                            </div>
                        </td>
                    </tr>`;
                }).join('');

                renderUserPagination(data.total);
            } catch (e) {
                console.error('loadUsers error:', e);
            }
        }

        function renderUserPagination(total) {
            const pages = Math.ceil(total / USER_PAGE_SIZE);
            const pagEl = document.getElementById('userPagination');
            if (pages <= 1) { pagEl.innerHTML = ''; return; }
            let html = '';
            for (let i = 0; i < pages; i++) {
                html += `<button class="btn btn-sm ${i === userCurrentPage ? 'btn-primary' : 'btn-outline'}"
                    onclick="userCurrentPage=${i};loadUsers()" style="min-width:32px">${i + 1}</button>`;
            }
            pagEl.innerHTML = html;
        }

        // ‚îÄ‚îÄ User Modals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function showCreateUserModal() {
            const roleOptions = [];
            if (currentUser?.role === 'admin') roleOptions.push('<option value="admin">Admin</option>');
            if (hasPerm('admin.full_access') || (currentUser?.role === 'admin' || currentUser?.role === 'manager'))
                roleOptions.push('<option value="manager">Y√∂netici</option>');
            roleOptions.push('<option value="agent" selected>Temsilci</option>');
            roleOptions.push('<option value="viewer">ƒ∞zleyici</option>');

            document.getElementById('globalModal').innerHTML = `
                <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
                    <div class="modal">
                        <h3>Yeni Kullanƒ±cƒ± Olu≈ütur</h3>
                        <div class="form-group">
                            <label>Ad Soyad</label>
                            <input type="text" id="newUserName" placeholder="Adƒ± Soyadƒ±">
                        </div>
                        <div class="form-group">
                            <label>E-posta</label>
                            <input type="email" id="newUserEmail" placeholder="ornek@idfine.com">
                        </div>
                        <div class="form-group">
                            <label>Parola</label>
                            <input type="password" id="newUserPassword" placeholder="En az 6 karakter">
                        </div>
                        <div class="form-group">
                            <label>Rol</label>
                            <select id="newUserRole">${roleOptions.join('')}</select>
                        </div>
                        <div id="createUserError" class="alert alert-error hidden"></div>
                        <div class="form-actions">
                            <button class="btn btn-outline" onclick="closeModal()">ƒ∞ptal</button>
                            <button class="btn btn-primary" id="createUserBtn" onclick="createUser()">Olu≈ütur</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('newUserName').focus();
        }

        async function createUser() {
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            const errEl = document.getElementById('createUserError');
            const btn = document.getElementById('createUserBtn');

            if (!name || !email || !password) {
                errEl.textContent = 'T√ºm alanlar zorunlu'; errEl.classList.remove('hidden'); return;
            }
            if (password.length < 6) {
                errEl.textContent = 'Parola en az 6 karakter olmalƒ±'; errEl.classList.remove('hidden'); return;
            }

            btn.disabled = true;
            try {
                const resp = await fetch(`${API}/api/admin/users`, {
                    method: 'POST',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, full_name: name, role })
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    errEl.textContent = err.detail || `Hata: HTTP ${resp.status}`;
                    errEl.classList.remove('hidden');
                    btn.disabled = false;
                    return;
                }
                closeModal();
                showAlert('userAlert', 'success', `"${name}" kullanƒ±cƒ±sƒ± olu≈üturuldu`);
                await loadUsers();
                await loadActivityLogs();
            } catch (e) {
                errEl.textContent = 'Baƒülantƒ± hatasƒ±:' + e.message;
                errEl.classList.remove('hidden');
                btn.disabled = false;
            }
        }

        async function showEditUserModal(userId) {
            try {
                const resp = await fetch(`${API}/api/admin/users/${userId}`, { headers: authHeaders() });
                if (!resp.ok) return;
                const u = await resp.json();

                const isSelf = currentUser && u.id === currentUser.id;

                let roleHtml = '';
                if (hasPerm('users.assign_role') && !isSelf) {
                    const opts = [];
                    if (currentUser?.role === 'admin') opts.push(`<option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>`);
                    opts.push(`<option value="manager" ${u.role === 'manager' ? 'selected' : ''}>Y√∂netici</option>`);
                    opts.push(`<option value="agent" ${u.role === 'agent' ? 'selected' : ''}>Temsilci</option>`);
                    opts.push(`<option value="viewer" ${u.role === 'viewer' ? 'selected' : ''}>ƒ∞zleyici</option>`);
                    roleHtml = `
                    <div class="form-group">
                        <label>Rol</label>
                        <select id="editUserRole">${opts.join('')}</select>
                    </div>`;
                }

                document.getElementById('globalModal').innerHTML = `
                    <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
                        <div class="modal">
                            <h3>Kullanƒ±cƒ± D√ºzenle</h3>
                            <div class="form-group">
                                <label>Ad Soyad</label>
                                <input type="text" id="editUserName" value="${escHtml(u.full_name)}">
                            </div>
                            <div class="form-group">
                                <label>E-posta</label>
                                <input type="email" id="editUserEmail" value="${escHtml(u.email)}">
                            </div>
                            ${roleHtml}
                            <div id="editUserError" class="alert alert-error hidden"></div>
                            <div class="form-actions">
                                <button class="btn btn-outline" onclick="closeModal()">ƒ∞ptal</button>
                                <button class="btn btn-primary" id="editUserBtn" onclick="updateUser('${u.id}','${u.role}')">Kaydet</button>
                            </div>
                        </div>
                    </div>`;
                document.getElementById('editUserName').focus();
            } catch (e) { console.error(e); }
        }

        async function updateUser(userId, originalRole) {
            const name = document.getElementById('editUserName').value.trim();
            const email = document.getElementById('editUserEmail').value.trim();
            const errEl = document.getElementById('editUserError');
            const btn = document.getElementById('editUserBtn');

            if (!name || !email) {
                errEl.textContent = 'Ad ve e-posta zorunlu'; errEl.classList.remove('hidden'); return;
            }

            btn.disabled = true;
            try {
                // Update profile
                const resp = await fetch(`${API}/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ full_name: name, email: email })
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    errEl.textContent = err.detail || 'G√ºncelleme hatasƒ±';
                    errEl.classList.remove('hidden');
                    btn.disabled = false;
                    return;
                }

                // Update role if changed
                const roleSelect = document.getElementById('editUserRole');
                if (roleSelect && roleSelect.value !== originalRole) {
                    const roleResp = await fetch(`${API}/api/admin/users/${userId}/role`, {
                        method: 'PUT',
                        headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ role: roleSelect.value })
                    });
                    if (!roleResp.ok) {
                        const err = await roleResp.json().catch(() => ({}));
                        errEl.textContent = err.detail || 'Rol g√ºncelleme hatasƒ±';
                        errEl.classList.remove('hidden');
                        btn.disabled = false;
                        return;
                    }
                }

                closeModal();
                showAlert('userAlert', 'success', 'Kullanƒ±cƒ± g√ºncellendi');
                await loadUsers();
                await loadActivityLogs();
            } catch (e) {
                errEl.textContent = 'Baƒülantƒ± hatasƒ±:' + e.message;
                errEl.classList.remove('hidden');
                btn.disabled = false;
            }
        }

        function showResetPasswordModal(userId, userName) {
            document.getElementById('globalModal').innerHTML = `
                <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
                    <div class="modal">
                        <h3>Parola Sƒ±fƒ±rla</h3>
                        <p style="margin-bottom:16px;color:#718096;font-size:13px">
                            <strong>${escHtml(userName)}</strong> kullanƒ±cƒ±sƒ±nƒ±n parolasƒ±nƒ± sƒ±fƒ±rlayƒ±n.
                        </p>
                        <div class="form-group">
                            <label>Yeni Parola</label>
                            <input type="password" id="resetNewPassword" placeholder="En az 6 karakter">
                        </div>
                        <div class="form-group">
                            <label>Parola Tekrar</label>
                            <input type="password" id="resetConfirmPassword" placeholder="Ayni parolayi tekrar girin">
                        </div>
                        <div id="resetPwError" class="alert alert-error hidden"></div>
                        <div class="form-actions">
                            <button class="btn btn-outline" onclick="closeModal()">ƒ∞ptal</button>
                            <button class="btn btn-primary" id="resetPwBtn" onclick="resetUserPassword('${userId}')">Sƒ±fƒ±rla</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('resetNewPassword').focus();
        }

        async function resetUserPassword(userId) {
            const pw = document.getElementById('resetNewPassword').value;
            const pw2 = document.getElementById('resetConfirmPassword').value;
            const errEl = document.getElementById('resetPwError');
            const btn = document.getElementById('resetPwBtn');

            if (pw.length < 6) {
                errEl.textContent = 'Parola en az 6 karakter olmalƒ±'; errEl.classList.remove('hidden'); return;
            }
            if (pw !== pw2) {
                errEl.textContent = 'Parolalar e≈üle≈ümiyor'; errEl.classList.remove('hidden'); return;
            }

            btn.disabled = true;
            try {
                const resp = await fetch(`${API}/api/admin/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_password: pw })
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    errEl.textContent = err.detail || 'Sƒ±fƒ±rlama hatasƒ±';
                    errEl.classList.remove('hidden');
                    btn.disabled = false;
                    return;
                }
                closeModal();
                showAlert('userAlert', 'success', 'Parola ba≈üarƒ±yla sƒ±fƒ±rlandƒ±');
                await loadActivityLogs();
            } catch (e) {
                errEl.textContent = 'Baƒülantƒ± hatasƒ±:' + e.message;
                errEl.classList.remove('hidden');
                btn.disabled = false;
            }
        }

        async function toggleUserActive(userId, newState) {
            const action = newState ? 'aktif etmek' : 'deaktif etmek';
            if (!confirm(`Bu kullanƒ±cƒ±yƒ± ${action} istediƒüinize emin misiniz?`)) return;

            try {
                const resp = await fetch(`${API}/api/admin/users/${userId}/toggle-active`, {
                    method: 'PUT',
                    headers: authHeaders(),
                });
                if (resp.ok) {
                    showAlert('userAlert', 'success', `Kullanƒ±cƒ± ${newState ? 'aktif edildi' : 'deaktif edildi'}`);
                    await loadUsers();
                    await loadActivityLogs();
                } else {
                    const err = await resp.json().catch(() => ({}));
                    showAlert('userAlert', 'error', err.detail || 'ƒ∞≈ülem hatasƒ±');
                }
            } catch (e) {
                showAlert('userAlert', 'error', 'Baƒülantƒ± hatasƒ±:' + e.message);
            }
        }

        // ‚îÄ‚îÄ Activity Logs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function loadActivityLogs() {
            const tbody = document.getElementById('activityLogList');
            if (!tbody) return;

            try {
                const resp = await fetch(`${API}/api/admin/activity-logs?limit=20`, { headers: authHeaders() });
                if (!resp.ok) return;
                const data = await resp.json();

                if (!data.logs || !data.logs.length) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#a0aec0;padding:16px">Hen√ºz i≈ülem yok</td></tr>';
                    return;
                }

                tbody.innerHTML = data.logs.map(log => {
                    let detailStr = '-';
                    if (log.details && Object.keys(log.details).length) {
                        const parts = [];
                        for (const [k, v] of Object.entries(log.details)) {
                            if (typeof v === 'object' && v !== null && v.old !== undefined) {
                                parts.push(`${k}: ${v.old} ‚Üí ${v.new}`);
                            } else if (k === 'old_role' || k === 'new_role') {
                                // handled together
                            } else if (k === 'email') {
                                parts.push(`e-posta: ${v}`);
                            } else if (k === 'role') {
                                parts.push(`rol: ${ROLE_LABELS[v] || v}`);
                            } else if (k === 'is_active') {
                                parts.push(v ? 'aktif edildi' : 'deaktif edildi');
                            } else {
                                parts.push(`${k}: ${JSON.stringify(v)}`);
                            }
                        }
                        if (log.details.old_role && log.details.new_role) {
                            parts.push(`${ROLE_LABELS[log.details.old_role] || log.details.old_role} ‚Üí ${ROLE_LABELS[log.details.new_role] || log.details.new_role}`);
                        }
                        detailStr = parts.join(', ') || '-';
                    }

                    return `
                    <tr>
                        <td style="font-size:12px;white-space:nowrap">${formatDate(log.created_at)}</td>
                        <td>${escHtml(log.user_full_name || '-')}</td>
                        <td>${ACTION_LABELS[log.action] || log.action}</td>
                        <td style="font-size:12px;color:#718096;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(detailStr)}</td>
                    </tr>`;
                }).join('');
            } catch (e) { console.error('loadActivityLogs:', e); }
        }

        // ‚îÄ‚îÄ Profile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function renderProfile(el) {
            // Refresh current user data
            await fetchCurrentUser();
            const u = currentUser;
            if (!u) { el.innerHTML = '<div class="alert alert-error">Kullanƒ±cƒ± bilgisi y√ºklenemedi</div>'; return; }

            const initials = (u.full_name || u.email).split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();

            el.innerHTML = `
                <div id="profileAlert"></div>
                <div class="profile-grid">
                    <!-- Profil Bilgileri -->
                    <div class="profile-card">
                        <div class="profile-avatar">${escHtml(initials)}</div>
                        <div style="text-align:center;margin-bottom:16px">
                            <div style="font-size:18px;font-weight:600;color:#1a202c">${escHtml(u.full_name)}</div>
                            <div style="font-size:13px;color:#718096;margin-top:2px">${escHtml(u.email)}</div>
                            <span class="badge ${ROLE_BADGE_CLASS[u.role] || 'badge-gray'}" style="margin-top:8px">${ROLE_LABELS[u.role] || u.role}</span>
                        </div>
                        <div class="profile-info">
                            <div class="profile-info-row">
                                <span class="label">Hesap Durumu</span>
                                <span class="badge ${u.is_active ? 'badge-green' : 'badge-red'}">${u.is_active ? 'Aktif' : 'Pasif'}</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="label">Son Giri≈ü</span>
                                <span class="value">${u.last_login_at ? formatDate(u.last_login_at) : '-'}</span>
                            </div>
                            <div class="profile-info-row">
                                <span class="label">Kayƒ±t Tarihi</span>
                                <span class="value">${u.created_at ? formatDate(u.created_at) : '-'}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Sag Kolon: Profil D√ºzenle + Parola Deƒüi≈ütir -->
                    <div style="display:flex;flex-direction:column;gap:24px">
                        <!-- Profil D√ºzenle -->
                        <div class="profile-card">
                            <h3>Profil Bilgilerini D√ºzenle</h3>
                            <div class="form-group">
                                <label>Ad Soyad</label>
                                <input type="text" id="profileName" value="${escHtml(u.full_name)}">
                            </div>
                            <div class="form-group">
                                <label>E-posta</label>
                                <input type="email" id="profileEmail" value="${escHtml(u.email)}">
                            </div>
                            <div id="profileEditError" class="alert alert-error hidden" style="margin-top:12px"></div>
                            <div id="profileEditSuccess" class="alert alert-success hidden" style="margin-top:12px"></div>
                            <div style="margin-top:16px">
                                <button class="btn btn-primary" id="profileSaveBtn" onclick="saveProfile()">Kaydet</button>
                            </div>
                        </div>

                        <!-- Parola Deƒüi≈ütir -->
                        <div class="profile-card">
                            <h3>Parola Deƒüi≈ütir</h3>
                            <div class="form-group">
                                <label>Mevcut Parola</label>
                                <input type="password" id="profileCurrentPw" placeholder="Mevcut parolanƒ±z">
                            </div>
                            <div class="form-group">
                                <label>Yeni Parola</label>
                                <input type="password" id="profileNewPw" placeholder="En az 6 karakter">
                            </div>
                            <div class="form-group">
                                <label>Yeni Parola (Tekrar)</label>
                                <input type="password" id="profileConfirmPw" placeholder="Yeni parolayƒ± tekrar girin">
                            </div>
                            <div id="profilePwError" class="alert alert-error hidden" style="margin-top:12px"></div>
                            <div id="profilePwSuccess" class="alert alert-success hidden" style="margin-top:12px"></div>
                            <div style="margin-top:16px">
                                <button class="btn btn-primary" id="profilePwBtn" onclick="changeOwnPassword()">Parolayƒ± Deƒüi≈ütir</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveProfile() {
            const name = document.getElementById('profileName').value.trim();
            const email = document.getElementById('profileEmail').value.trim();
            const errEl = document.getElementById('profileEditError');
            const succEl = document.getElementById('profileEditSuccess');
            const btn = document.getElementById('profileSaveBtn');

            errEl.classList.add('hidden');
            succEl.classList.add('hidden');

            if (!name || !email) {
                errEl.textContent = 'Ad ve e-posta zorunlu';
                errEl.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            try {
                const resp = await fetch(`${API}/api/auth/me/profile`, {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ full_name: name, email: email })
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    errEl.textContent = err.detail || 'G√ºncelleme hatasƒ±';
                    errEl.classList.remove('hidden');
                    btn.disabled = false;
                    return;
                }
                const updated = await resp.json();
                currentUser = updated;
                updateSidebarUser();
                succEl.textContent = 'Profil ba≈üarƒ±yla g√ºncellendi';
                succEl.classList.remove('hidden');
                setTimeout(() => succEl.classList.add('hidden'), 3000);
            } catch (e) {
                errEl.textContent = 'Baƒülantƒ± hatasƒ±:' + e.message;
                errEl.classList.remove('hidden');
            }
            btn.disabled = false;
        }

        async function changeOwnPassword() {
            const current = document.getElementById('profileCurrentPw').value;
            const newPw = document.getElementById('profileNewPw').value;
            const confirmPw = document.getElementById('profileConfirmPw').value;
            const errEl = document.getElementById('profilePwError');
            const succEl = document.getElementById('profilePwSuccess');
            const btn = document.getElementById('profilePwBtn');

            errEl.classList.add('hidden');
            succEl.classList.add('hidden');

            if (!current) {
                errEl.textContent = 'Mevcut parola zorunlu';
                errEl.classList.remove('hidden');
                return;
            }
            if (newPw.length < 6) {
                errEl.textContent = 'Yeni parola en az 6 karakter olmalƒ±';
                errEl.classList.remove('hidden');
                return;
            }
            if (newPw !== confirmPw) {
                errEl.textContent = 'Yeni parolalar e≈üle≈ümiyor';
                errEl.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            try {
                const resp = await fetch(`${API}/api/auth/me/password`, {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_password: current, new_password: newPw })
                });
                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    errEl.textContent = err.detail || 'Parola deƒüi≈ütirme hatasƒ±';
                    errEl.classList.remove('hidden');
                    btn.disabled = false;
                    return;
                }
                succEl.textContent = 'Parola ba≈üarƒ±yla deƒüi≈ütirildi';
                succEl.classList.remove('hidden');
                document.getElementById('profileCurrentPw').value = '';
                document.getElementById('profileNewPw').value = '';
                document.getElementById('profileConfirmPw').value = '';
                setTimeout(() => succEl.classList.add('hidden'), 3000);
            } catch (e) {
                errEl.textContent = 'Baƒülantƒ± hatasƒ±:' + e.message;
                errEl.classList.remove('hidden');
            }
            btn.disabled = false;
        }

        // ‚îÄ‚îÄ Conversations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function renderConversations(el) {
            try {
                const resp = await fetch(`${API}/api/chat/conversations?limit=50`, { headers: authHeaders() });
                const convs = await resp.json();
                if (!convs.length) {
                    el.innerHTML = '<div style="background:white;padding:32px;border-radius:8px;text-align:center;color:#a0aec0">Hen√ºz sohbet yok. Chat sayfasƒ±ndan test edebilirsiniz.</div>';
                    return;
                }
                const statusBadge = (c) => {
                    if (c.status === 'assigned') return `<span class="badge badge-blue" style="font-size:10px">Temsilci: ${escHtml(c.assigned_agent_name || '?')}</span>`;
                    if (c.status === 'waiting') return '<span class="badge badge-yellow" style="font-size:10px">Temsilci Bekleniyor</span>';
                    if (c.mode === 'human') return '<span class="badge badge-blue" style="font-size:10px">Insan</span>';
                    return '<span class="badge badge-green" style="font-size:10px">AI Aktif</span>';
                };
                el.innerHTML = `
                    <div class="chat-panel" style="height:calc(100vh - 140px)">
                        <div class="chat-list" id="convList">${convs.map(c => `
                            <div class="chat-list-item" onclick="loadConversation('${c.id}', this)">
                                <span class="time">${new Date(c.created_at).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}</span>
                                <div class="visitor">${c.visitor_id ? c.visitor_id.substring(0, 8) + '...' : 'Kullanici'} ${statusBadge(c)}</div>
                                <div class="preview">${escHtml(c.last_message || c.channel)}</div>
                            </div>`).join('')}
                        </div>
                        <div class="chat-detail">
                            <div class="empty" id="convMessages">Sohbet secin</div>
                            <div id="convActions" style="display:none;padding:8px 16px;border-top:1px solid #e2e8f0;text-align:right">
                                <button class="btn btn-primary" onclick="escalateConversation()" id="escalateBtn" style="font-size:12px">Temsilciye Aktar</button>
                            </div>
                        </div>
                    </div>`;
            } catch (e) { el.innerHTML = `<div class="alert alert-error">${e.message}</div>`; }
        }

        let selectedConvId = null;
        async function loadConversation(id, itemEl) {
            selectedConvId = id;
            document.querySelectorAll('.chat-list-item').forEach(i => i.classList.remove('active'));
            if (itemEl) itemEl.classList.add('active');
            try {
                const resp = await fetch(`${API}/api/chat/conversations/${id}`, { headers: authHeaders() });
                const conv = await resp.json();
                const msgEl = document.getElementById('convMessages');
                msgEl.className = 'messages';
                msgEl.innerHTML = conv.messages.map(m =>
                    m.role === 'assistant'
                        ? `<div class="msg-row"><img class="msg-avatar" src="/images/logo-dark-mobile.png" alt="AI"><div class="message assistant">${renderMarkdown(m.content)}</div></div>`
                        : `<div class="msg-row user"><div class="message user">${escHtml(m.content)}</div></div>`
                ).join('') || '<div style="text-align:center;color:#a0aec0;padding:20px">Mesaj yok</div>';
                msgEl.scrollTop = msgEl.scrollHeight;
                // Show escalation button if conversation is active AI mode
                const actionsEl = document.getElementById('convActions');
                if (actionsEl) {
                    if (conv.mode === 'ai' && conv.status !== 'waiting') {
                        actionsEl.style.display = 'block';
                    } else {
                        actionsEl.style.display = 'none';
                    }
                }
            } catch (e) { console.error(e); }
        }

        async function escalateConversation() {
            if (!selectedConvId) return;
            if (!confirm('Bu sohbeti temsilci kuyruƒüuna aktarmak istiyor musunuz?')) return;
            try {
                const resp = await fetch(`${API}/api/chat/escalate/${selectedConvId}`, {
                    method: 'POST', headers: authHeaders()
                });
                if (resp.ok) {
                    alert('Sohbet temsilci kuyruƒüuna aktarildi.');
                    showPage('conversations');
                } else {
                    const err = await resp.json().catch(() => ({}));
                    alert('Hata: ' + (err.detail || resp.statusText));
                }
            } catch (e) { alert('Baglanti hatasi: ' + e.message); }
        }

        // ‚îÄ‚îÄ Canned Responses (Hazir Yanitlar) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const CR_CATEGORIES = [
            { value: 'genel', label: 'Genel', color: '#718096' },
            { value: 'sikayet', label: 'Sikayet', color: '#e53e3e' },
            { value: 'bilgi', label: 'Bilgi', color: '#3182ce' },
            { value: 'satis', label: 'Satis', color: '#38a169' },
            { value: 'takip', label: 'Takip', color: '#d69e2e' },
            { value: 'kapanis', label: 'Kapanis', color: '#805ad5' },
        ];
        const CR_VARIABLES = [
            '{{temsilci_adi}}', '{{musteri_adi}}', '{{siparis_no}}',
            '{{tarih}}', '{{saat}}', '{{firma_adi}}', '{{urun_adi}}'
        ];
        let crList = [];
        let crEditingId = null;

        // ‚îÄ‚îÄ Raporlar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const RPT_TYPES = [
            { value: 'conversations', label: 'Sohbetler' },
            { value: 'ai-performance', label: 'AI Performansi' },
            { value: 'live-support', label: 'Canli Destek' },
            { value: 'messages', label: 'Mesaj Analizi' },
            { value: 'time-analysis', label: 'Zaman Analizi' },
            { value: 'source-groups', label: 'Kaynak Gruplari' },
            { value: 'canned-responses', label: 'Hazir Yanitlar' },
        ];
        let rptCharts = [];
        const RPT_COLORS = ['#231f20','#3182ce','#38a169','#d69e2e','#e53e3e','#805ad5','#dd6b20','#319795','#b83280','#718096'];

        function rptDestroyCharts() {
            rptCharts.forEach(c => { try { c.destroy(); } catch(e) {} });
            rptCharts = [];
        }

        function rptCreateChart(canvasId, type, data, options = {}) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return null;
            const chart = new Chart(ctx, {
                type,
                data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } } },
                    ...options,
                },
            });
            rptCharts.push(chart);
            return chart;
        }

        async function renderReports(el) {
            // Default dates: last 30 days
            const now = new Date();
            const start = new Date(now); start.setDate(start.getDate() - 30);
            const ds = start.toISOString().split('T')[0];
            const de = now.toISOString().split('T')[0];

            el.innerHTML = `
                <style>
                    .rpt-controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:20px; }
                    .rpt-controls select, .rpt-controls input { padding:8px 12px; border:1px solid #e2e8f0; border-radius:6px; font-size:13px; }
                    .rpt-controls select { min-width:180px; }
                    .rpt-grid { display:grid; gap:16px; }
                    .rpt-grid-2 { grid-template-columns: 1fr 1fr; }
                    .rpt-grid-3 { grid-template-columns: 1fr 1fr 1fr; }
                    .rpt-grid-4 { grid-template-columns: repeat(4, 1fr); }
                    .rpt-card { background:white; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.06); padding:20px; }
                    .rpt-card h4 { font-size:13px; color:#718096; margin-bottom:12px; font-weight:500; }
                    .rpt-kpi { font-size:28px; font-weight:700; color:#1a202c; }
                    .rpt-kpi-sub { font-size:12px; color:#a0aec0; margin-top:2px; }
                    .rpt-chart-card { background:white; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.06); padding:20px; }
                    .rpt-chart-card h4 { font-size:14px; font-weight:600; color:#1a202c; margin-bottom:12px; }
                    .rpt-chart-wrap { position:relative; height:280px; }
                    .rpt-chart-wrap.tall { height:360px; }
                    .rpt-table { width:100%; border-collapse:collapse; font-size:13px; }
                    .rpt-table th { text-align:left; padding:8px 12px; background:#f7fafc; border-bottom:2px solid #e2e8f0; font-weight:600; color:#4a5568; font-size:12px; }
                    .rpt-table td { padding:8px 12px; border-bottom:1px solid #f0f2f5; }
                    .rpt-table tr:hover td { background:#f7fafc; }
                    .rpt-heatmap { display:grid; grid-template-columns:auto repeat(24, 1fr); gap:2px; font-size:10px; }
                    .rpt-heatmap-cell { width:100%; aspect-ratio:1; border-radius:2px; display:flex; align-items:center; justify-content:center; color:white; font-size:9px; }
                    .rpt-loading { display:flex; align-items:center; justify-content:center; padding:60px; color:#a0aec0; font-size:14px; }
                    @media (max-width:900px) { .rpt-grid-2,.rpt-grid-3,.rpt-grid-4 { grid-template-columns:1fr; } }
                </style>
                <div class="rpt-controls">
                    <select id="rptType" onchange="rptLoadReport()">
                        ${RPT_TYPES.map(t => '<option value="' + t.value + '">' + t.label + '</option>').join('')}
                    </select>
                    <input type="date" id="rptDateStart" value="${ds}" onchange="rptLoadReport()">
                    <span style="color:#a0aec0">‚Äî</span>
                    <input type="date" id="rptDateEnd" value="${de}" onchange="rptLoadReport()">
                    <button class="btn btn-primary" onclick="rptLoadReport()" style="font-size:12px;padding:8px 16px">Yenile</button>
                </div>
                <div id="rptContent">
                    <div class="rpt-loading">Yukleniyor...</div>
                </div>`;
            await rptLoadReport();
        }

        async function rptLoadReport() {
            const type = document.getElementById('rptType').value;
            const ds = document.getElementById('rptDateStart').value;
            const de = document.getElementById('rptDateEnd').value;
            const container = document.getElementById('rptContent');
            container.innerHTML = '<div class="rpt-loading">Yukleniyor...</div>';
            rptDestroyCharts();

            try {
                let url = `${API}/api/admin/reports/${type}?`;
                if (ds) url += `date_start=${ds}&`;
                if (de) url += `date_end=${de}&`;
                const resp = await fetch(url, { headers: authHeaders() });
                if (!resp.ok) throw new Error('API error: ' + resp.status);
                const data = await resp.json();

                if (type === 'conversations') rptRenderConversations(container, data);
                else if (type === 'ai-performance') rptRenderAI(container, data);
                else if (type === 'live-support') rptRenderLiveSupport(container, data);
                else if (type === 'messages') rptRenderMessages(container, data);
                else if (type === 'time-analysis') rptRenderTimeAnalysis(container, data);
                else if (type === 'source-groups') rptRenderSourceGroups(container, data);
                else if (type === 'canned-responses') rptRenderCannedUsage(container, data);
            } catch (e) {
                container.innerHTML = '<div class="rpt-loading" style="color:#e53e3e">Rapor yuklenemedi: ' + escHtml(e.message) + '</div>';
            }
        }

        // ‚îÄ‚îÄ Conversations Report ‚îÄ‚îÄ
        function rptRenderConversations(el, data) {
            const s = data.summary;
            el.innerHTML = `
                <div class="rpt-grid rpt-grid-4" style="margin-bottom:16px">
                    <div class="rpt-card"><h4>Toplam Sohbet</h4><div class="rpt-kpi">${s.total_conversations}</div></div>
                    <div class="rpt-card"><h4>Aktif Sohbet</h4><div class="rpt-kpi">${s.active_conversations}</div></div>
                    <div class="rpt-card"><h4>Tekil Ziyaretci</h4><div class="rpt-kpi">${s.unique_visitors}</div></div>
                    <div class="rpt-card"><h4>Ort. Mesaj/Sohbet</h4><div class="rpt-kpi">${s.avg_messages_per_conv}</div></div>
                </div>
                <div class="rpt-grid rpt-grid-2" style="margin-bottom:16px">
                    <div class="rpt-card"><h4>Toplam Mesaj</h4><div class="rpt-kpi">${s.total_messages}</div><div class="rpt-kpi-sub">${s.user_messages} kullanici mesaji</div></div>
                    <div class="rpt-card"><h4>Gunluk Ortalama</h4><div class="rpt-kpi">${data.daily_trend.length > 0 ? Math.round(s.total_conversations / data.daily_trend.length) : 0}</div><div class="rpt-kpi-sub">sohbet/gun</div></div>
                </div>
                <div class="rpt-grid rpt-grid-2" style="margin-bottom:16px">
                    <div class="rpt-chart-card"><h4>Gunluk Sohbet Trendi</h4><div class="rpt-chart-wrap"><canvas id="rptConvDaily"></canvas></div></div>
                    <div class="rpt-chart-card"><h4>Durum Dagilimi</h4><div class="rpt-chart-wrap"><canvas id="rptConvStatus"></canvas></div></div>
                </div>
                <div class="rpt-grid rpt-grid-2">
                    <div class="rpt-chart-card"><h4>Kanal Dagilimi</h4><div class="rpt-chart-wrap"><canvas id="rptConvChannel"></canvas></div></div>
                </div>`;

            rptCreateChart('rptConvDaily', 'line', {
                labels: data.daily_trend.map(d => d.date.substring(5)),
                datasets: [{ label: 'Sohbet', data: data.daily_trend.map(d => d.count), borderColor: RPT_COLORS[0], backgroundColor: RPT_COLORS[0] + '15', fill: true, tension: 0.3 }]
            }, { scales: { y: { beginAtZero: true } } });

            rptCreateChart('rptConvStatus', 'doughnut', {
                labels: data.status_distribution.map(d => d.status),
                datasets: [{ data: data.status_distribution.map(d => d.count), backgroundColor: RPT_COLORS }]
            });

            if (data.channel_distribution.length) {
                rptCreateChart('rptConvChannel', 'pie', {
                    labels: data.channel_distribution.map(d => d.channel),
                    datasets: [{ data: data.channel_distribution.map(d => d.count), backgroundColor: RPT_COLORS.slice(2) }]
                });
            }
        }

        // ‚îÄ‚îÄ AI Performance Report ‚îÄ‚îÄ
        function rptRenderAI(el, data) {
            const s = data.summary;
            el.innerHTML = `
                <div class="rpt-grid rpt-grid-4" style="margin-bottom:16px">
                    <div class="rpt-card"><h4>Toplam Sohbet</h4><div class="rpt-kpi">${s.total_conversations}</div></div>
                    <div class="rpt-card"><h4>AI Cozumledi</h4><div class="rpt-kpi">${s.ai_handled}</div><div class="rpt-kpi-sub">${s.ai_resolution_rate}% cozum orani</div></div>
                    <div class="rpt-card"><h4>Insana Yonlendi</h4><div class="rpt-kpi">${s.escalated_to_human}</div></div>
                    <div class="rpt-card"><h4>AI Mesajlari</h4><div class="rpt-kpi">${s.ai_messages}</div><div class="rpt-kpi-sub">${s.total_tokens.toLocaleString()} token</div></div>
                </div>
                <div class="rpt-grid rpt-grid-2" style="margin-bottom:16px">
                    <div class="rpt-chart-card"><h4>Gunluk AI vs Insan</h4><div class="rpt-chart-wrap"><canvas id="rptAIDaily"></canvas></div></div>
                    <div class="rpt-chart-card"><h4>AI Cozum Orani</h4><div class="rpt-chart-wrap"><canvas id="rptAIRatio"></canvas></div></div>
                </div>
                <div class="rpt-chart-card"><h4>Niyet (Intent) Dagilimi</h4>
                    <div class="rpt-chart-wrap tall"><canvas id="rptAIIntent"></canvas></div>
                </div>`;

            rptCreateChart('rptAIDaily', 'bar', {
                labels: data.daily_mode.map(d => d.date.substring(5)),
                datasets: [
                    { label: 'AI', data: data.daily_mode.map(d => d.ai), backgroundColor: RPT_COLORS[1] },
                    { label: 'Insan', data: data.daily_mode.map(d => d.human), backgroundColor: RPT_COLORS[4] },
                ]
            }, { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } });

            rptCreateChart('rptAIRatio', 'doughnut', {
                labels: ['AI Cozumledi', 'Insana Yonlendi'],
                datasets: [{ data: [s.ai_handled, s.escalated_to_human], backgroundColor: [RPT_COLORS[2], RPT_COLORS[4]] }]
            });

            if (data.intent_distribution.length) {
                rptCreateChart('rptAIIntent', 'bar', {
                    labels: data.intent_distribution.map(d => d.intent || 'bilinmeyen'),
                    datasets: [{ label: 'Sayi', data: data.intent_distribution.map(d => d.count), backgroundColor: RPT_COLORS[5] }]
                }, { indexAxis: 'y', scales: { x: { beginAtZero: true } } });
            }
        }

        // ‚îÄ‚îÄ Live Support Report ‚îÄ‚îÄ
        function rptRenderLiveSupport(el, data) {
            const s = data.summary;
            const avgResp = s.avg_first_response_seconds || 0;
            const avgRespLabel = avgResp > 60 ? Math.round(avgResp / 60) + ' dk' : Math.round(avgResp) + ' sn';
            el.innerHTML = `
                <div class="rpt-grid rpt-grid-3" style="margin-bottom:16px">
                    <div class="rpt-card"><h4>Insan Devralan Sohbet</h4><div class="rpt-kpi">${s.total_human_conversations}</div></div>
                    <div class="rpt-card"><h4>Temsilci Mesajlari</h4><div class="rpt-kpi">${s.total_human_messages}</div></div>
                    <div class="rpt-card"><h4>Aktif Temsilci</h4><div class="rpt-kpi">${s.active_agents}</div></div>
                </div>
                <div class="rpt-grid rpt-grid-3" style="margin-bottom:16px">
                    <div class="rpt-card"><h4>Ort. Ilk Yanit Suresi</h4><div class="rpt-kpi">${avgRespLabel}</div></div>
                    <div class="rpt-card"><h4>SLA Uyum Orani</h4><div class="rpt-kpi" style="color:${(s.sla_compliance_rate || 100) >= 90 ? '#38a169' : '#e53e3e'}">${s.sla_compliance_rate || 100}%</div></div>
                    <div class="rpt-card"><h4>SLA Ihlali</h4><div class="rpt-kpi" style="color:${(s.sla_breached || 0) > 0 ? '#e53e3e' : '#38a169'}">${s.sla_breached || 0}</div></div>
                </div>
                <div class="rpt-grid rpt-grid-2" style="margin-bottom:16px">
                    <div class="rpt-chart-card"><h4>Gunluk Canli Destek</h4><div class="rpt-chart-wrap"><canvas id="rptLSDaily"></canvas></div></div>
                    <div class="rpt-chart-card"><h4>Temsilci Performansi</h4>
                        <table class="rpt-table">
                            <thead><tr><th>Temsilci</th><th>Sohbet</th><th>Mesaj</th></tr></thead>
                            <tbody>${data.agent_leaderboard.length ? data.agent_leaderboard.map(a => '<tr><td>' + escHtml(a.name || '-') + '</td><td><strong>' + a.conversations + '</strong></td><td>' + a.messages + '</td></tr>').join('') : '<tr><td colspan="3" style="text-align:center;color:#a0aec0">Veri yok</td></tr>'}</tbody>
                        </table>
                    </div>
                </div>`;

            rptCreateChart('rptLSDaily', 'line', {
                labels: data.daily_trend.map(d => d.date.substring(5)),
                datasets: [{ label: 'Canli Destek', data: data.daily_trend.map(d => d.count), borderColor: RPT_COLORS[4], backgroundColor: RPT_COLORS[4] + '15', fill: true, tension: 0.3 }]
            }, { scales: { y: { beginAtZero: true } } });
        }

        // ‚îÄ‚îÄ Messages Report ‚îÄ‚îÄ
        function rptRenderMessages(el, data) {
            const s = data.summary;
            const byRole = s.by_role || {};
            const bySender = s.by_sender_type || {};
            el.innerHTML = `
                <div class="rpt-grid rpt-grid-4" style="margin-bottom:16px">
                    <div class="rpt-card"><h4>Toplam Mesaj</h4><div class="rpt-kpi">${s.total_messages}</div></div>
                    <div class="rpt-card"><h4>Kullanici</h4><div class="rpt-kpi">${byRole.user || 0}</div></div>
                    <div class="rpt-card"><h4>Asistan</h4><div class="rpt-kpi">${byRole.assistant || 0}</div></div>
                    <div class="rpt-card"><h4>AI Mesaj</h4><div class="rpt-kpi">${bySender.ai || 0}</div><div class="rpt-kpi-sub">${bySender.human || 0} insan mesaji</div></div>
                </div>
                <div class="rpt-grid rpt-grid-2" style="margin-bottom:16px">
                    <div class="rpt-chart-card"><h4>Gunluk Mesaj Hacmi</h4><div class="rpt-chart-wrap"><canvas id="rptMsgDaily"></canvas></div></div>
                    <div class="rpt-chart-card"><h4>Gonderen Tipi</h4><div class="rpt-chart-wrap"><canvas id="rptMsgSender"></canvas></div></div>
                </div>
                <div class="rpt-chart-card"><h4>Gunluk Token Kullanimi</h4><div class="rpt-chart-wrap"><canvas id="rptMsgTokens"></canvas></div></div>`;

            rptCreateChart('rptMsgDaily', 'line', {
                labels: data.daily_volume.map(d => d.date.substring(5)),
                datasets: [
                    { label: 'Kullanici', data: data.daily_volume.map(d => d.user), borderColor: RPT_COLORS[1], tension: 0.3 },
                    { label: 'Asistan', data: data.daily_volume.map(d => d.assistant), borderColor: RPT_COLORS[2], tension: 0.3 },
                ]
            }, { scales: { y: { beginAtZero: true } } });

            const senderLabels = Object.keys(bySender);
            const senderData = Object.values(bySender);
            rptCreateChart('rptMsgSender', 'doughnut', {
                labels: senderLabels, datasets: [{ data: senderData, backgroundColor: RPT_COLORS }]
            });

            if (data.daily_tokens.length) {
                rptCreateChart('rptMsgTokens', 'bar', {
                    labels: data.daily_tokens.map(d => d.date.substring(5)),
                    datasets: [{ label: 'Token', data: data.daily_tokens.map(d => d.tokens), backgroundColor: RPT_COLORS[3] + '80' }]
                }, { scales: { y: { beginAtZero: true } } });
            }
        }

        // ‚îÄ‚îÄ Time Analysis Report ‚îÄ‚îÄ
        function rptRenderTimeAnalysis(el, data) {
            el.innerHTML = `
                <div class="rpt-grid rpt-grid-2" style="margin-bottom:16px">
                    <div class="rpt-chart-card"><h4>Saatlik Dagilim</h4><div class="rpt-chart-wrap"><canvas id="rptTimeHourly"></canvas></div></div>
                    <div class="rpt-chart-card"><h4>Gun Bazli Dagilim</h4><div class="rpt-chart-wrap"><canvas id="rptTimeWeekday"></canvas></div></div>
                </div>
                <div class="rpt-chart-card"><h4>Yogunluk Haritasi (Gun x Saat)</h4>
                    <div id="rptHeatmapContainer" style="overflow-x:auto;padding:8px 0"></div>
                </div>`;

            // Fill all 24 hours
            const hourData = Array(24).fill(0);
            data.hourly.forEach(h => { hourData[h.hour] = h.count; });
            rptCreateChart('rptTimeHourly', 'bar', {
                labels: Array.from({length:24}, (_,i) => String(i).padStart(2,'0') + ':00'),
                datasets: [{ label: 'Sohbet', data: hourData, backgroundColor: RPT_COLORS[1] + '90' }]
            }, { scales: { y: { beginAtZero: true } } });

            rptCreateChart('rptTimeWeekday', 'bar', {
                labels: data.weekday.map(d => d.day),
                datasets: [{ label: 'Sohbet', data: data.weekday.map(d => d.count), backgroundColor: RPT_COLORS[2] + '90' }]
            }, { scales: { y: { beginAtZero: true } } });

            // Heatmap
            const maxVal = Math.max(...data.heatmap.map(h => h.count), 1);
            const days = ['Pzt','Sal','Car','Per','Cum','Cmt','Paz'];
            const heatGrid = {};
            data.heatmap.forEach(h => { heatGrid[h.day_num + '_' + h.hour] = h.count; });

            let heatHtml = '<div class="rpt-heatmap">';
            heatHtml += '<div></div>';
            for (let h = 0; h < 24; h++) heatHtml += '<div style="text-align:center;font-size:9px;color:#a0aec0">' + String(h).padStart(2,'0') + '</div>';
            for (let d = 1; d <= 7; d++) {
                heatHtml += '<div style="padding:2px 6px;font-size:10px;color:#4a5568;white-space:nowrap">' + days[d-1] + '</div>';
                for (let h = 0; h < 24; h++) {
                    const val = heatGrid[d + '_' + h] || 0;
                    const intensity = val / maxVal;
                    const bg = val === 0 ? '#f0f2f5' : `rgba(49,130,206,${0.15 + intensity * 0.85})`;
                    const textColor = intensity > 0.5 ? 'white' : '#4a5568';
                    heatHtml += '<div class="rpt-heatmap-cell" style="background:' + bg + ';color:' + textColor + '">' + (val || '') + '</div>';
                }
            }
            heatHtml += '</div>';
            document.getElementById('rptHeatmapContainer').innerHTML = heatHtml;
        }

        // ‚îÄ‚îÄ Source Groups Report ‚îÄ‚îÄ
        function rptRenderSourceGroups(el, data) {
            el.innerHTML = `
                <div class="rpt-chart-card" style="margin-bottom:16px"><h4>Kaynak Grubu Karsilastirmasi</h4>
                    <table class="rpt-table">
                        <thead><tr><th>Kaynak Grubu</th><th>Sohbet</th><th>Ziyaretci</th><th>Mesaj</th></tr></thead>
                        <tbody>${data.summary.length ? data.summary.map(g => '<tr><td><strong>' + escHtml(g.group) + '</strong></td><td>' + g.conversations + '</td><td>' + g.visitors + '</td><td>' + g.messages + '</td></tr>').join('') : '<tr><td colspan="4" style="text-align:center;color:#a0aec0">Veri yok</td></tr>'}</tbody>
                    </table>
                </div>
                <div class="rpt-grid rpt-grid-2">
                    <div class="rpt-chart-card"><h4>Sohbet Dagilimi</h4><div class="rpt-chart-wrap"><canvas id="rptSGPie"></canvas></div></div>
                    <div class="rpt-chart-card"><h4>Gunluk Trend</h4><div class="rpt-chart-wrap"><canvas id="rptSGDaily"></canvas></div></div>
                </div>`;

            if (data.summary.length) {
                rptCreateChart('rptSGPie', 'doughnut', {
                    labels: data.summary.map(g => g.group),
                    datasets: [{ data: data.summary.map(g => g.conversations), backgroundColor: RPT_COLORS }]
                });
            }

            // Group daily data by source group
            const groups = [...new Set(data.daily_trend.map(d => d.group))];
            const dates = [...new Set(data.daily_trend.map(d => d.date))].sort();
            if (dates.length && groups.length) {
                const datasets = groups.map((g, i) => ({
                    label: g, borderColor: RPT_COLORS[i % RPT_COLORS.length], tension: 0.3,
                    data: dates.map(dt => { const found = data.daily_trend.find(r => r.date === dt && r.group === g); return found ? found.count : 0; })
                }));
                rptCreateChart('rptSGDaily', 'line', { labels: dates.map(d => d.substring(5)), datasets }, { scales: { y: { beginAtZero: true } } });
            }
        }

        // ‚îÄ‚îÄ Canned Responses Usage Report ‚îÄ‚îÄ
        function rptRenderCannedUsage(el, data) {
            const s = data.summary;
            el.innerHTML = `
                <div class="rpt-grid rpt-grid-2" style="margin-bottom:16px">
                    <div class="rpt-card"><h4>Toplam Sablon</h4><div class="rpt-kpi">${s.total_templates}</div></div>
                    <div class="rpt-card"><h4>Toplam Kullanim</h4><div class="rpt-kpi">${s.total_usage}</div></div>
                </div>
                <div class="rpt-grid rpt-grid-2" style="margin-bottom:16px">
                    <div class="rpt-chart-card"><h4>Kategori Bazli Kullanim</h4><div class="rpt-chart-wrap"><canvas id="rptCRCat"></canvas></div></div>
                    <div class="rpt-chart-card"><h4>En Cok Kullanilan</h4>
                        <div style="max-height:300px;overflow-y:auto">
                        <table class="rpt-table">
                            <thead><tr><th>Sablon</th><th>Kategori</th><th>Kullanim</th></tr></thead>
                            <tbody>${data.top_used.map(t => '<tr><td>' + escHtml(t.title) + '</td><td><span class="badge badge-gray" style="font-size:10px">' + escHtml(t.category) + '</span></td><td><strong>' + t.usage_count + '</strong></td></tr>').join('')}</tbody>
                        </table>
                        </div>
                    </div>
                </div>`;

            if (data.by_category.length) {
                rptCreateChart('rptCRCat', 'bar', {
                    labels: data.by_category.map(c => c.category),
                    datasets: [
                        { label: 'Sablon Sayisi', data: data.by_category.map(c => c.template_count), backgroundColor: RPT_COLORS[1] },
                        { label: 'Kullanim', data: data.by_category.map(c => c.total_usage), backgroundColor: RPT_COLORS[3] },
                    ]
                }, { scales: { y: { beginAtZero: true } } });
            }
        }

        async function renderCannedResponses(el) {
            el.innerHTML = `
                <div id="crAlert"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
                    <div style="background:#fff;border-radius:10px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.06)">
                        <h3 style="margin-bottom:14px;font-size:15px" id="crFormTitle">Yeni Hazir Yanit</h3>
                        <div style="display:flex;flex-direction:column;gap:12px">
                            <div>
                                <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Baslik *</label>
                                <input id="crTitle" type="text" placeholder="Orn: Garanti Bilgisi"
                                    style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px">
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px">
                                <div>
                                    <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Kategori</label>
                                    <select id="crCategory" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px">
                                        ${CR_CATEGORIES.map(c => '<option value="' + c.value + '">' + c.label + '</option>').join('')}
                                    </select>
                                </div>
                                <div>
                                    <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Kapsam</label>
                                    <select id="crScope" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px">
                                        <option value="global">Genel (Herkes)</option>
                                        <option value="personal">Kisisel (Sadece Ben)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Kisayol</label>
                                    <input id="crShortcut" type="text" placeholder="/ornek" maxlength="20"
                                        style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;font-family:monospace">
                                </div>
                            </div>
                            <div>
                                <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Icerik *</label>
                                <div style="display:flex;gap:4px;margin-bottom:6px;flex-wrap:wrap">
                                    ${CR_VARIABLES.map(v => '<button class="btn" style="font-size:11px;padding:2px 8px;background:#f0f2f5" onclick="crInsertVar(\'' + v + '\')">' + v + '</button>').join('')}
                                </div>
                                <textarea id="crContent" rows="6" placeholder="Sablon icerigini yazin..."
                                    style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;resize:vertical;font-family:inherit;line-height:1.5"></textarea>
                            </div>
                            <div style="display:flex;gap:8px;justify-content:flex-end">
                                <button class="btn" onclick="crResetForm()" style="font-size:13px">Iptal</button>
                                <button class="btn btn-primary" onclick="crSave()" style="font-size:13px">Kaydet</button>
                            </div>
                        </div>
                    </div>
                    <div style="background:#fff;border-radius:10px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.06)">
                        <h3 style="margin-bottom:8px;font-size:15px">Onizleme</h3>
                        <div id="crPreview" style="min-height:200px;background:#f7fafc;border-radius:8px;padding:16px;font-size:13px;line-height:1.6;color:#4a5568;white-space:pre-wrap;overflow-y:auto;max-height:400px">Sablon icerigini yazmaya baslayin...</div>
                    </div>
                </div>
                <div style="background:#fff;border-radius:10px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.06)">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                        <h3 style="font-size:15px">Sablon Listesi</h3>
                        <div style="display:flex;gap:8px;align-items:center">
                            <input id="crSearch" type="text" placeholder="Ara..." oninput="crFilter()"
                                style="padding:6px 12px;border:1px solid #ddd;border-radius:6px;font-size:13px;width:200px">
                            <select id="crCatFilter" onchange="crFilter()" style="padding:6px 12px;border:1px solid #ddd;border-radius:6px;font-size:13px">
                                <option value="">Tum Kategoriler</option>
                                ${CR_CATEGORIES.map(c => '<option value="' + c.value + '">' + c.label + '</option>').join('')}
                            </select>
                        </div>
                    </div>
                    <div id="crListContainer" style="max-height:400px;overflow-y:auto">Yukleniyor...</div>
                </div>`;
            // Live preview
            document.getElementById('crContent').addEventListener('input', function() {
                document.getElementById('crPreview').textContent = this.value || 'Sablon icerigini yazmaya baslayin...';
            });
            await crLoadList();
        }

        function crInsertVar(varName) {
            const ta = document.getElementById('crContent');
            const start = ta.selectionStart;
            const end = ta.selectionEnd;
            const text = ta.value;
            ta.value = text.substring(0, start) + varName + text.substring(end);
            ta.selectionStart = ta.selectionEnd = start + varName.length;
            ta.focus();
            document.getElementById('crPreview').textContent = ta.value;
        }

        async function crLoadList() {
            try {
                const resp = await fetch(`${API}/api/canned-responses`, { headers: authHeaders() });
                crList = await resp.json();
                crRenderList(crList);
            } catch (e) {
                document.getElementById('crListContainer').innerHTML = '<div style="color:#e53e3e">Yuklenemedi: ' + e.message + '</div>';
            }
        }

        function crFilter() {
            const q = (document.getElementById('crSearch').value || '').toLowerCase();
            const cat = document.getElementById('crCatFilter').value;
            const filtered = crList.filter(cr => {
                if (cat && cr.category !== cat) return false;
                if (q && !cr.title.toLowerCase().includes(q) && !cr.content.toLowerCase().includes(q)) return false;
                return true;
            });
            crRenderList(filtered);
        }

        function crCatBadge(cat) {
            const c = CR_CATEGORIES.find(x => x.value === cat);
            return c ? '<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;background:' + c.color + '20;color:' + c.color + '">' + c.label + '</span>' : cat;
        }

        function crRenderList(items) {
            const el = document.getElementById('crListContainer');
            if (!items.length) {
                el.innerHTML = '<div style="text-align:center;color:#a0aec0;padding:20px">Sablon bulunamadi</div>';
                return;
            }
            el.innerHTML = '<table class="data-table" style="width:100%"><thead><tr><th>Baslik</th><th>Kategori</th><th>Kapsam</th><th>Kisayol</th><th>Kullanim</th><th>Islem</th></tr></thead><tbody>' +
                items.map(cr => `<tr>
                    <td style="font-weight:500">${escHtml(cr.title)}</td>
                    <td>${crCatBadge(cr.category)}</td>
                    <td><span class="badge ${cr.scope === 'global' ? 'badge-blue' : 'badge-gray'}" style="font-size:10px">${cr.scope === 'global' ? 'Genel' : 'Kisisel'}</span></td>
                    <td style="font-family:monospace;font-size:12px">${escHtml(cr.shortcut || '-')}</td>
                    <td style="text-align:center">${cr.usage_count}</td>
                    <td>
                        <button class="btn" style="font-size:11px;padding:3px 8px" onclick="crEdit('${cr.id}')">Duzenle</button>
                        <button class="btn" style="font-size:11px;padding:3px 8px;color:#e53e3e" onclick="crDelete('${cr.id}')">Sil</button>
                    </td>
                </tr>`).join('') + '</tbody></table>';
        }

        async function crSave() {
            const title = document.getElementById('crTitle').value.trim();
            const content = document.getElementById('crContent').value.trim();
            const category = document.getElementById('crCategory').value;
            const scope = document.getElementById('crScope').value;
            const shortcut = document.getElementById('crShortcut').value.trim() || null;

            if (!title || !content) {
                showAlert('crAlert', 'error', 'Baslik ve icerik zorunludur.');
                return;
            }

            try {
                const url = crEditingId
                    ? `${API}/api/canned-responses/${crEditingId}`
                    : `${API}/api/canned-responses`;
                const method = crEditingId ? 'PUT' : 'POST';
                const resp = await fetch(url, {
                    method,
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, content, category, scope, shortcut })
                });
                if (resp.ok) {
                    showAlert('crAlert', 'success', crEditingId ? 'Sablon guncellendi.' : 'Sablon olusturuldu.');
                    crResetForm();
                    await crLoadList();
                } else {
                    const err = await resp.json().catch(() => ({}));
                    showAlert('crAlert', 'error', 'Hata: ' + (err.detail || resp.statusText));
                }
            } catch (e) {
                showAlert('crAlert', 'error', 'Baglanti hatasi: ' + e.message);
            }
        }

        function crEdit(id) {
            const cr = crList.find(c => c.id === id);
            if (!cr) return;
            crEditingId = id;
            document.getElementById('crFormTitle').textContent = 'Sablonu Duzenle';
            document.getElementById('crTitle').value = cr.title;
            document.getElementById('crContent').value = cr.content;
            document.getElementById('crCategory').value = cr.category;
            document.getElementById('crScope').value = cr.scope;
            document.getElementById('crShortcut').value = cr.shortcut || '';
            document.getElementById('crPreview').textContent = cr.content;
        }

        async function crDelete(id) {
            if (!confirm('Bu sablonu silmek istiyor musunuz?')) return;
            try {
                const resp = await fetch(`${API}/api/canned-responses/${id}`, {
                    method: 'DELETE', headers: authHeaders()
                });
                if (resp.ok) {
                    showAlert('crAlert', 'success', 'Sablon silindi.');
                    await crLoadList();
                } else {
                    const err = await resp.json().catch(() => ({}));
                    showAlert('crAlert', 'error', 'Hata: ' + (err.detail || resp.statusText));
                }
            } catch (e) {
                showAlert('crAlert', 'error', 'Baglanti hatasi: ' + e.message);
            }
        }

        function crResetForm() {
            crEditingId = null;
            document.getElementById('crFormTitle').textContent = 'Yeni Hazir Yanit';
            document.getElementById('crTitle').value = '';
            document.getElementById('crContent').value = '';
            document.getElementById('crCategory').value = 'genel';
            document.getElementById('crScope').value = 'global';
            document.getElementById('crShortcut').value = '';
            document.getElementById('crPreview').textContent = 'Sablon icerigini yazmaya baslayin...';
        }

        // ‚îÄ‚îÄ Live Support (Canli Destek) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        let lsNotifWs = null;
        let lsAgentWs = null;
        let lsActiveConvId = null;

        async function renderLiveSupport(el) {
            el.innerHTML = `
                <style>
                    .ls-panel { display:flex; gap:16px; height:calc(100vh - 140px); }
                    .ls-sidebar { width:340px; display:flex; flex-direction:column; gap:0; overflow-y:auto; background:white; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.06); }
                    .ls-section { }
                    .ls-section-header { padding:12px 16px; border-bottom:1px solid #e2e8f0; font-weight:600; font-size:13px; display:flex; justify-content:space-between; align-items:center; }
                    .ls-section-body { overflow-y:auto; }
                    .ls-online-dot { display:inline-block; width:8px; height:8px; border-radius:50%; background:#48bb78; margin-right:4px; flex-shrink:0; }
                    .ls-online-dot.offline { background:#cbd5e0; }
                    .ls-item .ls-status-tags { display:flex; gap:4px; margin-top:3px; }
                    .ls-filter-btn { background:#f0f2f5; border:1px solid #e2e8f0; border-radius:4px; cursor:pointer; color:#4a5568; }
                    .ls-filter-btn:hover { background:#e2e8f0; }
                    .ls-filter-btn.active { background:#231f20; color:white; border-color:#231f20; }
                    .ls-item { padding:10px 16px; border-bottom:1px solid #f0f2f5; cursor:pointer; transition:background 0.15s; }
                    .ls-item:hover { background:#f7fafc; }
                    .ls-item.active { background:#ebf8ff; border-left:3px solid #231f20; }
                    .ls-item .ls-visitor { font-size:13px; font-weight:500; color:#1a202c; }
                    .ls-item .ls-preview { font-size:12px; color:#a0aec0; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
                    .ls-item .ls-meta { font-size:11px; color:#cbd5e0; margin-top:4px; display:flex; gap:8px; align-items:center; }
                    .ls-chat { flex:1; background:white; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.06); display:flex; flex-direction:column; }
                    .ls-chat-header { padding:12px 16px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; }
                    .ls-chat-messages { flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:8px; }
                    .ls-chat-input { padding:12px 16px; border-top:1px solid #e2e8f0; display:flex; gap:8px; }
                    .ls-chat-input input { flex:1; padding:8px 12px; border:1px solid #e2e8f0; border-radius:6px; font-size:13px; }
                    .ls-empty { display:flex; align-items:center; justify-content:center; height:100%; color:#a0aec0; font-size:14px; }
                    .ls-system-msg { text-align:center; padding:8px; font-size:12px; color:#718096; font-style:italic; }
                    .ls-chat-messages .msg-row { display:flex; align-items:flex-start; gap:8px; margin-bottom:8px; }
                    .ls-chat-messages .msg-row.user { justify-content:flex-end; }
                    .ls-chat-messages .msg-avatar { width:28px; height:28px; border-radius:50%; flex-shrink:0; margin-top:2px; object-fit:contain; background:white; padding:2px; }
                    .ls-chat-messages .message { max-width:70%; padding:8px 12px; border-radius:10px; font-size:13px; line-height:1.5; }
                    .ls-chat-messages .message.user { background:#231f20; color:white; border-bottom-right-radius:2px; white-space:pre-wrap; }
                    .ls-chat-messages .message.assistant { background:#f0f2f5; color:#1a202c; border-bottom-left-radius:2px; }
                </style>
                <div class="ls-panel">
                    <div class="ls-sidebar">
                        <div class="ls-section" style="display:flex;flex-direction:column;height:100%">
                            <div class="ls-section-header">
                                <span>Sohbetler</span>
                                <span id="lsAllCount" class="badge badge-gray" style="font-size:10px">0</span>
                            </div>
                            <div id="lsAgentStatusBar" style="padding:6px 10px;border-bottom:1px solid #e2e8f0;display:flex;gap:6px;flex-wrap:wrap;font-size:11px"></div>
                            <div style="padding:6px 10px;border-bottom:1px solid #e2e8f0;display:flex;gap:4px;flex-wrap:wrap">
                                <button class="btn ls-filter-btn active" data-filter="all" onclick="lsSetFilter('all')" style="font-size:11px;padding:3px 8px">Tumu</button>
                                <button class="btn ls-filter-btn" data-filter="online" onclick="lsSetFilter('online')" style="font-size:11px;padding:3px 8px">&#x1F7E2; Cevrimici</button>
                                <button class="btn ls-filter-btn" data-filter="waiting" onclick="lsSetFilter('waiting')" style="font-size:11px;padding:3px 8px">&#x23F3; Bekleyen</button>
                                <button class="btn ls-filter-btn" data-filter="mine" onclick="lsSetFilter('mine')" style="font-size:11px;padding:3px 8px">&#x1F464; Benim</button>
                            </div>
                            <div class="ls-section-body" id="lsAllList" style="flex:1;overflow-y:auto">
                                <div style="padding:16px;text-align:center;color:#a0aec0;font-size:13px">Yukleniyor...</div>
                            </div>
                        </div>
                    </div>
                    <div class="ls-chat">
                        <div class="ls-chat-header" id="lsChatHeader" style="display:none;flex-direction:column;gap:4px">
                            <div style="display:flex;align-items:center;gap:8px;width:100%">
                                <span id="lsChatTitle" style="font-weight:600;font-size:14px;flex:1"></span>
                                <button class="btn" onclick="lsToggleNoteInput()" style="font-size:12px;background:#fefce8;color:#854d0e;border:1px solid #fde68a" title="Dahili Not">&#x1F4DD; Not</button>
                                <button class="btn" onclick="lsToggleTagEditor()" style="font-size:12px;background:#f0fdf4;color:#166534;border:1px solid #bbf7d0" title="Etiket">&#x1F3F7; Etiket</button>
                                <button class="btn" onclick="lsBlockVisitor()" style="font-size:12px;background:#fef2f2;color:#991b1b;border:1px solid #fecaca" title="Ziyaretciyi Engelle">&#x26D4; Engelle</button>
                                <button class="btn" onclick="lsCloseConversation()" style="font-size:12px;background:#e2e8f0;color:#4a5568">Kapat</button>
                                <button class="btn" id="lsReleaseBtn" onclick="lsRelease()" style="font-size:12px;background:#fed7d7;color:#9b2c2c">Sohbeti Birak</button>
                            </div>
                            <div id="lsTagDisplay" style="display:none;flex-wrap:wrap;gap:4px;padding:2px 0"></div>
                            <div id="lsTagEditor" style="display:none;gap:6px;align-items:center;padding:4px 0">
                                <input type="text" id="lsTagInput" placeholder="Etiket ekle (Enter)" onkeydown="if(event.key==='Enter'){lsAddTag();event.preventDefault()}" style="flex:1;padding:4px 8px;border:1px solid #d1d5db;border-radius:6px;font-size:12px">
                                <button class="btn" onclick="lsAddTag()" style="font-size:11px;padding:3px 8px;background:#dcfce7;color:#166534">Ekle</button>
                            </div>
                            <div id="lsNoteInput" style="display:none;gap:6px;align-items:center;padding:4px 0">
                                <input type="text" id="lsNoteText" placeholder="Dahili not yaz... (sadece temsilciler gorur)" onkeydown="if(event.key==='Enter'){lsSendNote();event.preventDefault()}" style="flex:1;padding:4px 8px;border:1px solid #fde68a;border-radius:6px;font-size:12px;background:#fffbeb">
                                <button class="btn" onclick="lsSendNote()" style="font-size:11px;padding:3px 8px;background:#fef3c7;color:#854d0e">Kaydet</button>
                            </div>
                        </div>
                        <div class="ls-chat-messages" id="lsChatMessages">
                            <div class="ls-empty">Bir sohbet secin veya kuyruktan devralin</div>
                        </div>
                        <div id="lsCannedPanel" style="display:none;border-top:1px solid #e2e8f0;max-height:280px;overflow:hidden;flex-direction:column">
                            <div style="padding:8px 12px;display:flex;gap:6px;align-items:center;border-bottom:1px solid #f0f2f5">
                                <input type="text" id="lsCannedSearch" placeholder="Sablon ara..." oninput="lsCannedFilter()"
                                    style="flex:1;padding:5px 10px;border:1px solid #ddd;border-radius:6px;font-size:12px">
                                <select id="lsCannedCatFilter" onchange="lsCannedFilter()" style="padding:5px 8px;border:1px solid #ddd;border-radius:6px;font-size:12px">
                                    <option value="">Tumu</option>
                                </select>
                                <button onclick="lsToggleCanned()" style="background:none;border:none;cursor:pointer;font-size:16px;color:#a0aec0" title="Kapat">&#x2715;</button>
                            </div>
                            <div id="lsCannedList" style="flex:1;overflow-y:auto;max-height:230px"></div>
                        </div>
                        <div id="lsShortcutHint" style="display:none;padding:4px 12px;background:#fffbeb;border-top:1px solid #fef3c7;font-size:12px;color:#92400e;cursor:pointer" onclick="lsApplyShortcutHint()"></div>
                        <div id="lsAttachPreview" style="display:none;padding:8px 12px;background:#f0f9ff;border-top:1px solid #bae6fd;font-size:12px"></div>
                        <div class="ls-chat-input" id="lsChatInput" style="display:none">
                            <button onclick="lsToggleCanned()" style="background:none;border:1px solid #ddd;border-radius:6px;padding:6px 8px;cursor:pointer;font-size:16px;flex-shrink:0" title="Hazir Yanitlar">&#x1F4CB;</button>
                            <button onclick="document.getElementById('lsFileInput').click()" style="background:none;border:1px solid #ddd;border-radius:6px;padding:6px 8px;cursor:pointer;font-size:16px;flex-shrink:0" title="Dosya Ekle">&#x1F4CE;</button>
                            <input type="file" id="lsFileInput" style="display:none" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx" onchange="lsHandleFileSelect(event)">
                            <input type="text" id="lsMsgInput" placeholder="Mesajinizi yazin... ( / ile kisayol)" onkeydown="lsMsgKeydown(event)" oninput="lsCheckShortcut();lsEmitTyping()">
                            <button class="btn btn-primary" onclick="lsSendMsg()">Gonder</button>
                        </div>
                    </div>
                    <div id="lsProfilePanel" style="width:240px;background:white;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06);display:none;flex-direction:column;overflow-y:auto;font-size:12px">
                        <div style="padding:12px 16px;border-bottom:1px solid #e2e8f0;font-weight:600;font-size:13px">Musteri Profili</div>
                        <div id="lsProfileContent" style="padding:12px 16px"></div>
                    </div>
                </div>`;
            await lsLoadData();
            lsConnectNotifications();
            // Auto-refresh every 10s for online status
            if (window._lsRefreshInterval) clearInterval(window._lsRefreshInterval);
            window._lsRefreshInterval = setInterval(() => {
                if (document.querySelector('[data-page="live-support"].active')) lsLoadData();
                else clearInterval(window._lsRefreshInterval);
            }, 10000);
        }

        let lsAllConversations = [];
        let lsCurrentFilter = 'all';

        async function lsLoadAgentStatuses() {
            try {
                const resp = await fetch(`${API}/api/auth/agents/status`, { headers: authHeaders() });
                const data = await resp.json();
                const bar = document.getElementById('lsAgentStatusBar');
                if (!bar) return;
                const statusIcons = { online: '&#x1F7E2;', busy: '&#x1F534;', away: '&#x1F7E1;', offline: '&#x26AB;' };
                bar.innerHTML = (data.agents || []).map(a =>
                    `<span style="display:inline-flex;align-items:center;gap:2px;padding:2px 6px;background:#f7fafc;border-radius:4px" title="${escHtml(a.role)}">${statusIcons[a.status] || '&#x26AB;'} ${escHtml(a.full_name)}</span>`
                ).join('') || '<span style="color:#a0aec0">Temsilci yok</span>';
            } catch (e) { console.error('Agent status load error:', e); }
        }

        async function lsLoadData() {
            try {
                lsLoadAgentStatuses(); // fire and forget
                const resp = await fetch(`${API}/api/live-support/all`, { headers: authHeaders() });
                const data = await resp.json();
                lsAllConversations = data.conversations || [];
                lsRenderAll();
            } catch (e) { console.error('LS load error:', e); }
        }

        function lsSetFilter(f) {
            lsCurrentFilter = f;
            document.querySelectorAll('.ls-filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter === f));
            lsRenderAll();
        }

        function lsRenderAll() {
            const el = document.getElementById('lsAllList');
            const countEl = document.getElementById('lsAllCount');
            if (!el) return;

            let items = lsAllConversations;
            if (lsCurrentFilter === 'online') items = items.filter(c => c.online);
            else if (lsCurrentFilter === 'waiting') items = items.filter(c => c.status === 'waiting');
            else if (lsCurrentFilter === 'mine') items = items.filter(c => c.status === 'assigned' && c.assigned_agent_name);

            countEl.textContent = items.length;
            if (!items.length) {
                el.innerHTML = '<div style="padding:24px;text-align:center;color:#a0aec0;font-size:13px">Sohbet bulunamadi</div>';
                return;
            }

            el.innerHTML = items.map(c => {
                const isActive = lsActiveConvId === c.conversation_id;
                const visitorLabel = c.visitor_id ? c.visitor_id.substring(0,12) : 'Ziyaretci';
                const onlineDot = c.online ? '<span class="ls-online-dot"></span>' : '<span class="ls-online-dot offline"></span>';

                let statusBadge = '';
                let slaBadge = '';
                if (c.status === 'waiting') {
                    statusBadge = '<span class="badge badge-yellow" style="font-size:9px">Bekliyor</span>';
                    if (c.escalated_at) {
                        const waitSec = Math.floor((Date.now() - new Date(c.escalated_at).getTime()) / 1000);
                        const waitMin = Math.floor(waitSec / 60);
                        const slaColor = waitMin >= 5 ? '#e53e3e' : waitMin >= 2 ? '#dd6b20' : '#38a169';
                        slaBadge = '<span style="font-size:9px;color:' + slaColor + ';font-weight:600">' + (waitMin > 0 ? waitMin + 'dk' : waitSec + 'sn') + '</span>';
                    }
                }
                else if (c.status === 'assigned') statusBadge = '<span class="badge badge-blue" style="font-size:9px">' + escHtml(c.assigned_agent_name || 'Temsilci') + '</span>';
                else if (c.mode === 'ai') statusBadge = '<span class="badge badge-gray" style="font-size:9px">AI</span>';

                const modeBadge = c.mode === 'human' ? '<span class="badge badge-green" style="font-size:9px">Canli</span>' : '';

                let actionBtn = '';
                if (c.status === 'waiting') {
                    actionBtn = '<button class="btn btn-primary" style="font-size:10px;padding:2px 8px" onclick="event.stopPropagation();lsClaim(\'' + c.conversation_id + '\')">Devral</button>';
                } else if (c.status !== 'assigned') {
                    actionBtn = '<button class="btn" style="font-size:10px;padding:2px 8px;background:#ebf8ff;color:#2b6cb0;border:1px solid #bee3f8" onclick="event.stopPropagation();lsClaim(\'' + c.conversation_id + '\')">Katil</button>';
                }

                return '<div class="ls-item ' + (isActive ? 'active' : '') + '" onclick="lsOpenConversation(\'' + c.conversation_id + '\', \'' + escHtml(visitorLabel) + '\')">'
                    + '<div style="display:flex;justify-content:space-between;align-items:center">'
                    + '<div class="ls-visitor">' + onlineDot + escHtml(visitorLabel) + '</div>'
                    + actionBtn
                    + '</div>'
                    + '<div class="ls-preview">' + escHtml(c.last_message || 'Mesaj yok') + '</div>'
                    + '<div class="ls-meta">'
                    + statusBadge + modeBadge + slaBadge
                    + '<span>' + (c.message_count || 0) + ' mesaj</span>'
                    + '<span>' + escHtml(c.channel || 'widget') + '</span>'
                    + '</div>'
                    + (c.tags && c.tags.length ? '<div style="display:flex;flex-wrap:wrap;gap:3px;margin-top:3px">' + c.tags.map(t => '<span style="padding:0 6px;background:#e0f2fe;color:#0369a1;border-radius:8px;font-size:9px">' + escHtml(t) + '</span>').join('') + '</div>' : '')
                    + '</div>';
            }).join('');
        }

        async function lsClaim(convId) {
            try {
                const resp = await fetch(`${API}/api/live-support/claim/${convId}`, {
                    method: 'POST', headers: authHeaders()
                });
                if (resp.ok) {
                    const data = await resp.json();
                    await lsLoadData();
                    lsOpenConversation(convId, data.visitor_id || 'Ziyaretci');
                } else {
                    const err = await resp.json().catch(() => ({}));
                    alert('Devralma hatasi: ' + (err.detail || resp.statusText));
                }
            } catch (e) { alert('Baglanti hatasi: ' + e.message); }
        }

        async function lsBlockVisitor() {
            if (!lsActiveConvId) return;
            const conv = lsAllConversations.find(c => c.conversation_id === lsActiveConvId);
            if (!conv) return;
            const reason = prompt('Engelleme sebebi (opsiyonel):');
            if (reason === null) return; // cancelled

            try {
                const resp = await fetch(`${API}/api/admin/blacklist`, {
                    method: 'POST',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'visitor', value: conv.visitor_id, reason: reason || 'Canli destekten engellendi' })
                });
                if (resp.ok) {
                    alert('Ziyaretci engellendi: ' + conv.visitor_id);
                    lsCloseConversation();
                } else {
                    const err = await resp.json().catch(() => ({}));
                    alert('Engelleme hatasi: ' + (err.detail || resp.statusText));
                }
            } catch (e) { alert('Baglanti hatasi: ' + e.message); }
        }

        async function lsCloseConversation() {
            if (!lsActiveConvId) return;
            if (!confirm('Bu sohbeti kapatmak istiyor musunuz? Musteriden degerlendirme istenecek.')) return;
            try {
                const resp = await fetch(`${API}/api/live-support/close/${lsActiveConvId}`, {
                    method: 'POST', headers: authHeaders()
                });
                if (resp.ok) {
                    if (lsAgentWs) { lsAgentWs.close(); lsAgentWs = null; }
                    lsActiveConvId = null;
                    document.getElementById('lsChatHeader').style.display = 'none';
                    document.getElementById('lsChatInput').style.display = 'none';
                    document.getElementById('lsChatMessages').innerHTML = '<div class="ls-empty">Sohbet kapatildi.</div>';
                    await lsLoadData();
                } else {
                    const err = await resp.json().catch(() => ({}));
                    alert('Kapatma hatasi: ' + (err.detail || resp.statusText));
                }
            } catch (e) { alert('Baglanti hatasi: ' + e.message); }
        }

        async function lsRelease() {
            if (!lsActiveConvId) return;
            if (!confirm('Bu sohbeti birakmak istiyor musunuz? AI tekrar devreye girecek.')) return;
            try {
                const resp = await fetch(`${API}/api/live-support/release/${lsActiveConvId}`, {
                    method: 'POST', headers: authHeaders()
                });
                if (resp.ok) {
                    if (lsAgentWs) { lsAgentWs.close(); lsAgentWs = null; }
                    lsActiveConvId = null;
                    document.getElementById('lsChatHeader').style.display = 'none';
                    document.getElementById('lsChatInput').style.display = 'none';
                    document.getElementById('lsChatMessages').innerHTML = '<div class="ls-empty">Sohbet birakildi. AI tekrar aktif.</div>';
                    await lsLoadData();
                } else {
                    const err = await resp.json().catch(() => ({}));
                    alert('Birakma hatasi: ' + (err.detail || resp.statusText));
                }
            } catch (e) { alert('Baglanti hatasi: ' + e.message); }
        }

        async function lsOpenConversation(convId, visitorLabel) {
            // Close previous agent WS if open
            if (lsAgentWs) { lsAgentWs.close(); lsAgentWs = null; }
            lsActiveConvId = convId;

            // Update UI
            document.getElementById('lsChatHeader').style.display = 'flex';
            document.getElementById('lsChatTitle').textContent = 'Sohbet: ' + (visitorLabel || convId.substring(0,8));
            document.getElementById('lsChatInput').style.display = 'flex';
            document.getElementById('lsChatMessages').innerHTML = '<div class="ls-empty">Baglaniliyor...</div>';

            // Load customer profile (Feature 13)
            lsLoadProfile(convId);

            // Highlight active item
            document.querySelectorAll('.ls-item').forEach(i => i.classList.remove('active'));

            // Auto-claim if not already assigned to this agent
            const conv = lsAllConversations.find(c => c.conversation_id === convId);
            if (conv && conv.status !== 'assigned') {
                try {
                    const claimResp = await fetch(`${API}/api/live-support/claim/${convId}`, {
                        method: 'POST', headers: authHeaders()
                    });
                    if (!claimResp.ok) {
                        const err = await claimResp.json().catch(() => ({}));
                        document.getElementById('lsChatMessages').innerHTML = '<div class="ls-empty" style="color:#e53e3e">' + escHtml(err.detail || 'Devralma hatasi') + '</div>';
                        return;
                    }
                    await lsLoadData();
                } catch (e) {
                    document.getElementById('lsChatMessages').innerHTML = '<div class="ls-empty" style="color:#e53e3e">Baglanti hatasi</div>';
                    return;
                }
            }

            // Connect agent WS
            lsAgentWs = new WebSocket(`${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}/ws/live-support/${convId}?token=${token}`);

            lsAgentWs.onopen = () => {
                console.log('Agent WS connected for', convId);
            };

            lsAgentWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                lsHandleAgentMsg(data);
            };

            lsAgentWs.onclose = () => {
                console.log('Agent WS closed');
                lsAgentWs = null;
            };

            lsAgentWs.onerror = (e) => {
                console.error('Agent WS error', e);
            };
        }

        function lsHandleAgentMsg(data) {
            const msgsEl = document.getElementById('lsChatMessages');
            if (!msgsEl) return;

            switch (data.type) {
                case 'history':
                    // Render full conversation history
                    msgsEl.innerHTML = data.messages.map(m => {
                        const attachHtml = lsRenderAttachmentHtml(m.attachments);
                        if (m.sender_type === 'note') {
                            return `<div style="margin:6px 12px;padding:8px 12px;background:#fefce8;border-left:3px solid #f59e0b;border-radius:4px;font-size:12px"><div style="font-size:10px;color:#92400e;margin-bottom:2px">&#x1F4DD; Dahili Not</div><div style="color:#78350f">${escHtml(m.content)}</div></div>`;
                        }
                        if (m.sender_type === 'system') {
                            return `<div class="ls-system-msg">${escHtml(m.content)}</div>`;
                        }
                        if (m.role === 'assistant') {
                            const label = m.sender_type === 'human' ? 'Temsilci' : 'AI';
                            const feedbackHtml = m.sender_type === 'ai' ? `<div style="margin-top:4px;display:flex;gap:4px;align-items:center"><button onclick="lsFeedback('${m.id}','good',this)" style="background:none;border:none;cursor:pointer;font-size:14px;opacity:${m.feedback === 'good' ? '1' : '0.4'}" title="Iyi yanit">&#x1F44D;</button><button onclick="lsFeedback('${m.id}','bad',this)" style="background:none;border:none;cursor:pointer;font-size:14px;opacity:${m.feedback === 'bad' ? '1' : '0.4'}" title="Kotu yanit">&#x1F44E;</button>${m.feedback ? '<span style="font-size:10px;color:#a0aec0">' + (m.feedback === 'good' ? 'Iyi' : 'Kotu') + '</span>' : ''}</div>` : '';
                            return `<div class="msg-row"><img class="msg-avatar" src="/images/logo-dark-mobile.png" alt="${label}"><div class="message assistant"><div style="font-size:10px;color:#a0aec0;margin-bottom:2px">${label}</div>${renderMarkdown(m.content)}${attachHtml}${feedbackHtml}</div></div>`;
                        }
                        return `<div class="msg-row user"><div class="message user">${escHtml(m.content || '')}${attachHtml}</div></div>`;
                    }).join('') || '<div style="text-align:center;color:#a0aec0;padding:20px">Mesaj yok</div>';
                    // Load tags from history
                    lsCurrentTags = data.tags || [];
                    lsRenderTags();
                    msgsEl.scrollTop = msgsEl.scrollHeight;
                    break;

                case 'customer_message':
                    // Customer sent a message
                    const userRow = document.createElement('div');
                    userRow.className = 'msg-row user';
                    userRow.innerHTML = `<div class="message user">${escHtml(data.content || '')}${lsRenderAttachmentHtml(data.attachments)}</div>`;
                    msgsEl.appendChild(userRow);
                    msgsEl.scrollTop = msgsEl.scrollHeight;
                    // Play sound if page not focused
                    if (document.hidden) {
                        lsPlayNotificationSound();
                        lsShowDesktopNotification('Yeni Musteri Mesaji', data.content ? data.content.substring(0, 100) : 'Yeni mesaj');
                    }
                    break;

                case 'typing':
                    // Show typing indicator for 3 seconds
                    let typingEl = document.getElementById('lsTypingIndicator');
                    if (!typingEl) {
                        typingEl = document.createElement('div');
                        typingEl.id = 'lsTypingIndicator';
                        typingEl.style.cssText = 'padding:4px 12px;font-size:12px;color:#a0aec0;font-style:italic';
                        typingEl.textContent = 'Musteri yaziyor...';
                        msgsEl.appendChild(typingEl);
                    }
                    typingEl.style.display = 'block';
                    msgsEl.scrollTop = msgsEl.scrollHeight;
                    clearTimeout(window._lsTypingTimeout);
                    window._lsTypingTimeout = setTimeout(() => { if (typingEl) typingEl.style.display = 'none'; }, 3000);
                    break;

                case 'note':
                    // Internal note from another agent
                    const noteEl = document.createElement('div');
                    noteEl.style.cssText = 'margin:6px 12px;padding:8px 12px;background:#fefce8;border-left:3px solid #f59e0b;border-radius:4px;font-size:12px';
                    noteEl.innerHTML = `<div style="font-size:10px;color:#92400e;margin-bottom:2px">&#x1F4DD; Dahili Not - ${escHtml(data.agent_name || 'Temsilci')}</div><div style="color:#78350f">${escHtml(data.content)}</div>`;
                    msgsEl.appendChild(noteEl);
                    msgsEl.scrollTop = msgsEl.scrollHeight;
                    break;

                case 'error':
                    msgsEl.innerHTML = `<div class="ls-empty" style="color:#e53e3e">${escHtml(data.message)}</div>`;
                    break;
            }
        }

        // ‚îÄ‚îÄ Internal Notes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function lsToggleNoteInput() {
            const el = document.getElementById('lsNoteInput');
            const isVisible = el.style.display === 'flex';
            el.style.display = isVisible ? 'none' : 'flex';
            if (!isVisible) document.getElementById('lsNoteText').focus();
        }

        async function lsSendNote() {
            if (!lsActiveConvId) return;
            const input = document.getElementById('lsNoteText');
            const content = input.value.trim();
            if (!content) return;

            try {
                const resp = await fetch(`${API}/api/live-support/${lsActiveConvId}/note`, {
                    method: 'POST',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                if (resp.ok) {
                    const data = await resp.json();
                    // Show note in chat
                    const msgsEl = document.getElementById('lsChatMessages');
                    const noteEl = document.createElement('div');
                    noteEl.style.cssText = 'margin:6px 12px;padding:8px 12px;background:#fefce8;border-left:3px solid #f59e0b;border-radius:4px;font-size:12px';
                    noteEl.innerHTML = `<div style="font-size:10px;color:#92400e;margin-bottom:2px">&#x1F4DD; Dahili Not - ${escHtml(data.agent_name || 'Ben')}</div><div style="color:#78350f">${escHtml(content)}</div>`;
                    msgsEl.appendChild(noteEl);
                    msgsEl.scrollTop = msgsEl.scrollHeight;
                    input.value = '';
                    document.getElementById('lsNoteInput').style.display = 'none';
                } else {
                    const err = await resp.json().catch(() => ({}));
                    alert('Not kaydetme hatasi: ' + (err.detail || resp.statusText));
                }
            } catch (e) { alert('Baglanti hatasi: ' + e.message); }
        }

        // ‚îÄ‚îÄ Tags ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let lsCurrentTags = [];

        function lsToggleTagEditor() {
            const el = document.getElementById('lsTagEditor');
            const isVisible = el.style.display === 'flex';
            el.style.display = isVisible ? 'none' : 'flex';
            if (!isVisible) document.getElementById('lsTagInput').focus();
        }

        function lsRenderTags() {
            const display = document.getElementById('lsTagDisplay');
            if (!lsCurrentTags.length) {
                display.style.display = 'none';
                return;
            }
            display.style.display = 'flex';
            display.innerHTML = lsCurrentTags.map(t =>
                `<span style="display:inline-flex;align-items:center;gap:3px;padding:1px 8px;background:#e0f2fe;color:#0369a1;border-radius:10px;font-size:11px">${escHtml(t)}<button onclick="lsRemoveTag('${escHtml(t)}')" style="background:none;border:none;cursor:pointer;color:#0369a1;font-size:12px;padding:0;line-height:1">&times;</button></span>`
            ).join('');
        }

        async function lsAddTag() {
            if (!lsActiveConvId) return;
            const input = document.getElementById('lsTagInput');
            const tag = input.value.trim().toLowerCase();
            if (!tag) return;
            if (lsCurrentTags.includes(tag)) { input.value = ''; return; }

            lsCurrentTags.push(tag);
            input.value = '';
            await lsSaveTags();
        }

        async function lsRemoveTag(tag) {
            lsCurrentTags = lsCurrentTags.filter(t => t !== tag);
            await lsSaveTags();
        }

        async function lsSaveTags() {
            lsRenderTags();
            if (!lsActiveConvId) return;
            try {
                await fetch(`${API}/api/live-support/${lsActiveConvId}/tags`, {
                    method: 'PUT',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tags: lsCurrentTags })
                });
            } catch (e) { console.error('Tag save error:', e); }
        }

        // ‚îÄ‚îÄ AI Feedback (Feature 14) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function lsFeedback(messageId, feedback, btn) {
            try {
                const resp = await fetch(`${API}/api/live-support/message/${messageId}/feedback`, {
                    method: 'POST',
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedback })
                });
                if (resp.ok) {
                    // Update button opacity
                    const parent = btn.parentElement;
                    const thumbs = parent.querySelectorAll('button');
                    thumbs[0].style.opacity = feedback === 'good' ? '1' : '0.4';
                    thumbs[1].style.opacity = feedback === 'bad' ? '1' : '0.4';
                    // Update label
                    let label = parent.querySelector('span');
                    if (!label) { label = document.createElement('span'); label.style.cssText = 'font-size:10px;color:#a0aec0'; parent.appendChild(label); }
                    label.textContent = feedback === 'good' ? 'Iyi' : 'Kotu';
                }
            } catch (e) { console.error('Feedback error:', e); }
        }

        // ‚îÄ‚îÄ Customer Profile (Feature 13) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function lsLoadProfile(convId) {
            const panel = document.getElementById('lsProfilePanel');
            const content = document.getElementById('lsProfileContent');
            if (!panel || !content) return;

            panel.style.display = 'flex';
            content.innerHTML = '<div style="color:#a0aec0;text-align:center">Yukleniyor...</div>';

            try {
                const resp = await fetch(`${API}/api/live-support/${convId}/profile`, { headers: authHeaders() });
                if (!resp.ok) { content.innerHTML = '<div style="color:#a0aec0">Profil yuklenemedi</div>'; return; }
                const p = await resp.json();

                const firstSeen = p.first_seen ? new Date(p.first_seen).toLocaleDateString('tr-TR') : '-';
                content.innerHTML = `
                    <div style="margin-bottom:12px">
                        <div style="font-size:11px;color:#718096">Ziyaretci ID</div>
                        <div style="font-weight:500;word-break:break-all">${escHtml(p.visitor_id || '-')}</div>
                    </div>
                    <div style="margin-bottom:12px">
                        <div style="font-size:11px;color:#718096">Kanal</div>
                        <div style="font-weight:500">${escHtml(p.channel || 'widget')}</div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
                        <div>
                            <div style="font-size:11px;color:#718096">Sohbetler</div>
                            <div style="font-weight:600;font-size:16px">${p.total_conversations}</div>
                        </div>
                        <div>
                            <div style="font-size:11px;color:#718096">Mesajlar</div>
                            <div style="font-weight:600;font-size:16px">${p.total_messages}</div>
                        </div>
                    </div>
                    <div style="margin-bottom:12px">
                        <div style="font-size:11px;color:#718096">Ilk Gorulen</div>
                        <div style="font-weight:500">${firstSeen}</div>
                    </div>
                    ${p.avg_rating ? `<div style="margin-bottom:12px"><div style="font-size:11px;color:#718096">Ort. Puan</div><div style="font-weight:500;font-size:16px">&#x2B50; ${p.avg_rating}/5</div></div>` : ''}
                    ${p.previous_conversations.length > 1 ? `
                        <div style="margin-top:8px;border-top:1px solid #e2e8f0;padding-top:8px">
                            <div style="font-size:11px;color:#718096;margin-bottom:6px">Onceki Sohbetler</div>
                            ${p.previous_conversations.slice(1).map(c => `
                                <div style="padding:4px 0;border-bottom:1px solid #f0f2f5;font-size:11px">
                                    <span style="color:#4a5568">${new Date(c.created_at).toLocaleDateString('tr-TR')}</span>
                                    <span class="badge badge-gray" style="font-size:9px;margin-left:4px">${c.status}</span>
                                    ${c.tags.length ? c.tags.map(t => '<span style="padding:0 4px;background:#e0f2fe;color:#0369a1;border-radius:6px;font-size:8px;margin-left:2px">' + escHtml(t) + '</span>').join('') : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
            } catch (e) {
                content.innerHTML = '<div style="color:#e53e3e">Profil yuklenemedi</div>';
            }
        }

        let _lsTypingSent = 0;
        function lsEmitTyping() {
            if (!lsAgentWs || lsAgentWs.readyState !== WebSocket.OPEN) return;
            const now = Date.now();
            if (now - _lsTypingSent < 2000) return; // throttle: max once per 2s
            _lsTypingSent = now;
            lsAgentWs.send(JSON.stringify({ type: 'typing' }));
        }

        let lsPendingAttachments = [];

        async function lsHandleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            event.target.value = '';

            if (file.size > 10 * 1024 * 1024) {
                alert('Dosya boyutu 10MB\'dan buyuk olamaz');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const resp = await fetch(`${API}/api/chat/upload`, { method: 'POST', body: formData });
                if (!resp.ok) { const e = await resp.json(); alert(e.detail || 'Yukleme hatasi'); return; }
                const data = await resp.json();
                lsPendingAttachments.push(data);
                lsRenderAttachPreview();
            } catch (e) {
                alert('Dosya yuklenemedi');
            }
        }

        function lsRenderAttachPreview() {
            const el = document.getElementById('lsAttachPreview');
            if (!lsPendingAttachments.length) { el.style.display = 'none'; return; }
            el.style.display = 'block';
            el.innerHTML = lsPendingAttachments.map((a, i) =>
                `<span style="display:inline-flex;align-items:center;gap:4px;background:#e0f2fe;padding:2px 8px;border-radius:4px;margin-right:4px">
                    ${a.type === 'image' ? '<span>&#x1F5BC;</span>' : '<span>&#x1F4C4;</span>'}
                    <span>${escHtml(a.filename)}</span>
                    <button onclick="lsRemoveAttach(${i})" style="background:none;border:none;cursor:pointer;color:#dc2626;font-size:14px">&times;</button>
                </span>`
            ).join('');
        }

        function lsRemoveAttach(i) {
            lsPendingAttachments.splice(i, 1);
            lsRenderAttachPreview();
        }

        function lsRenderAttachmentHtml(attachments) {
            if (!attachments || !attachments.length) return '';
            return attachments.map(a => {
                if (a.type === 'image') {
                    return `<div style="margin-top:6px"><img src="${API}${a.url}" alt="${escHtml(a.filename)}" style="max-width:200px;max-height:200px;border-radius:6px;cursor:pointer" onclick="window.open('${API}${a.url}','_blank')"></div>`;
                }
                return `<div style="margin-top:6px"><a href="${API}${a.url}" target="_blank" style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:#f1f5f9;border-radius:4px;color:#0369a1;text-decoration:none;font-size:12px">&#x1F4C4; ${escHtml(a.filename)}</a></div>`;
            }).join('');
        }

        function lsSendMsg() {
            const input = document.getElementById('lsMsgInput');
            const text = input.value.trim();
            const attachments = lsPendingAttachments.length ? [...lsPendingAttachments] : null;
            if ((!text && !attachments) || !lsAgentWs || lsAgentWs.readyState !== WebSocket.OPEN) return;

            // Show own message immediately
            const msgsEl = document.getElementById('lsChatMessages');
            const row = document.createElement('div');
            row.className = 'msg-row';
            row.innerHTML = `<img class="msg-avatar" src="/images/logo-dark-mobile.png" alt="Temsilci"><div class="message assistant"><div style="font-size:10px;color:#a0aec0;margin-bottom:2px">Temsilci (Ben)</div>${text ? escHtml(text) : ''}${lsRenderAttachmentHtml(attachments)}</div>`;
            msgsEl.appendChild(row);
            msgsEl.scrollTop = msgsEl.scrollHeight;

            const payload = { type: 'message', content: text };
            if (attachments) payload.attachments = attachments;
            lsAgentWs.send(JSON.stringify(payload));
            input.value = '';
            lsPendingAttachments = [];
            lsRenderAttachPreview();
            input.focus();
            // Hide shortcut hint
            const hint = document.getElementById('lsShortcutHint');
            if (hint) hint.style.display = 'none';
        }

        function lsMsgKeydown(event) {
            if (event.key === 'Enter') {
                // If shortcut hint is visible, apply it instead
                const hint = document.getElementById('lsShortcutHint');
                if (hint && hint.style.display !== 'none' && hint.dataset.crId) {
                    event.preventDefault();
                    lsApplyShortcutHint();
                    return;
                }
                lsSendMsg();
            } else if (event.key === 'Escape') {
                const hint = document.getElementById('lsShortcutHint');
                if (hint) hint.style.display = 'none';
                const panel = document.getElementById('lsCannedPanel');
                if (panel && panel.style.display !== 'none') lsToggleCanned();
            }
        }

        // ‚îÄ‚îÄ Canned Response Picker in Live Support ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let lsCannedResponses = [];
        let lsCannedLoaded = false;

        async function lsLoadCannedResponses() {
            if (lsCannedLoaded && lsCannedResponses.length) return;
            try {
                const resp = await fetch(`${API}/api/canned-responses`, { headers: authHeaders() });
                lsCannedResponses = await resp.json();
                lsCannedLoaded = true;
            } catch (e) { console.error('Failed to load canned responses', e); }
        }

        async function lsToggleCanned() {
            const panel = document.getElementById('lsCannedPanel');
            if (panel.style.display === 'none' || panel.style.display === '') {
                await lsLoadCannedResponses();
                // Populate category filter
                const catFilter = document.getElementById('lsCannedCatFilter');
                catFilter.innerHTML = '<option value="">Tumu</option>' +
                    CR_CATEGORIES.map(c => '<option value="' + c.value + '">' + c.label + '</option>').join('');
                lsCannedFilter();
                panel.style.display = 'flex';
                document.getElementById('lsCannedSearch').focus();
            } else {
                panel.style.display = 'none';
            }
        }

        function lsCannedFilter() {
            const q = (document.getElementById('lsCannedSearch').value || '').toLowerCase();
            const cat = document.getElementById('lsCannedCatFilter').value;
            const filtered = lsCannedResponses.filter(cr => {
                if (cat && cr.category !== cat) return false;
                if (q && !cr.title.toLowerCase().includes(q) && !cr.content.toLowerCase().includes(q)) return false;
                return true;
            });
            lsRenderCannedList(filtered);
        }

        function lsRenderCannedList(items) {
            const el = document.getElementById('lsCannedList');
            if (!items.length) {
                el.innerHTML = '<div style="padding:16px;text-align:center;color:#a0aec0;font-size:13px">Sablon bulunamadi</div>';
                return;
            }
            el.innerHTML = items.map(cr => {
                const catObj = CR_CATEGORIES.find(c => c.value === cr.category);
                const preview = cr.content.substring(0, 80).replace(/\n/g, ' ') + (cr.content.length > 80 ? '...' : '');
                return `<div style="padding:8px 12px;border-bottom:1px solid #f0f2f5;cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='#f7fafc'" onmouseout="this.style.background=''" onclick="lsSelectCanned('${cr.id}')">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <span style="font-weight:500;font-size:13px">${escHtml(cr.title)}</span>
                        <span style="font-size:10px;padding:1px 6px;border-radius:3px;background:${catObj ? catObj.color + '20' : '#eee'};color:${catObj ? catObj.color : '#666'}">${catObj ? catObj.label : cr.category}</span>
                    </div>
                    <div style="font-size:12px;color:#a0aec0;margin-top:2px">${escHtml(preview)}</div>
                    ${cr.shortcut ? '<div style="font-size:11px;color:#718096;font-family:monospace;margin-top:2px">' + escHtml(cr.shortcut) + '</div>' : ''}
                </div>`;
            }).join('');
        }

        function lsSelectCanned(id) {
            const cr = lsCannedResponses.find(c => c.id === id);
            if (!cr) return;
            const resolved = lsResolveVariables(cr.content);
            document.getElementById('lsMsgInput').value = resolved;
            document.getElementById('lsCannedPanel').style.display = 'none';
            document.getElementById('lsMsgInput').focus();
            // Track usage
            fetch(`${API}/api/canned-responses/${id}/use`, { method: 'POST', headers: authHeaders() }).catch(() => {});
        }

        function lsResolveVariables(text) {
            return text
                .replace(/\{\{temsilci_adi\}\}/g, currentUser?.full_name || '')
                .replace(/\{\{tarih\}\}/g, new Date().toLocaleDateString('tr-TR'))
                .replace(/\{\{saat\}\}/g, new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' }));
        }

        async function lsCheckShortcut() {
            const input = document.getElementById('lsMsgInput');
            const text = input.value;
            const hint = document.getElementById('lsShortcutHint');

            // If just "/" typed, open canned panel as quick access
            if (text === '/') {
                hint.style.display = 'none';
                hint.dataset.crId = '';
                await lsLoadCannedResponses();
                const panel = document.getElementById('lsCannedPanel');
                if (panel.style.display === 'none' || panel.style.display === '') {
                    lsToggleCanned();
                }
                return;
            }

            if (!text.startsWith('/') || text.length < 2) {
                hint.style.display = 'none';
                hint.dataset.crId = '';
                return;
            }

            // Lazy load
            if (!lsCannedLoaded) {
                await lsLoadCannedResponses();
            }

            // Close panel if open, show inline hint instead
            const panel = document.getElementById('lsCannedPanel');
            if (panel && panel.style.display === 'flex') {
                // Filter the panel search as user types
                document.getElementById('lsCannedSearch').value = text.substring(1);
                lsCannedFilter();
            }

            const matches = lsCannedResponses.filter(cr => cr.shortcut && cr.shortcut.startsWith(text));
            if (matches.length === 1) {
                const match = matches[0];
                hint.innerHTML = '<strong>' + escHtml(match.shortcut) + '</strong> &rarr; ' + escHtml(match.title) + ' <span style="float:right;font-size:11px;color:#b45309">Enter ile sec</span>';
                hint.dataset.crId = match.id;
                hint.style.display = 'block';
            } else if (matches.length > 1) {
                hint.innerHTML = matches.length + ' sonuc: ' + matches.map(m => '<strong>' + escHtml(m.shortcut) + '</strong>').join(', ') + ' <span style="float:right;font-size:11px;color:#b45309">Yazmaya devam edin</span>';
                hint.dataset.crId = '';
                hint.style.display = 'block';
            } else {
                hint.style.display = 'none';
                hint.dataset.crId = '';
            }
        }

        function lsApplyShortcutHint() {
            const hint = document.getElementById('lsShortcutHint');
            const id = hint.dataset.crId;
            if (!id) return;
            lsSelectCanned(id);
            hint.style.display = 'none';
            hint.dataset.crId = '';
        }

        // ‚îÄ‚îÄ Notification System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function lsRequestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function lsPlayNotificationSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 800;
                osc.type = 'sine';
                gain.gain.value = 0.3;
                osc.start();
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.stop(ctx.currentTime + 0.3);
            } catch (e) { /* Audio not available */ }
        }

        function lsShowDesktopNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const n = new Notification(title, { body, icon: '/images/logo-dark-mobile.png', tag: 'idf-live-support' });
                n.onclick = () => { window.focus(); n.close(); };
                setTimeout(() => n.close(), 8000);
            }
        }

        function lsConnectNotifications() {
            if (lsNotifWs) { lsNotifWs.close(); lsNotifWs = null; }
            lsNotifWs = new WebSocket(`${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}/ws/live-support/notifications?token=${token}`);
            lsRequestNotificationPermission();

            lsNotifWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'new_escalation') {
                    lsLoadData();
                    lsPlayNotificationSound();
                    lsShowDesktopNotification('Yeni Destek Talebi', data.preview || 'Bir musteri canli destek istiyor');
                } else if (data.type === 'queue_update') {
                    lsLoadData();
                    if (data.event === 'auto_assigned') {
                        lsPlayNotificationSound();
                    }
                }
            };

            lsNotifWs.onclose = () => {
                lsNotifWs = null;
                // Reconnect if still on live support page
                setTimeout(() => {
                    if (document.querySelector('[data-page="live-support"].active')) {
                        lsConnectNotifications();
                    }
                }, 3000);
            };

            // Keep alive
            setInterval(() => {
                if (lsNotifWs && lsNotifWs.readyState === WebSocket.OPEN) {
                    lsNotifWs.send(JSON.stringify({ type: 'ping' }));
                }
            }, 25000);
        }

        // ‚îÄ‚îÄ Live Chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function renderChat(el) {
            el.innerHTML = `
                <style>
                    .admin-chat .streaming::after {
                        content:''; display:inline-block; width:2px; height:1em; background:#231f20;
                        margin-left:2px; vertical-align:text-bottom; animation:cblink 0.7s steps(1) infinite;
                    }
                    @keyframes cblink { 0%,50%{opacity:1} 51%,100%{opacity:0} }
                    .admin-chat .typing-dots { display:flex; gap:4px; padding:8px 12px; }
                    .admin-chat .typing-dots .d {
                        width:6px; height:6px; border-radius:50%; background:#a0aec0;
                        animation:tbounce 1.4s ease-in-out infinite;
                    }
                    .admin-chat .typing-dots .d:nth-child(2) { animation-delay:0.2s; }
                    .admin-chat .typing-dots .d:nth-child(3) { animation-delay:0.4s; }
                    @keyframes tbounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-5px)} }
                    .admin-chat .msg-row { display:flex; align-items:flex-start; gap:0; margin-bottom:8px; }
                    .admin-chat .msg-row.user { justify-content:flex-end; }
                    .admin-chat .msg-avatar { width:36px; height:36px; flex-shrink:0; margin-top:2px; object-fit:contain; padding-right:8px; box-sizing:content-box; }
                    .admin-chat .message { max-width:70%; padding:8px 12px; border-radius:10px; font-size:13px; line-height:1.5; }
                    .admin-chat .message.assistant { background:#f0f2f5; color:#1a202c; border-bottom-left-radius:2px; }
                    .admin-chat .message.user { background:#231f20; color:white; border-bottom-right-radius:2px; white-space:pre-wrap; }
                </style>
                <div class="admin-chat" style="display:flex;gap:16px;height:calc(100vh - 140px)">
                    <div style="flex:1;background:white;border-radius:8px;display:flex;flex-direction:column;box-shadow:0 1px 3px rgba(0,0,0,0.06)">
                        <div style="padding:12px 16px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;gap:8px">
                            <span style="font-weight:600;color:#231f20">AI Chat Test</span>
                            <select id="chatSourceGroup" style="font-size:12px;padding:4px 8px;border:1px solid #ddd;border-radius:6px" onchange="chatSourceGroupId=this.value"></select>
                            <span id="chatWsStatus" style="font-size:11px;padding:2px 8px;border-radius:4px;background:#fed7d7;color:#9b2c2c">Baglaniyor...</span>
                        </div>
                        <div id="chatMessages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px">
                            <div class="msg-row"><img class="msg-avatar" src="/images/logo-dark-mobile.png" alt="AI"><div class="message assistant">Merhaba! Ben ID Fine AI asistaniyim. Size nasil yardimci olabilirim?</div></div>
                        </div>
                        <div id="chatTypingDots" class="typing-dots" style="display:none"><div class="d"></div><div class="d"></div><div class="d"></div></div>
                        <div style="padding:12px 16px;border-top:1px solid #e2e8f0;display:flex;gap:8px">
                            <input type="text" id="chatInput" placeholder="Mesajinizi yazin..." style="flex:1;padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:13px" onkeydown="if(event.key==='Enter'&&!chatBusy)sendChatMsg()">
                            <button class="btn btn-primary" id="chatSendBtn" onclick="sendChatMsg()">Gonder</button>
                        </div>
                    </div>
                    <div style="width:300px;background:white;border-radius:8px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,0.06);overflow-y:auto">
                        <h4 style="margin-bottom:12px;color:#231f20">Ornek Sorular</h4>
                        <div style="display:flex;flex-direction:column;gap:6px">
                            ${['Merhaba!', 'ID Fine hakkinda bilgi ver', 'Tabak cesitleriniz neler?', 'Bone china nedir?', 'HORECA icin hangi urunleri onerirsiniz?'].map(q =>
                `<button class="btn" style="background:#f0f2f5;text-align:left;font-size:12px" onclick="document.getElementById('chatInput').value='${q}';sendChatMsg()">${q}</button>`
            ).join('')}
                        </div>
                        <h4 style="margin:16px 0 8px;color:#231f20">Bilgi</h4>
                        <p style="font-size:12px;color:#718096;line-height:1.5">
                            Bu panel uzerinden chatbot'u test edebilirsiniz. Dokuman yukledikten sonra, bot yuklenen icerikteki bilgilere dayanarak yanit verecektir.
                        </p>
                    </div>
                </div>`;
            // Populate source group dropdown for chat
            (async () => {
                if (!sourceGroups.length) await loadSourceGroups();
                const sgSelect = document.getElementById('chatSourceGroup');
                if (sgSelect) {
                    sgSelect.innerHTML = sourceGroups.map(sg =>
                        `<option value="${sg.id}" ${sg.slug === 'internal' ? 'selected' : ''}>${escHtml(sg.name)}</option>`
                    ).join('');
                    chatSourceGroupId = sgSelect.value;
                }
            })();
            initChatWS();
        }

        // ‚îÄ‚îÄ Markdown Renderer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function renderMarkdown(text) {
            if (!text) return '';
            let html = text
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            html = html.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
            html = html.replace(/^### (.+)$/gm, '<h4>$1</h4>');
            html = html.replace(/^## (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            html = html.replace(/^[-*] (.+)$/gm, '<li>$1</li>');
            html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
            html = html.replace(/^\d+\.\s+(.+)$/gm, '<oli>$1</oli>');
            html = html.replace(/((?:<oli>.*<\/oli>\n?)+)/g, function (m) {
                return '<ol>' + m.replace(/<\/?oli>/g, function (t) { return t.replace('oli', 'li'); }) + '</ol>';
            });
            html = html.replace(/\n{2,}/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');
            html = '<p>' + html + '</p>';
            html = html.replace(/<p>\s*(<(?:ul|ol|h[34]))/g, '$1');
            html = html.replace(/(<\/(?:ul|ol|h[34])>)\s*<\/p>/g, '$1');
            html = html.replace(/<p>\s*<\/p>/g, '');
            html = html.replace(/<\/li>\s*<br>\s*/g, '</li>');
            html = html.replace(/<ul>\s*<br>/g, '<ul>');
            html = html.replace(/<ol>\s*<br>/g, '<ol>');
            html = html.replace(/<br>\s*<\/ul>/g, '</ul>');
            html = html.replace(/<br>\s*<\/ol>/g, '</ol>');
            html = html.replace(/<\/h[34]>\s*<br>/g, function (m) { return m.replace(/<br>/, ''); });
            html = html.replace(/<\/ul>\s*<br>/g, '</ul>');
            html = html.replace(/<\/ol>\s*<br>/g, '</ol>');
            return html;
        }

        // ‚îÄ‚îÄ WebSocket Chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        let chatConvId = null;
        let chatWs = null;
        let chatBusy = false;
        let chatStreamEl = null;
        let chatStreamText = '';
        let chatSourceGroupId = null;

        function initChatWS() {
            const statusEl = document.getElementById('chatWsStatus');
            try {
                chatWs = new WebSocket(`${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}/ws/widget/admin-test-panel`);
                chatWs.onopen = () => {
                    statusEl.textContent = 'WebSocket Bagli';
                    statusEl.style.background = '#c6f6d5';
                    statusEl.style.color = '#276749';
                };
                chatWs.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleChatStream(data);
                };
                chatWs.onclose = () => {
                    chatWs = null;
                    if (statusEl) {
                        statusEl.textContent = 'Baglanti kesildi';
                        statusEl.style.background = '#fed7d7';
                        statusEl.style.color = '#9b2c2c';
                    }
                    setTimeout(initChatWS, 3000);
                };
                chatWs.onerror = () => { chatWs = null; };
            } catch (e) { console.log('Chat WS failed', e); }
        }

        function createAiMsgRow(container, extraClass) {
            const row = document.createElement('div');
            row.className = 'msg-row';
            const avatar = document.createElement('img');
            avatar.className = 'msg-avatar';
            avatar.src = '/images/logo-dark-mobile.png';
            avatar.alt = 'AI';
            const bubble = document.createElement('div');
            bubble.className = 'message assistant' + (extraClass ? ' ' + extraClass : '');
            row.appendChild(avatar);
            row.appendChild(bubble);
            container.appendChild(row);
            return bubble;
        }

        function handleChatStream(data) {
            const msgs = document.getElementById('chatMessages');
            const dots = document.getElementById('chatTypingDots');
            switch (data.type) {
                case 'stream_start':
                    if (dots) dots.style.display = 'none';
                    chatStreamText = '';
                    chatStreamEl = createAiMsgRow(msgs, 'streaming');
                    chatBusy = true;
                    break;
                case 'stream_chunk':
                    if (chatStreamEl) {
                        chatStreamText += data.content;
                        chatStreamEl.textContent = chatStreamText;
                        msgs.scrollTop = msgs.scrollHeight;
                    }
                    break;
                case 'stream_end':
                    if (chatStreamEl) {
                        chatStreamEl.classList.remove('streaming');
                        chatStreamEl.innerHTML = renderMarkdown(chatStreamText);
                    }
                    if (dots) dots.style.display = 'none';
                    if (data.conversation_id) chatConvId = data.conversation_id;
                    chatStreamEl = null;
                    chatBusy = false;
                    msgs.scrollTop = msgs.scrollHeight;
                    document.getElementById('chatInput').focus();
                    document.getElementById('chatSendBtn').disabled = false;
                    break;
                case 'error':
                    if (dots) dots.style.display = 'none';
                    if (chatStreamEl) chatStreamEl.classList.remove('streaming');
                    const errDiv = createAiMsgRow(msgs);
                    errDiv.style.cssText = 'background:#fed7d7;color:#9b2c2c';
                    errDiv.textContent = 'Hata: ' + data.message;
                    chatStreamEl = null;
                    chatBusy = false;
                    document.getElementById('chatSendBtn').disabled = false;
                    break;
            }
        }

        async function sendChatMsg() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || chatBusy) return;

            const msgs = document.getElementById('chatMessages');
            const userRow = document.createElement('div');
            userRow.className = 'msg-row user';
            const userDiv = document.createElement('div');
            userDiv.className = 'message user';
            userDiv.textContent = text;
            userRow.appendChild(userDiv);
            msgs.appendChild(userRow);
            input.value = '';
            msgs.scrollTop = msgs.scrollHeight;
            document.getElementById('chatSendBtn').disabled = true;

            if (chatWs && chatWs.readyState === WebSocket.OPEN) {
                document.getElementById('chatTypingDots').style.display = 'flex';
                chatWs.send(JSON.stringify({
                    type: 'message',
                    content: text,
                    conversation_id: chatConvId,
                    source_group_id: chatSourceGroupId
                }));
            } else {
                document.getElementById('chatTypingDots').style.display = 'flex';
                try {
                    const resp = await fetch(`${API}/api/widget/message`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Visitor-ID': 'admin-test-panel' },
                        body: JSON.stringify({ content: text, conversation_id: chatConvId })
                    });
                    document.getElementById('chatTypingDots').style.display = 'none';
                    if (!resp.ok) {
                        const err = await resp.json().catch(() => ({}));
                        const eDiv = createAiMsgRow(msgs);
                        eDiv.style.cssText = 'background:#fed7d7;color:#9b2c2c';
                        eDiv.textContent = 'Hata: ' + (err.detail || resp.statusText);
                    } else {
                        const data = await resp.json();
                        chatConvId = data.conversation_id;
                        const bubble = createAiMsgRow(msgs, 'streaming');
                        const fullText = data.content;
                        let i = 0;
                        await new Promise(resolve => {
                            const iv = setInterval(() => {
                                i += Math.floor(Math.random() * 6) + 3;
                                if (i >= fullText.length) {
                                    bubble.innerHTML = renderMarkdown(fullText);
                                    bubble.classList.remove('streaming');
                                    clearInterval(iv);
                                    resolve();
                                } else {
                                    bubble.textContent = fullText.substring(0, i);
                                    msgs.scrollTop = msgs.scrollHeight;
                                }
                            }, 20);
                        });
                    }
                } catch (e) {
                    document.getElementById('chatTypingDots').style.display = 'none';
                    const eDiv = createAiMsgRow(msgs);
                    eDiv.style.cssText = 'background:#fed7d7;color:#9b2c2c';
                    eDiv.textContent = 'Baƒülantƒ± hatasƒ±:' + e.message;
                }
                chatBusy = false;
                document.getElementById('chatSendBtn').disabled = false;
                msgs.scrollTop = msgs.scrollHeight;
                input.focus();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        //  WIDGET KOD OLU≈ûTURUCU
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let widgetConfigs = [];
        let editingWidgetId = null;

        async function renderWidgetPage(el) {
            if (sourceGroups.length === 0) await loadSourceGroups();
            el.innerHTML = `
                <div id="widgetAlert"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px">
                    <!-- Sol: Form -->
                    <div style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 1px 4px rgba(0,0,0,.08)">
                        <h3 style="margin-bottom:16px;font-size:16px" id="widgetFormTitle">Yeni Widget Konfig√ºrasyonu</h3>
                        <div style="display:flex;flex-direction:column;gap:14px">
                            <div>
                                <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Konfig√ºrasyon Adƒ± *</label>
                                <input id="wName" type="text" placeholder="√ñrn: Ana Sayfa Widget" value="Ana Sayfa Widget"
                                    style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px">
                            </div>
                            <div>
                                <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Domain *</label>
                                <input id="wDomain" type="text" placeholder="www.idfine.com"
                                    style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px">
                            </div>
                            <div>
                                <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Kaynak Grubu *</label>
                                <select id="wSourceGroup" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px">
                                    <option value="">Se√ßiniz...</option>
                                    ${sourceGroups.map(sg => '<option value="' + sg.id + '"' + (sg.is_default ? ' selected' : '') + '>' + sg.name + '</option>').join('')}
                                </select>
                            </div>
                            <div>
                                <label style="display:block;font-size:13px;font-weight:500;margin-bottom:8px">Logo Se√ßimi</label>
                                <div style="display:flex;gap:16px;align-items:center">
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:10px 16px;border:2px solid #231f20;border-radius:10px;background:#fff" id="logoDarkLabel">
                                        <input type="radio" name="wLogo" value="dark" checked style="accent-color:#231f20">
                                        <img src="/images/logo-dark-mobile.png" style="width:36px;height:36px;object-fit:contain" alt="Koyu">
                                        <span style="font-size:13px">Koyu</span>
                                    </label>
                                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:10px 16px;border:2px solid #ddd;border-radius:10px;background:#333" id="logoLightLabel">
                                        <input type="radio" name="wLogo" value="light" style="accent-color:#231f20">
                                        <img src="/images/logo-light-mobile.png" style="width:36px;height:36px;object-fit:contain" alt="A√ßƒ±k">
                                        <span style="font-size:13px;color:#fff">A√ßƒ±k</span>
                                    </label>
                                </div>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                                <div>
                                    <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Marka Rengi</label>
                                    <div style="display:flex;gap:8px;align-items:center">
                                        <input id="wColor" type="color" value="#231f20" style="width:40px;height:36px;border:1px solid #ddd;border-radius:6px;cursor:pointer;padding:2px">
                                        <input id="wColorText" type="text" value="#231f20" maxlength="7"
                                            style="flex:1;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;font-family:monospace"
                                            oninput="document.getElementById('wColor').value=this.value;updateWidgetPreview()">
                                    </div>
                                </div>
                                <div>
                                    <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Marka Adƒ±</label>
                                    <input id="wBrandName" type="text" value="ID Fine"
                                        style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px">
                                </div>
                            </div>
                            <div>
                                <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Kar≈üƒ±lama Mesajƒ±</label>
                                <textarea id="wWelcome" rows="2" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px;resize:vertical;font-family:inherit">Merhaba! Size nasƒ±l yardƒ±mcƒ± olabilirim?</textarea>
                            </div>
                            <div>
                                <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Placeholder</label>
                                <input id="wPlaceholder" type="text" value="Mesajƒ±nƒ±zƒ± yazƒ±n..."
                                    style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px">
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
                                <div>
                                    <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Pozisyon</label>
                                    <select id="wPosition" style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px">
                                        <option value="bottom-right">Saƒü Alt</option>
                                        <option value="bottom-left">Sol Alt</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Geni≈ülik</label>
                                    <input id="wWidth" type="number" value="380" min="300" max="600"
                                        style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px">
                                </div>
                                <div>
                                    <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">Y√ºkseklik</label>
                                    <input id="wHeight" type="number" value="560" min="400" max="800"
                                        style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px">
                                </div>
                                <div>
                                    <label style="display:block;font-size:13px;font-weight:500;margin-bottom:4px">ƒ∞kon Boyutu</label>
                                    <input id="wTrigger" type="number" value="60" min="40" max="100"
                                        style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:8px;font-size:14px">
                                </div>
                            </div>
                            <div style="display:flex;gap:10px;margin-top:4px">
                                <button onclick="saveWidgetConfig()" style="flex:1;padding:10px;background:#231f20;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500">
                                    <span id="widgetSaveLabel">Kaydet</span>
                                </button>
                                <button onclick="resetWidgetForm()" style="padding:10px 20px;background:#f5f5f5;color:#333;border:1px solid #ddd;border-radius:8px;cursor:pointer;font-size:14px">Sƒ±fƒ±rla</button>
                            </div>
                        </div>
                    </div>
                    <!-- Saƒü: √ñnizleme + Kod -->
                    <div style="display:flex;flex-direction:column;gap:16px">
                        <!-- √ñnizleme -->
                        <div style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 1px 4px rgba(0,0,0,.08)">
                            <h3 style="margin-bottom:16px;font-size:16px">√ñnizleme</h3>
                            <div id="widgetPreview" style="position:relative;background:#f0f2f5;border-radius:12px;height:320px;overflow:hidden">
                            </div>
                        </div>
                        <!-- Embed Kodu -->
                        <div style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 1px 4px rgba(0,0,0,.08)">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                                <h3 style="font-size:16px">Embed Kodu</h3>
                                <button onclick="copyWidgetCode()" style="padding:6px 14px;background:#f5f5f5;border:1px solid #ddd;border-radius:6px;cursor:pointer;font-size:13px" id="copyCodeBtn">Kopyala</button>
                            </div>
                            <textarea id="widgetCode" readonly rows="6"
                                style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:12px;font-family:'Courier New',monospace;background:#f8f9fa;resize:none;color:#333"></textarea>
                        </div>
                    </div>
                </div>
                <!-- Kaydedilmi≈ü Konfig√ºrasyonlar -->
                <div style="background:#fff;border-radius:12px;padding:24px;box-shadow:0 1px 4px rgba(0,0,0,.08)">
                    <h3 style="margin-bottom:16px;font-size:16px">Kaydedilmi≈ü Konfig√ºrasyonlar</h3>
                    <div id="widgetConfigList">Y√ºkleniyor...</div>
                </div>
            `;

            // Color picker sync
            document.getElementById('wColor').addEventListener('input', e => {
                document.getElementById('wColorText').value = e.target.value;
                updateWidgetPreview();
            });

            // Logo radio border highlight
            document.querySelectorAll('input[name="wLogo"]').forEach(r => {
                r.addEventListener('change', () => {
                    document.getElementById('logoDarkLabel').style.borderColor = r.value === 'dark' ? '#231f20' : '#ddd';
                    document.getElementById('logoLightLabel').style.borderColor = r.value === 'light' ? '#231f20' : '#ddd';
                    updateWidgetPreview();
                });
            });

            // Live preview on any input change
            ['wBrandName','wWidth','wHeight','wTrigger','wPosition','wSourceGroup'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateWidgetPreview);
            });

            updateWidgetPreview();
            generateWidgetCode();
            loadWidgetConfigs();
        }

        function getWidgetFormValues() {
            return {
                name: document.getElementById('wName').value.trim(),
                domain: document.getElementById('wDomain').value.trim(),
                source_group_id: document.getElementById('wSourceGroup').value || null,
                logo_variant: document.querySelector('input[name="wLogo"]:checked').value,
                brand_color: document.getElementById('wColor').value,
                brand_name: document.getElementById('wBrandName').value.trim() || 'ID Fine',
                welcome_message: document.getElementById('wWelcome').value.trim(),
                placeholder: document.getElementById('wPlaceholder').value.trim(),
                position: document.getElementById('wPosition').value,
                width: parseInt(document.getElementById('wWidth').value) || 380,
                height: parseInt(document.getElementById('wHeight').value) || 560,
                trigger_size: parseInt(document.getElementById('wTrigger').value) || 60,
                is_active: true,
            };
        }

        function updateWidgetPreview() {
            const v = getWidgetFormValues();
            const logoSrc = v.logo_variant === 'light' ? '/images/logo-light-mobile.png' : '/images/logo-dark-mobile.png';
            const prev = document.getElementById('widgetPreview');
            if (!prev) return;

            prev.innerHTML = `
                <div style="position:absolute;top:0;left:0;right:0;display:flex;flex-direction:column;height:100%">
                    <!-- Header -->
                    <div style="background:${v.brand_color};color:#fff;padding:12px 14px;display:flex;align-items:center;gap:10px;border-radius:12px 12px 0 0">
                        <img src="${logoSrc}" style="width:28px;height:28px;object-fit:contain;filter:brightness(0) invert(1)" alt="">
                        <div>
                            <div style="font-size:14px;font-weight:600">${v.brand_name} Asistan</div>
                            <div style="font-size:10px;opacity:.8">√áevrimi√ßi</div>
                        </div>
                        <div style="margin-left:auto;opacity:.7">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                        </div>
                    </div>
                    <!-- Messages -->
                    <div style="flex:1;padding:12px;overflow-y:auto;display:flex;flex-direction:column;gap:8px">
                        <div style="display:flex;align-items:flex-start;gap:0">
                            <div style="width:28px;flex-shrink:0;padding-right:6px;margin-top:2px">
                                <img src="${logoSrc}" style="width:20px;height:20px;object-fit:contain" alt="">
                            </div>
                            <div style="background:#fff;padding:8px 12px;border-radius:10px;border-bottom-left-radius:3px;font-size:12px;max-width:80%;box-shadow:0 1px 2px rgba(0,0,0,.06)">
                                ${v.welcome_message || 'Merhaba!'}
                            </div>
                        </div>
                        <div style="display:flex;justify-content:flex-end">
                            <div style="background:${v.brand_color};color:#fff;padding:8px 12px;border-radius:10px;border-bottom-right-radius:3px;font-size:12px;max-width:80%">
                                Merhaba, √ºr√ºnleriniz hakkƒ±nda bilgi almak istiyorum
                            </div>
                        </div>
                        <div style="display:flex;align-items:flex-start;gap:0">
                            <div style="width:28px;flex-shrink:0;padding-right:6px;margin-top:2px">
                                <img src="${logoSrc}" style="width:20px;height:20px;object-fit:contain" alt="">
                            </div>
                            <div style="background:#fff;padding:8px 12px;border-radius:10px;border-bottom-left-radius:3px;font-size:12px;max-width:80%;box-shadow:0 1px 2px rgba(0,0,0,.06)">
                                Tabii! Size √ºr√ºn bilgisi, fiyat ve stok durumu konularƒ±nda yardƒ±mcƒ± olabilirim.
                            </div>
                        </div>
                    </div>
                    <!-- Input -->
                    <div style="padding:10px 12px;border-top:1px solid #e5e5e5;display:flex;gap:8px;background:#fff;border-radius:0 0 12px 12px">
                        <input type="text" placeholder="${v.placeholder || 'Mesajƒ±nƒ±zƒ± yazƒ±n...'}" disabled
                            style="flex:1;padding:7px 10px;border:1px solid #ddd;border-radius:6px;font-size:12px;outline:none">
                        <button disabled style="background:${v.brand_color};color:#fff;border:none;border-radius:6px;padding:7px 12px;font-size:12px;cursor:default">G√∂nder</button>
                    </div>
                </div>
                <!-- Trigger preview -->
                <div style="position:absolute;bottom:10px;${v.position === 'bottom-left' ? 'left' : 'right'}:10px;width:${Math.min(v.trigger_size, 48)}px;height:${Math.min(v.trigger_size, 48)}px">
                    <img src="${logoSrc}" style="width:100%;height:100%;object-fit:contain;border-radius:50%;filter:drop-shadow(0 2px 6px rgba(0,0,0,.25))" alt="">
                </div>
            `;

            generateWidgetCode();
        }

        function generateWidgetCode() {
            const v = getWidgetFormValues();
            const apiUrl = v.domain ? (v.domain.startsWith('http') ? v.domain : 'https://' + v.domain) : 'https://chat.codsol.fi';
            const scriptUrl = apiUrl + '/widget/idfine-chat.js';

            let attrs = [`data-api-url="${apiUrl}"`];
            if (v.source_group_id) attrs.push(`data-source-group="${v.source_group_id}"`);
            if (v.brand_color !== '#231f20') attrs.push(`data-brand-color="${v.brand_color}"`);
            if (v.brand_name !== 'ID Fine') attrs.push(`data-brand-name="${v.brand_name}"`);
            if (v.logo_variant !== 'dark') attrs.push(`data-logo-variant="${v.logo_variant}"`);
            if (v.position !== 'bottom-right') attrs.push(`data-position="${v.position}"`);
            if (v.width !== 380) attrs.push(`data-width="${v.width}"`);
            if (v.height !== 560) attrs.push(`data-height="${v.height}"`);
            if (v.trigger_size !== 60) attrs.push(`data-trigger-size="${v.trigger_size}"`);

            const attrsStr = attrs.length > 1
                ? '\n  ' + attrs.join('\n  ') + '\n'
                : ' ' + attrs.join(' ') + ' ';

            const code = `<script src="${scriptUrl}"${attrsStr}><\/script>`;

            const codeEl = document.getElementById('widgetCode');
            if (codeEl) codeEl.value = code;
        }

        function copyWidgetCode() {
            const codeEl = document.getElementById('widgetCode');
            if (!codeEl) return;
            navigator.clipboard.writeText(codeEl.value).then(() => {
                const btn = document.getElementById('copyCodeBtn');
                btn.textContent = 'Kopyalandƒ±!';
                setTimeout(() => { btn.textContent = 'Kopyala'; }, 2000);
            });
        }

        async function saveWidgetConfig() {
            const v = getWidgetFormValues();
            if (!v.name) { showWidgetAlert('Konfig√ºrasyon adƒ± gerekli', 'error'); return; }
            if (!v.domain) { showWidgetAlert('Domain gerekli', 'error'); return; }
            if (!v.source_group_id) { showWidgetAlert('Kaynak grubu se√ßimi gerekli', 'error'); return; }

            try {
                const url = editingWidgetId
                    ? `${API}/api/admin/widget-configs/${editingWidgetId}`
                    : `${API}/api/admin/widget-configs`;
                const method = editingWidgetId ? 'PUT' : 'POST';

                const resp = await fetch(url, {
                    method,
                    headers: { ...authHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(v),
                });

                if (!resp.ok) {
                    const err = await resp.json().catch(() => ({}));
                    throw new Error(err.detail || 'Kayƒ±t ba≈üarƒ±sƒ±z');
                }

                showWidgetAlert(editingWidgetId ? 'Konfig√ºrasyon g√ºncellendi' : 'Konfig√ºrasyon kaydedildi', 'success');
                resetWidgetForm();
                loadWidgetConfigs();
            } catch (e) {
                showWidgetAlert('Hata: ' + e.message, 'error');
            }
        }

        function resetWidgetForm() {
            editingWidgetId = null;
            document.getElementById('widgetFormTitle').textContent = 'Yeni Widget Konfig√ºrasyonu';
            document.getElementById('widgetSaveLabel').textContent = 'Kaydet';
            document.getElementById('wName').value = 'Ana Sayfa Widget';
            document.getElementById('wDomain').value = '';
            const wSgSelect = document.getElementById('wSourceGroup');
            if (wSgSelect) {
                const defaultOpt = Array.from(wSgSelect.options).find(o => sourceGroups.find(sg => sg.id === o.value && sg.is_default));
                wSgSelect.value = defaultOpt ? defaultOpt.value : '';
            }
            document.getElementById('wColor').value = '#231f20';
            document.getElementById('wColorText').value = '#231f20';
            document.getElementById('wBrandName').value = 'ID Fine';
            document.getElementById('wWelcome').value = 'Merhaba! Size nasƒ±l yardƒ±mcƒ± olabilirim?';
            document.getElementById('wPlaceholder').value = 'Mesajƒ±nƒ±zƒ± yazƒ±n...';
            document.getElementById('wPosition').value = 'bottom-right';
            document.getElementById('wWidth').value = '380';
            document.getElementById('wHeight').value = '560';
            document.getElementById('wTrigger').value = '60';
            document.querySelector('input[name="wLogo"][value="dark"]').checked = true;
            document.getElementById('logoDarkLabel').style.borderColor = '#231f20';
            document.getElementById('logoLightLabel').style.borderColor = '#ddd';
            updateWidgetPreview();
        }

        function editWidgetConfig(config) {
            editingWidgetId = config.id;
            document.getElementById('widgetFormTitle').textContent = 'Konfig√ºrasyon D√ºzenle';
            document.getElementById('widgetSaveLabel').textContent = 'G√ºncelle';
            document.getElementById('wName').value = config.name;
            document.getElementById('wDomain').value = config.domain;
            document.getElementById('wSourceGroup').value = config.source_group_id || '';
            document.getElementById('wColor').value = config.brand_color;
            document.getElementById('wColorText').value = config.brand_color;
            document.getElementById('wBrandName').value = config.brand_name;
            document.getElementById('wWelcome').value = config.welcome_message;
            document.getElementById('wPlaceholder').value = config.placeholder;
            document.getElementById('wPosition').value = config.position;
            document.getElementById('wWidth').value = config.width;
            document.getElementById('wHeight').value = config.height;
            document.getElementById('wTrigger').value = config.trigger_size;
            const logoRadio = document.querySelector(`input[name="wLogo"][value="${config.logo_variant}"]`);
            if (logoRadio) { logoRadio.checked = true; logoRadio.dispatchEvent(new Event('change')); }
            updateWidgetPreview();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function deleteWidgetConfig(id) {
            if (!confirm('Bu konfig√ºrasyonu silmek istediƒüinize emin misiniz?')) return;
            try {
                const resp = await fetch(`${API}/api/admin/widget-configs/${id}`, {
                    method: 'DELETE',
                    headers: authHeaders(),
                });
                if (!resp.ok) throw new Error('Silinemedi');
                showWidgetAlert('Konfig√ºrasyon silindi', 'success');
                loadWidgetConfigs();
            } catch (e) {
                showWidgetAlert('Hata: ' + e.message, 'error');
            }
        }

        async function loadWidgetConfigs() {
            const listEl = document.getElementById('widgetConfigList');
            if (!listEl) return;
            try {
                const resp = await fetch(`${API}/api/admin/widget-configs`, { headers: authHeaders() });
                if (!resp.ok) throw new Error('Y√ºklenemedi');
                const data = await resp.json();
                widgetConfigs = data.configs || [];

                if (widgetConfigs.length === 0) {
                    listEl.innerHTML = '<div style="text-align:center;padding:32px;color:#999">Hen√ºz kayƒ±tlƒ± konfig√ºrasyon yok</div>';
                    return;
                }

                listEl.innerHTML = `
                    <table style="width:100%;border-collapse:collapse;font-size:14px">
                        <thead>
                            <tr style="border-bottom:2px solid #e5e5e5;text-align:left">
                                <th style="padding:10px 12px">Ad</th>
                                <th style="padding:10px 12px">Domain</th>
                                <th style="padding:10px 12px">Kaynak Grubu</th>
                                <th style="padding:10px 12px">Logo</th>
                                <th style="padding:10px 12px">Renk</th>
                                <th style="padding:10px 12px">Boyut</th>
                                <th style="padding:10px 12px">Tarih</th>
                                <th style="padding:10px 12px;text-align:right">ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${widgetConfigs.map(c => `
                                <tr style="border-bottom:1px solid #f0f0f0">
                                    <td style="padding:10px 12px;font-weight:500">${c.name}</td>
                                    <td style="padding:10px 12px;color:#666">${c.domain}</td>
                                    <td style="padding:10px 12px">${(() => {
                                        const sg = sourceGroups.find(g => g.id === c.source_group_id);
                                        return sg ? '<span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:500;background:' + sg.color + '20;color:' + sg.color + ';border:1px solid ' + sg.color + '40"><span style="width:6px;height:6px;border-radius:50%;background:' + sg.color + '"></span>' + sg.name + '</span>' : '<span style="color:#999;font-size:12px">‚Äî</span>';
                                    })()}</td>
                                    <td style="padding:10px 12px">
                                        <img src="/images/logo-${c.logo_variant}-mobile.png" style="width:24px;height:24px;object-fit:contain${c.logo_variant === 'light' ? ';background:#333;border-radius:4px;padding:2px' : ''}" alt="${c.logo_variant}">
                                    </td>
                                    <td style="padding:10px 12px">
                                        <span style="display:inline-flex;align-items:center;gap:6px">
                                            <span style="width:18px;height:18px;border-radius:4px;background:${c.brand_color};display:inline-block;border:1px solid #ddd"></span>
                                            <code style="font-size:12px">${c.brand_color}</code>
                                        </span>
                                    </td>
                                    <td style="padding:10px 12px;font-size:12px;color:#666">${c.width}√ó${c.height}</td>
                                    <td style="padding:10px 12px;font-size:12px;color:#999">${new Date(c.created_at).toLocaleDateString('tr-TR')}</td>
                                    <td style="padding:10px 12px;text-align:right">
                                        <button onclick="showWidgetCodeModal('${c.id}')" style="padding:5px 10px;background:#f0f7ff;color:#1a73e8;border:1px solid #c8dff7;border-radius:6px;cursor:pointer;font-size:12px;margin-right:4px">Kodu G√∂ster</button>
                                        <button onclick='editWidgetConfig(${JSON.stringify(c).replace(/'/g, "&#39;")})' style="padding:5px 10px;background:#f5f5f5;color:#333;border:1px solid #ddd;border-radius:6px;cursor:pointer;font-size:12px;margin-right:4px">D√ºzenle</button>
                                        <button onclick="deleteWidgetConfig('${c.id}')" style="padding:5px 10px;background:#fff5f5;color:#e53e3e;border:1px solid #fed7d7;border-radius:6px;cursor:pointer;font-size:12px">Sil</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (e) {
                listEl.innerHTML = `<div style="color:#e53e3e;padding:12px">Y√ºklenemedi: ${e.message}</div>`;
            }
        }

        function showWidgetCodeModal(configId) {
            const config = widgetConfigs.find(c => c.id === configId);
            if (!config) return;

            const apiUrl = config.domain.startsWith('http') ? config.domain : 'https://' + config.domain;
            const scriptUrl = apiUrl + '/widget/idfine-chat.js';

            let attrs = [`data-api-url="${apiUrl}"`];
            if (config.source_group_id) attrs.push(`data-source-group="${config.source_group_id}"`);
            if (config.brand_color !== '#231f20') attrs.push(`data-brand-color="${config.brand_color}"`);
            if (config.brand_name !== 'ID Fine') attrs.push(`data-brand-name="${config.brand_name}"`);
            if (config.logo_variant !== 'dark') attrs.push(`data-logo-variant="${config.logo_variant}"`);
            if (config.position !== 'bottom-right') attrs.push(`data-position="${config.position}"`);
            if (config.width !== 380) attrs.push(`data-width="${config.width}"`);
            if (config.height !== 560) attrs.push(`data-height="${config.height}"`);
            if (config.trigger_size !== 60) attrs.push(`data-trigger-size="${config.trigger_size}"`);

            const attrsStr = attrs.length > 1
                ? '\n  ' + attrs.join('\n  ') + '\n'
                : ' ' + attrs.join(' ') + ' ';
            const code = `<script src="${scriptUrl}"${attrsStr}><\/script>`;

            // Create modal
            const overlay = document.createElement('div');
            overlay.id = 'widgetCodeModal';
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:10000;display:flex;align-items:center;justify-content:center';
            overlay.onclick = e => { if (e.target === overlay) overlay.remove(); };

            overlay.innerHTML = `
                <div style="background:#fff;border-radius:16px;padding:28px;max-width:600px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.2)">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
                        <h3 style="font-size:16px">${config.name} - Embed Kodu</h3>
                        <button onclick="document.getElementById('widgetCodeModal').remove()" style="background:none;border:none;cursor:pointer;font-size:20px;color:#999">&times;</button>
                    </div>
                    <p style="font-size:13px;color:#666;margin-bottom:12px">Bu kodu web sitenizin <code>&lt;/body&gt;</code> etiketinden hemen √∂nce yapƒ±≈ütƒ±rƒ±n:</p>
                    <textarea readonly rows="8" style="width:100%;padding:14px;border:1px solid #ddd;border-radius:8px;font-size:13px;font-family:'Courier New',monospace;background:#f8f9fa;resize:none">${code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                    <button onclick="navigator.clipboard.writeText(document.querySelector('#widgetCodeModal textarea').value.replace(/&lt;/g,'<').replace(/&gt;/g,'>'));this.textContent='Kopyalandƒ±!';setTimeout(()=>this.textContent='Kodu Kopyala',2000)"
                        style="margin-top:12px;width:100%;padding:10px;background:#231f20;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500">Kodu Kopyala</button>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function showWidgetAlert(msg, type) {
            const el = document.getElementById('widgetAlert');
            if (!el) return;
            el.innerHTML = `<div style="padding:12px 16px;border-radius:8px;margin-bottom:16px;font-size:14px;${type === 'error' ? 'background:#fff5f5;color:#e53e3e;border:1px solid #fed7d7' : 'background:#f0fff4;color:#38a169;border:1px solid #c6f6d5'}">${msg}</div>`;
            setTimeout(() => { el.innerHTML = ''; }, 4000);
        }

        // Enter key on login
        document.getElementById('loginPassword').addEventListener('keydown', e => { if (e.key === 'Enter') login(); });
    </script>
</body>

</html>
