var IdfineChat=function(n){"use strict";function t(n){if(!n)return"";const t=[];let e=n.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,(n,e,i)=>{const s=t.length;return t.push(`<img class="idf-img-thumb" src="${i}" alt="${e}" data-full="${i}" loading="lazy">`),`%%IMG${s}%%`}).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return e=e.replace(/^#### (.+)$/gm,"<h4>$1</h4>"),e=e.replace(/^### (.+)$/gm,"<h4>$1</h4>"),e=e.replace(/^## (.+)$/gm,"<h3>$1</h3>"),e=e.replace(/\*\*\*(.+?)\*\*\*/g,"<strong><em>$1</em></strong>"),e=e.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),e=e.replace(/\*(.+?)\*/g,"<em>$1</em>"),e=e.replace(/^[-*] (.+)$/gm,"<li>$1</li>"),e=e.replace(/((?:<li>.*<\/li>\n?)+)/g,"<ul>$1</ul>"),e=e.replace(/^\d+\.\s+(.+)$/gm,"<oli>$1</oli>"),e=e.replace(/((?:<oli>.*<\/oli>\n?)+)/g,n=>"<ol>"+n.replace(/<\/?oli>/g,n=>n.replace("oli","li"))+"</ol>"),e=e.replace(/\n{2,}/g,"</p><p>"),e=e.replace(/\n/g,"<br>"),e="<p>"+e+"</p>",e=e.replace(/<p>\s*(<(?:ul|ol|h[34]))/g,"$1"),e=e.replace(/(<\/(?:ul|ol|h[34])>)\s*<\/p>/g,"$1"),e=e.replace(/<p>\s*<\/p>/g,""),e=e.replace(/<\/li>\s*<br>\s*/g,"</li>"),e=e.replace(/<ul>\s*<br>/g,"<ul>"),e=e.replace(/<ol>\s*<br>/g,"<ol>"),e=e.replace(/<br>\s*<\/ul>/g,"</ul>"),e=e.replace(/<br>\s*<\/ol>/g,"</ol>"),e=e.replace(/<\/h[34]>\s*<br>/g,n=>n.replace(/<br>/,"")),e=e.replace(/<\/ul>\s*<br>/g,"</ul>"),e=e.replace(/<\/ol>\s*<br>/g,"</ol>"),t.forEach((n,t)=>{e=e.replace(`%%IMG${t}%%`,n)}),e}class e{constructor(n,t,e,i,s,a){this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectTimeout=null,this.pingInterval=null,this.url=n,this.sessionId=t,this.onMessage=e,this.onOpen=i,this.onClose=s,this.sourceGroupId=a}connect(){const n=this.url.replace(/^http/,"ws"),t=this.sourceGroupId?`?sg=${this.sourceGroupId}`:"";this.ws=new WebSocket(`${n}/ws/widget/${this.sessionId}${t}`),this.ws.onopen=()=>{this.reconnectAttempts=0,this.startPing(),this.onOpen()},this.ws.onmessage=n=>{try{const t=JSON.parse(n.data);this.onMessage(t)}catch{}},this.ws.onclose=()=>{this.stopPing(),this.onClose(),this.tryReconnect()},this.ws.onerror=()=>{}}send(n){this.ws?.readyState===WebSocket.OPEN&&this.ws.send(JSON.stringify(n))}disconnect(){this.maxReconnectAttempts=0,this.stopPing(),this.reconnectTimeout&&clearTimeout(this.reconnectTimeout),this.ws?.close(),this.ws=null}get isConnected(){return this.ws?.readyState===WebSocket.OPEN}tryReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts)return;const n=Math.min(1e3*Math.pow(2,this.reconnectAttempts),3e4);this.reconnectAttempts++,this.reconnectTimeout=setTimeout(()=>{this.connect()},n)}startPing(){this.pingInterval=setInterval(()=>{this.send({type:"ping"})},3e4)}stopPing(){this.pingInterval&&(clearInterval(this.pingInterval),this.pingInterval=null)}}class i{constructor(n,t){this.messages=[],this.ws=null,this.visitorId="",this.conversationId="",this.isOpen=!1,this.isFullscreen=!1,this.isStreaming=!1,this.currentStreamId="",this.currentStreamContent="",this.config={position:"bottom-right",brandColor:"#231f20",brandName:"ID Fine",welcomeMessage:"Merhaba! Size nasıl yardımcı olabilirim?",placeholder:"Mesajınızı yazın...",width:380,height:560,triggerSize:60,logoVariant:"dark",...t},this.config.logoUrl?this.logoUrl=this.config.logoUrl:this.logoUrl="light"===this.config.logoVariant?"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAG4AAABtCAMAAAB3EaRnAAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAPBQTFRFAAAA////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////5dXC4QAAAFB0Uk5TAAWl/7PK+wxafJCvZtP3tS9TNief0cODAWi2vnV36gbf7iLvNw2n0JF9WCEaPju8Qq3eG/MwYfyTxCmNFOU9uow1UKFMRPWKS9gLpoleIORbqhLzAAADVElEQVR4nO3Y6U8UMRQA8DYbz12NCqKIuogaAYMoiEaIRxSNIcZ/1hiveBsFT1Q0EQXPeOBtFPFYkNlj6PFe+9qZNSHp+zQ7075fOzs7+1rO/mvwwAUucIELXOACR0jAyyl4YarK3JxJ9Uzmd5W4eX+xK4X0ufl/TFfn/kyVW/jLOpwfBC7Hx1mW8y/mVEu/UYYEz1DgMvHRlPYIMKiZJaDvMOayE7amxVj2lapNP7gT2qkKp455yUcwQ+1nusaAUXNYQ+ZHvpFYlhIHPdeA56xpWTieR/M8NDVLkVv+icJ5aUoajieqGZM+rvjgx2XFn6mBk8e18r2fxtiC7zJXPwa3kzjPW6nkibhV7+xcAk1MFHENb63c6jdJuLq4d8SteW3lEk1OyER7VAxaw4vyQZ6/RBvlKm9aA7f2qZ3Lj0qfXmHtKiM3cDOTW/8MTrLuiXpm4yjUbjrDsMDZXmLwcDY8gs7q5ZKYrMQ1PzZpLcNgXv3frBit4CiaHwgcMP6WofgQnFzrfVjDvILIaSk334sPwRKvFnk1RLFJ+0o1jrUP6RdLARZ5pmISvB1tgxInNtpyR2zYcVfvvPWWiQO9gsJV7vqkUusDfbfdNGpEjty3/Jw59SFynYNIV0eueP/tXNdt7VQN8gdp7NQ4QuKAHzlShIqB3E07h30NgcM4/WrndbTj9oHygb5i6OovHywad+MSTMEQs5vbca16XPeAdgr7z02Dk/+zirHzKonr6dcv+bwYd10hcT7Tg6ouWx8DZ6oPooBWhQk4S1+ohu2+TOSgCsG9IIlfRTYO7N1zCe/Y9hA42QTUq3TOND3X9gq3F3yEsf7w4mP3BTKHLAT2nIfO7r8INra/GWwca9erDnT95cKhSfadlT/XYZUK4aVO4Jj4KuwFb64Ph689aUHQpFqlEV9cEyJH2emUSqOUNk+o3MFzVdaUwg9b89tjMW0bV6kzfW/ngdO0dmpZm8ampQOXxpasC5fChrMTl3w73Y1z9Rw0eAXk4vWecmiMLLgOn6H277jhoqHrO9oED51wwgzLyabn9s55ZDvRgwN3D6SwrQccOcb6+EnsUn2GMHtHLoojwNfTd8yHInFRHD0+o4/oq6y0ufQicIELXOACF7jAzXbuH9f1yG6vekjvAAAAAElFTkSuQmCC":"data:image/png;base64,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",this.shadow=n.attachShadow({mode:"closed"}),this.init()}async init(){this.render(),this.bindEvents(),await this.initSession()}render(){const n=document.createElement("style");n.textContent=function(n){const t=n.brandColor||"#231f20",e=n.width||380,i=n.height||560,s=n.triggerSize||60,a="bottom-right"===(n.position||"bottom-right");return`\n    :host {\n      all: initial;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      font-size: 14px;\n      line-height: 1.5;\n      color: #1a1a1a;\n    }\n\n    * { box-sizing: border-box; margin: 0; padding: 0; }\n\n    /* ── Trigger Button ── */\n    .idf-widget-trigger {\n      position: fixed;\n      bottom: 20px;\n      ${a?"right: 20px;":"left: 20px;"}\n      width: ${s}px;\n      height: ${s}px;\n      border-radius: 50%;\n      background: transparent;\n      border: none;\n      cursor: pointer;\n      padding: 0;\n      z-index: 999999;\n      transition: transform 0.2s;\n    }\n\n    .idf-widget-trigger:hover {\n      transform: scale(1.08);\n    }\n\n    .idf-widget-trigger img {\n      width: ${s}px;\n      height: ${s}px;\n      object-fit: contain;\n      border-radius: 50%;\n      filter: drop-shadow(0 4px 12px rgba(0,0,0,0.25));\n    }\n\n    .idf-widget-trigger.open img {\n      display: none;\n    }\n\n    .idf-widget-trigger .idf-trigger-close {\n      display: none;\n      width: ${s}px;\n      height: ${s}px;\n      border-radius: 50%;\n      background: ${t};\n      align-items: center;\n      justify-content: center;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.25);\n    }\n\n    .idf-widget-trigger.open .idf-trigger-close {\n      display: flex;\n    }\n\n    .idf-widget-trigger .idf-trigger-close svg {\n      width: 24px;\n      height: 24px;\n      stroke: white;\n      fill: none;\n      stroke-width: 2;\n    }\n\n    /* ── Chat Container ── */\n    .idf-widget-container {\n      position: fixed;\n      bottom: ${s+30}px;\n      ${a?"right: 20px;":"left: 20px;"}\n      width: ${e}px;\n      height: ${i}px;\n      max-height: calc(100vh - ${s+50}px);\n      background: #fff;\n      border-radius: 16px;\n      box-shadow: 0 8px 40px rgba(0,0,0,0.15);\n      display: flex;\n      flex-direction: column;\n      overflow: hidden;\n      z-index: 999999;\n      opacity: 0;\n      transform: translateY(20px) scale(0.95);\n      transition: opacity 0.3s, transform 0.3s;\n      pointer-events: none;\n    }\n\n    .idf-widget-container.open {\n      opacity: 1;\n      transform: translateY(0) scale(1);\n      pointer-events: auto;\n    }\n\n    /* ── Header ── */\n    .idf-widget-header {\n      background: ${t};\n      color: white;\n      padding: 14px 16px;\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      flex-shrink: 0;\n    }\n\n    .idf-header-info {\n      display: flex;\n      align-items: center;\n      gap: 10px;\n    }\n\n    .idf-header-logo {\n      width: 32px;\n      height: 32px;\n      object-fit: contain;\n      filter: brightness(0) invert(1);\n    }\n\n    .idf-header-text h3 {\n      font-size: 15px;\n      font-weight: 600;\n      line-height: 1.2;\n    }\n\n    .idf-status {\n      font-size: 11px;\n      opacity: 0.8;\n    }\n\n    .idf-header-actions {\n      display: flex;\n      align-items: center;\n      gap: 4px;\n    }\n\n    .idf-widget-fullscreen,\n    .idf-widget-close {\n      background: none;\n      border: none;\n      color: white;\n      cursor: pointer;\n      padding: 4px;\n      border-radius: 4px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    .idf-widget-fullscreen:hover,\n    .idf-widget-close:hover { background: rgba(255,255,255,0.15); }\n\n    /* ── Messages Area ── */\n    .idf-messages {\n      flex: 1;\n      overflow-y: auto;\n      padding: 14px;\n      display: flex;\n      flex-direction: column;\n      gap: 10px;\n    }\n\n    /* ── Message Row (avatar + bubble) ── */\n    .idf-msg-row {\n      display: flex;\n      align-items: flex-start;\n      gap: 0;\n    }\n\n    .idf-msg-row.user-row {\n      justify-content: flex-end;\n    }\n\n    .idf-msg-avatar {\n      width: 32px;\n      flex-shrink: 0;\n      padding-right: 8px;\n      margin-top: 2px;\n    }\n\n    .idf-msg-avatar img {\n      width: 24px;\n      height: 24px;\n      object-fit: contain;\n    }\n\n    /* ── Message Bubble ── */\n    .idf-message {\n      max-width: 82%;\n      padding: 10px 14px;\n      border-radius: 12px;\n      word-wrap: break-word;\n      font-size: 14px;\n      line-height: 1.5;\n    }\n\n    .idf-message.user {\n      align-self: flex-end;\n      background: ${t};\n      color: white;\n      border-bottom-right-radius: 4px;\n      white-space: pre-wrap;\n    }\n\n    .idf-message.assistant {\n      align-self: flex-start;\n      background: #f0f2f5;\n      color: #1a202c;\n      border-bottom-left-radius: 4px;\n    }\n\n    .idf-msg-row.system-row {\n      justify-content: center;\n    }\n\n    .idf-message.system {\n      background: #e2e8f0;\n      color: #4a5568;\n      font-size: 12px;\n      font-style: italic;\n      text-align: center;\n      max-width: 90%;\n      padding: 6px 14px;\n      border-radius: 8px;\n    }\n\n    /* ── Streaming Cursor ── */\n    .idf-message.assistant.streaming {\n      white-space: pre-wrap;\n    }\n\n    .idf-message.assistant.streaming::after {\n      content: '';\n      display: inline-block;\n      width: 2px;\n      height: 1em;\n      background: ${t};\n      margin-left: 2px;\n      vertical-align: text-bottom;\n      animation: idf-cursor-blink 0.7s steps(1) infinite;\n    }\n\n    @keyframes idf-cursor-blink {\n      0%, 50% { opacity: 1; }\n      51%, 100% { opacity: 0; }\n    }\n\n    /* ── Markdown Typography ── */\n    .idf-message.assistant h3,\n    .idf-message.assistant h4 {\n      font-size: 14px;\n      font-weight: 600;\n      margin: 8px 0 4px;\n    }\n\n    .idf-message.assistant h3:first-child,\n    .idf-message.assistant h4:first-child {\n      margin-top: 0;\n    }\n\n    .idf-message.assistant strong { font-weight: 600; }\n    .idf-message.assistant em { font-style: italic; }\n\n    .idf-message.assistant ul,\n    .idf-message.assistant ol {\n      margin: 4px 0 4px 18px;\n      padding: 0;\n    }\n\n    .idf-message.assistant li { margin-bottom: 2px; }\n\n    .idf-message.assistant p { margin: 4px 0; }\n    .idf-message.assistant p:first-child { margin-top: 0; }\n    .idf-message.assistant p:last-child { margin-bottom: 0; }\n\n    /* ── Product Images ── */\n    .idf-img-thumb {\n      max-width: 160px;\n      max-height: 160px;\n      border-radius: 8px;\n      margin: 6px 0;\n      cursor: pointer;\n      transition: transform 0.2s, box-shadow 0.2s;\n      object-fit: cover;\n      display: block;\n    }\n\n    .idf-img-thumb:hover {\n      transform: scale(1.03);\n      box-shadow: 0 2px 12px rgba(0,0,0,0.15);\n    }\n\n    /* ── Lightbox ── */\n    .idf-lightbox {\n      position: fixed;\n      top: 0; left: 0; right: 0; bottom: 0;\n      background: rgba(0,0,0,0.85);\n      z-index: 9999999;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      animation: idf-lb-in 0.2s ease;\n    }\n\n    .idf-lightbox img {\n      max-width: 90vw;\n      max-height: 90vh;\n      border-radius: 8px;\n      object-fit: contain;\n      box-shadow: 0 8px 40px rgba(0,0,0,0.4);\n    }\n\n    .idf-lightbox-close {\n      position: absolute;\n      top: 16px;\n      right: 16px;\n      width: 36px;\n      height: 36px;\n      background: rgba(255,255,255,0.15);\n      border: none;\n      border-radius: 50%;\n      color: white;\n      font-size: 20px;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    .idf-lightbox-close:hover { background: rgba(255,255,255,0.3); }\n\n    @keyframes idf-lb-in {\n      from { opacity: 0; }\n      to { opacity: 1; }\n    }\n\n    /* ── Typing Indicator ── */\n    .idf-typing {\n      padding: 10px 14px;\n      background: #f0f2f5;\n      border-radius: 12px;\n      border-bottom-left-radius: 4px;\n      display: flex;\n      gap: 4px;\n      align-items: center;\n    }\n\n    .idf-typing span {\n      width: 6px;\n      height: 6px;\n      background: #a0aec0;\n      border-radius: 50%;\n      animation: idf-bounce 1.4s ease-in-out infinite;\n    }\n\n    .idf-typing span:nth-child(2) { animation-delay: 0.2s; }\n    .idf-typing span:nth-child(3) { animation-delay: 0.4s; }\n\n    @keyframes idf-bounce {\n      0%, 60%, 100% { transform: translateY(0); }\n      30% { transform: translateY(-6px); }\n    }\n\n    /* ── Quick Actions ── */\n    .idf-quick-actions {\n      padding: 8px 14px;\n      display: flex;\n      gap: 8px;\n      flex-wrap: wrap;\n      flex-shrink: 0;\n    }\n\n    .idf-quick-action {\n      display: inline-flex;\n      align-items: center;\n      gap: 6px;\n      padding: 6px 14px;\n      border: 1px solid #e2e8f0;\n      border-radius: 20px;\n      background: #fff;\n      color: #4a5568;\n      font-size: 13px;\n      cursor: pointer;\n      transition: all 0.2s;\n      font-family: inherit;\n    }\n\n    .idf-quick-action:hover {\n      background: ${t};\n      color: white;\n      border-color: ${t};\n    }\n\n    .idf-quick-action svg {\n      flex-shrink: 0;\n    }\n\n    .idf-quick-action:hover svg {\n      stroke: white;\n    }\n\n    /* ── Inline Action Buttons ── */\n    .idf-msg-actions {\n      display: flex;\n      gap: 8px;\n      flex-wrap: wrap;\n      margin-top: 10px;\n      padding-top: 10px;\n      border-top: 1px solid rgba(0,0,0,0.06);\n    }\n\n    .idf-action-btn {\n      display: inline-flex;\n      align-items: center;\n      gap: 6px;\n      padding: 7px 16px;\n      border: 1.5px solid ${t};\n      border-radius: 20px;\n      background: #fff;\n      color: ${t};\n      font-size: 13px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: all 0.2s;\n      font-family: inherit;\n    }\n\n    .idf-action-btn:hover {\n      background: ${t};\n      color: white;\n    }\n\n    /* ── Input Area ── */\n    .idf-input-area {\n      padding: 10px 14px;\n      border-top: 1px solid #e5e5e5;\n      display: flex;\n      gap: 8px;\n      align-items: flex-end;\n      flex-shrink: 0;\n    }\n\n    .idf-input-area textarea {\n      flex: 1;\n      border: 1px solid #ddd;\n      border-radius: 8px;\n      padding: 8px 12px;\n      font-size: 14px;\n      font-family: inherit;\n      resize: none;\n      max-height: 100px;\n      outline: none;\n      transition: border-color 0.2s;\n      line-height: 1.4;\n    }\n\n    .idf-input-area textarea:focus {\n      border-color: ${t};\n    }\n\n    .idf-input-area button {\n      background: ${t};\n      color: white;\n      border: none;\n      border-radius: 8px;\n      padding: 8px 14px;\n      cursor: pointer;\n      font-size: 14px;\n      transition: opacity 0.2s;\n      white-space: nowrap;\n      flex-shrink: 0;\n    }\n\n    .idf-input-area button:hover { opacity: 0.9; }\n    .idf-input-area button:disabled { opacity: 0.5; cursor: not-allowed; }\n\n    /* ── Footer ── */\n    .idf-powered {\n      text-align: center;\n      padding: 6px;\n      font-size: 10px;\n      color: #999;\n      background: #fafafa;\n      flex-shrink: 0;\n    }\n\n    /* ── Fullscreen Mode ── */\n    .idf-widget-container.fullscreen {\n      bottom: 0 !important;\n      right: 0 !important;\n      left: 0 !important;\n      top: 0 !important;\n      width: 100% !important;\n      height: 100% !important;\n      max-height: 100vh !important;\n      border-radius: 0 !important;\n      transition: all 0.3s ease;\n    }\n\n    .idf-widget-fullscreen .idf-fs-expand { display: block; }\n    .idf-widget-fullscreen .idf-fs-shrink { display: none; }\n\n    .idf-widget-container.fullscreen ~ .idf-widget-trigger .idf-widget-fullscreen .idf-fs-expand,\n    .fullscreen .idf-widget-fullscreen .idf-fs-expand { display: none; }\n\n    .idf-widget-container.fullscreen ~ .idf-widget-trigger .idf-widget-fullscreen .idf-fs-shrink,\n    .fullscreen .idf-widget-fullscreen .idf-fs-shrink { display: block; }\n\n    /* ── Mobile Responsive ── */\n    @media (max-width: 480px) {\n      .idf-widget-container {\n        bottom: 0;\n        right: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        max-height: 100vh;\n        border-radius: 0;\n      }\n\n      .idf-widget-fullscreen { display: none !important; }\n\n      .idf-widget-trigger {\n        bottom: 16px;\n        ${a?"right: 16px;":"left: 16px;"}\n      }\n    }\n  `}(this.config),this.shadow.appendChild(n),this.triggerBtn=document.createElement("button"),this.triggerBtn.className="idf-widget-trigger",this.triggerBtn.setAttribute("aria-label","Sohbet aç/kapat");const t=document.createElement("img");t.src=this.logoUrl,t.alt=this.config.brandName||"ID Fine",t.draggable=!1,this.triggerBtn.appendChild(t);const e=document.createElement("div");e.className="idf-trigger-close",e.innerHTML='<svg viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>',this.triggerBtn.appendChild(e),this.shadow.appendChild(this.triggerBtn),this.container=document.createElement("div"),this.container.className="idf-widget-container",this.container.innerHTML=`\n      <div class="idf-widget-header">\n        <div class="idf-header-info">\n          <img class="idf-header-logo" src="${this.logoUrl}" alt="${this.config.brandName}">\n          <div class="idf-header-text">\n            <h3>${this.config.brandName} Asistan</h3>\n            <div class="idf-status">Çevrimiçi</div>\n          </div>\n        </div>\n        <div class="idf-header-actions">\n          <button class="idf-widget-fullscreen" aria-label="Tam ekran">\n            <svg class="idf-fs-expand" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/></svg>\n            <svg class="idf-fs-shrink" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M4 14h6v6m10-10h-6V4m0 6l7-7M3 21l7-7"/></svg>\n          </button>\n          <button class="idf-widget-close" aria-label="Kapat">\n            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>\n          </button>\n        </div>\n      </div>\n      <div class="idf-messages"></div>\n      <div class="idf-quick-actions">\n        <button class="idf-quick-action" data-message="Bayi bulmak istiyorum">\n          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>\n          Bayi Bul\n        </button>\n      </div>\n      <div class="idf-input-area">\n        <textarea rows="1" placeholder="${this.config.placeholder}"></textarea>\n        <button>Gönder</button>\n      </div>\n      <div class="idf-powered">Powered by ID Fine AI</div>\n    `,this.shadow.appendChild(this.container),this.messagesEl=this.container.querySelector(".idf-messages"),this.textarea=this.container.querySelector("textarea"),this.sendBtn=this.container.querySelector(".idf-input-area button")}bindEvents(){this.triggerBtn.addEventListener("click",()=>this.toggle()),this.container.querySelector(".idf-widget-fullscreen").addEventListener("click",()=>this.toggleFullscreen()),this.container.querySelector(".idf-widget-close").addEventListener("click",()=>this.toggle()),this.sendBtn.addEventListener("click",()=>this.sendMessage()),this.textarea.addEventListener("keydown",n=>{"Enter"!==n.key||n.shiftKey||(n.preventDefault(),this.sendMessage())}),this.textarea.addEventListener("input",()=>{this.textarea.style.height="auto",this.textarea.style.height=Math.min(this.textarea.scrollHeight,100)+"px"}),this.container.querySelectorAll(".idf-quick-action").forEach(n=>{n.addEventListener("click",()=>{const t=n.dataset.message;t&&(this.textarea.value=t,this.sendMessage())})}),this.container.addEventListener("click",n=>{const t=n.target.closest(".idf-img-thumb");t&&this.openLightbox(t.getAttribute("data-full")||t.src)})}openLightbox(n){const t=document.createElement("div");t.className="idf-lightbox",t.innerHTML=`\n      <button class="idf-lightbox-close" aria-label="Kapat">&times;</button>\n      <img src="${n}" alt="Ürün">\n    `,t.addEventListener("click",n=>{(n.target===t||n.target.closest(".idf-lightbox-close"))&&t.remove()}),this.shadow.appendChild(t)}async initSession(){try{const n={domain:location.hostname,page_url:location.href};this.config.sourceGroupId&&(n.source_group_id=this.config.sourceGroupId);const t=await fetch(`${this.config.apiUrl}/api/widget/init`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}),e=await t.json();this.visitorId=e.visitor_id,e.config?.welcome_message&&(this.config.welcomeMessage=e.config.welcome_message),this.addMessage({id:"welcome",role:"assistant",content:this.config.welcomeMessage,timestamp:new Date}),this.connectWS()}catch(n){console.error("[idfine] Session init failed:",n)}}connectWS(){this.ws=new e(this.config.apiUrl,this.visitorId,n=>this.handleWSMessage(n),()=>{const n=this.container.querySelector(".idf-status");n&&(n.textContent="Çevrimiçi")},()=>{const n=this.container.querySelector(".idf-status");n&&(n.textContent="Bağlanıyor...")},this.config.sourceGroupId),this.ws.connect()}handleWSMessage(n){switch(n.type){case"stream_start":this.isStreaming=!0,this.currentStreamId=n.message_id,this.currentStreamContent="",this.removeTypingIndicator(),this.addMessage({id:n.message_id,role:"assistant",content:"",timestamp:new Date,isStreaming:!0});break;case"stream_chunk":this.currentStreamContent+=n.content,this.updateStreamingMessage(n.message_id,this.currentStreamContent);break;case"stream_end":this.isStreaming=!1,n.conversation_id&&(this.conversationId=n.conversation_id),this.finalizeMessage(n.message_id,n.sources,n.intent,n.actions),this.sendBtn.disabled=!1,this.textarea.disabled=!1,this.textarea.focus();break;case"human_ack":this.removeTypingIndicator(),this.isStreaming=!1,this.sendBtn.disabled=!1,this.textarea.disabled=!1;break;case"error":this.removeTypingIndicator(),this.isStreaming=!1,this.addMessage({id:Date.now().toString(),role:"assistant",content:n.message,timestamp:new Date}),this.sendBtn.disabled=!1,this.textarea.disabled=!1;break;case"system":this.removeTypingIndicator(),this.addMessage({id:Date.now().toString(),role:"system",content:n.content,timestamp:new Date})}}sendMessage(){const n=this.textarea.value.trim();if(!n||this.isStreaming)return;const t=this.container.querySelector(".idf-quick-actions");t&&(t.style.display="none"),this.addMessage({id:Date.now().toString(),role:"user",content:n,timestamp:new Date}),this.showTypingIndicator(),this.sendBtn.disabled=!0,this.textarea.disabled=!0,this.ws?.isConnected?this.ws.send({type:"message",content:n,conversation_id:this.conversationId||void 0}):this.sendViaRest(n),this.textarea.value="",this.textarea.style.height="auto"}async sendViaRest(n){try{const e=await fetch(`${this.config.apiUrl}/api/widget/message`,{method:"POST",headers:{"Content-Type":"application/json","X-Visitor-ID":this.visitorId},body:JSON.stringify({content:n,conversation_id:this.conversationId||void 0})}),i=await e.json();this.removeTypingIndicator(),this.conversationId=i.conversation_id;const s=i.message_id||Date.now().toString();this.addMessage({id:s,role:"assistant",content:"",timestamp:new Date,isStreaming:!0});const a=this.shadow.getElementById(`msg-${s}`),r=i.content;a&&await new Promise(n=>{let e=0;const i=setInterval(()=>{const s=Math.floor(6*Math.random())+3;e+=s,e>=r.length?(a.classList.remove("streaming"),a.innerHTML=t(r),clearInterval(i),n()):(a.textContent=r.substring(0,e),this.scrollToBottom())},20)});const o=this.messages.find(n=>n.id===s);o&&(o.content=r,o.sources=i.sources,o.intent=i.intent,o.isStreaming=!1)}catch{this.removeTypingIndicator(),this.addMessage({id:Date.now().toString(),role:"assistant",content:"Bağlantı hatası oluştu. Lütfen tekrar deneyin.",timestamp:new Date})}finally{this.sendBtn.disabled=!1,this.textarea.disabled=!1,this.textarea.focus()}}addMessage(n){if(this.messages.push(n),"assistant"===n.role){const e=document.createElement("div");e.className="idf-msg-row";const i=document.createElement("div");i.className="idf-msg-avatar";const s=document.createElement("img");s.src=this.logoUrl,s.alt="AI",i.appendChild(s),e.appendChild(i);const a=document.createElement("div");a.className="idf-message assistant",a.id=`msg-${n.id}`,n.isStreaming?(a.classList.add("streaming"),a.textContent=n.content):a.innerHTML=t(n.content),e.appendChild(a),this.messagesEl.appendChild(e)}else if("user"===n.role){const t=document.createElement("div");t.className="idf-msg-row user-row";const e=document.createElement("div");e.className="idf-message user",e.id=`msg-${n.id}`,e.textContent=n.content,t.appendChild(e),this.messagesEl.appendChild(t)}else if("system"===n.role){const t=document.createElement("div");t.className="idf-msg-row system-row";const e=document.createElement("div");e.className="idf-message system",e.id=`msg-${n.id}`,e.textContent=n.content,t.appendChild(e),this.messagesEl.appendChild(t)}this.scrollToBottom()}updateStreamingMessage(n,t){const e=this.shadow.getElementById(`msg-${n}`);e&&(e.textContent=t,this.scrollToBottom())}finalizeMessage(n,e,i,s){const a=this.messages.find(t=>t.id===n);a&&(a.content=this.currentStreamContent,a.sources=e,a.intent=i,a.actions=s,a.isStreaming=!1);const r=this.shadow.getElementById(`msg-${n}`);if(r&&(r.classList.remove("streaming"),r.innerHTML=t(this.currentStreamContent),s&&s.length>0)){const n=document.createElement("div");n.className="idf-msg-actions",s.forEach(t=>{const e=document.createElement("button");e.className="idf-action-btn",e.textContent=t.label,e.addEventListener("click",()=>{n.remove(),this.textarea.value=t.message,this.sendMessage()}),n.appendChild(e)}),r.appendChild(n)}}showTypingIndicator(){if(this.shadow.getElementById("idf-typing"))return;const n=document.createElement("div");n.className="idf-msg-row",n.id="idf-typing";const t=document.createElement("div");t.className="idf-msg-avatar";const e=document.createElement("img");e.src=this.logoUrl,e.alt="AI",t.appendChild(e),n.appendChild(t);const i=document.createElement("div");i.className="idf-typing",i.innerHTML="<span></span><span></span><span></span>",n.appendChild(i),this.messagesEl.appendChild(n),this.scrollToBottom()}removeTypingIndicator(){const n=this.shadow.getElementById("idf-typing");n&&n.remove()}scrollToBottom(){requestAnimationFrame(()=>{this.messagesEl.scrollTop=this.messagesEl.scrollHeight})}toggleFullscreen(){this.isFullscreen=!this.isFullscreen,this.container.classList.toggle("fullscreen",this.isFullscreen);const n=this.container.querySelector(".idf-fs-expand"),t=this.container.querySelector(".idf-fs-shrink");n&&t&&(n.style.display=this.isFullscreen?"none":"block",t.style.display=this.isFullscreen?"block":"none"),this.scrollToBottom()}toggle(){this.isOpen=!this.isOpen,this.container.classList.toggle("open",this.isOpen),this.triggerBtn.classList.toggle("open",this.isOpen),!this.isOpen&&this.isFullscreen&&this.toggleFullscreen(),this.isOpen&&(this.textarea.focus(),this.scrollToBottom())}destroy(){this.ws?.disconnect()}}function s(n){if(!n.apiUrl)throw new Error("[idfine] apiUrl is required");const t=document.createElement("div");t.id="idfine-chat-widget",document.body.appendChild(t);const e=new i(t,n);return window.IdfineChat._instance=e,e}const a=document.currentScript||document.querySelector("script[data-api-url]");function r(){const n=a||document.querySelector("script[data-api-url]");if(!n)return;const t=n.getAttribute("data-api-url");t&&s({apiUrl:t,sourceGroupId:n.getAttribute("data-source-group")||void 0,brandColor:n.getAttribute("data-brand-color")||"#231f20",brandName:n.getAttribute("data-brand-name")||"ID Fine",position:n.getAttribute("data-position")||"bottom-right",logoUrl:n.getAttribute("data-logo-url")||void 0,logoVariant:n.getAttribute("data-logo-variant")||void 0,width:Number(n.getAttribute("data-width"))||void 0,height:Number(n.getAttribute("data-height"))||void 0,triggerSize:Number(n.getAttribute("data-trigger-size"))||void 0})}return window.IdfineChat={init:s},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",r):r(),n.ChatWidget=i,n.init=s,n}({});
